// Advanced Institutional
{ name: 'Mr. Mohammed Alotaibi', title: 'Assistant Director', email: 'otaibim7@MNGHA.MED.SA', specialty: 'Institutional Practice', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Mr. Sultan Meashi', title: 'Supervisor', email: 'meashisu@MNGHA.MED.SA', specialty: 'Institutional Practice', availability: [false, false, false, true, true, true, true, true, false, false] },
{ name: 'Dr. Hamoud Al Samhan', title: 'Supervisor', email: 'samhanh@ngha.med.sa', specialty: 'Institutional Practice', availability: [true, true, true, false, false, false, true, true, true, false] },

// Advanced Outpatient
{ name: 'Mr. Thamer Alotaibi', title: 'Manager', email: 'otaibitk@MNGHA.MED.SA', specialty: 'Outpatient Practice', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Mr. Mohammed Alkathiri', title: 'Assistant Director', email: 'kathirim@ksau-hs.edu.sa', specialty: 'Outpatient Practice', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'Col/ Rph. Mohammed Alrufaiq', title: 'Pharmacy Supervisor', email: 'alrufaiqmo@MNGHA.MED.SA', specialty: 'Outpatient Practice', availability: [true, true, false, false, true, true, false, false, true, true] },
{ name: 'Mr. Abdullah Alroumi', title: 'Supervisor', email: 'alroumia@MNGHA.MED.SA', specialty: 'Outpatient Practice', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Mr. Saad Al Dhafian', title: 'Supervisor', email: 'aldafiansa@MNGHA.MED.SA', specialty: 'Outpatient Practice', availability: [false, true, false, true, false, true, false, true, false, true] },
{ name: 'Dr. Emad Basalasel', title: 'Pharmacy Supervisor', email: 'BasalaselE@MNGHA.MED.SA', specialty: 'Outpatient Practice', availability: [true, true, true, false, false, false, true, true, true, false] },
{ name: 'Dr. Laila Al Zahrani', title: 'Pharmacist', email: 'Zahranil@MNGHA.MED.SA', specialty: 'Outpatient Practice', availability: [true, true, true, true, true, true, true, true, true, true] },

// Solid Organ Transplant
{ name: 'Dr. Khalifah Al Thiab', title: 'SOT Clinical Pharmacist', email: 'ThiabKh@MNGHA.MED.SA', specialty: 'Transplant', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'Dr. Sara Albilal', title: 'SOT Clinical Pharmacist', email: 'albilalsa@MNGHA.MED.SA', specialty: 'Transplant', availability: [false, true, false, true, false, true, false, true, false, true] },

// Drug Information
{ name: 'Dr. Laila Abu Esba', title: 'Lecturer', email: 'abuesbala@MNGHA.MED.SA', specialty: 'Drug Information', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Hind Almodaimegh', title: 'Clinical Pharmacy Specialist', email: 'modaimeghh@ksau-hs.edu.sa', specialty: 'Drug Information', availability: [true, false, true, false, true, false, true, false, true, false] },

// Nephrology
{ name: 'Prof. Abdulmalik Alkatheri', title: 'Professor', email: 'katheria@MNGHA.MED.SA', specialty: 'Nephrology', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Numan Alabdan', title: 'Assistant Director', email: 'abdann@MNGHA.MED.SA', specialty: 'Nephrology', availability: [false, false, true, true, true, true, false, false, true, true] },
{ name: 'Dr. Yousef Alrajhi', title: 'Assistant Professor', email: 'rajhiy@MNGHA.MED.SA', specialty: 'Nephrology', availability: [true, true, false, false, true, true, false, false, true, true] },

// Administration
{ name: 'Dr. Yousef Al Aqeel', title: 'Clinical Pharmacy Specialist', email: 'alaqeely@ksau-hs.edu.sa', specialty: 'Administration', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Mr. Badr Alnasser', title: 'Manager', email: 'NasserB@MNGHA.MED.SA', specialty: 'Administration', availability: [true, false, true, false, true, false, true, false, true, false] },

// Oncology/Hematology
{ name: 'Dr. Nada Alsuhebany', title: 'Assistant Professor', email: 'suhebanyn@ksau-hs.edu.sa', specialty: 'Oncology', availability: [false, false, false, false, false, false, false, false, false, false] },
{ name: 'Dr. Ghada Alyousif', title: 'Associate Clinical Pharmacist', email: 'alyousifgh@MNGHA.MED.SA', specialty: 'Oncology', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Dema Almolaiki', title: 'Associate Clinical Pharmacist', email: 'almolaikide@MNGHA.MED.SA', specialty: 'Oncology', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'Dr. Maha AlDoughaim', title: 'Assistant Professor', email: 'doughaimm@ksau-hs.edu.sa', specialty: 'Oncology', availability: [true, true, false, false, true, true, false, false, true, true] },
{ name: 'Dr. Mohammed Al Zahrani', title: 'Assistant Professor', email: 'alzahranimoham@ksau-hs.edu.sa', specialty: 'Oncology', availability: [false, true, false, true, false, true, false, true, false, true] },

// Pediatrics
{ name: 'Dr. Diana Almutairi', title: 'Clinical Pharmacist', email: 'almutairidi@MNGHA.MED.SA', specialty: 'Pediatrics', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Meshary Almeshary', title: 'Clinical Pharmacist', email: 'almesharyme@MNGHA.MED.SA', specialty: 'Pediatrics', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'Dr. Reham Alhoraibi', title: 'Clinical Pharmacist', email: 'alhoraibire@MNGHA.MED.SA', specialty: 'Pediatrics', availability: [true, true, false, false, true, true, false, false, true, true] },
{ name: 'Dr. Kholoud Alaamer', title: 'Clinical Pharmacist', email: 'alaamerkh@MNGHA.MED.SA', specialty: 'Pediatrics', availability: [false, false, true, true, true, true, false, false, true, true] },
{ name: 'Dr. Hessa Almuqati', title: 'Clinical Pharmacist', email: 'almuqatihe@MNGHA.MED.SA', specialty: 'Pediatrics', availability: [true, true, true, false, false, false, true, true, true, false] },
{ name: 'Dr. Shaima Alshareef', title: 'Clinical Pharmacist', email: 'alshareefsh@MNGHA.MED.SA', specialty: 'Pediatrics', availability: [true, false, true, false, true, false, true, false, true, false] },

// Cardiology
{ name: 'Dr. Lama Alfehaid', title: 'Assistant Professor', email: 'fehaidl@ksau-hs.edu.sa', specialty: 'Cardiology', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Hisham Badreldin', title: 'Associate Professor', email: 'aldeenh@ksau-hs.edu.sa', specialty: 'Cardiology', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'Dr. Sarah Alyousif', title: 'Assistant Professor', email: 'yousifs@MNGHA.MED.SA', specialty: 'Cardiology', availability: [true, true, false, false, true, true, false, false, true, true] },
{ name: 'Dr. Majed Almutairi', title: 'Clinical Pharmacist', email: 'Almutairima27@MNGHA.MED.SA', specialty: 'Cardiology', availability: [false, false, true, true, true, true, false, false, true, true] },
{ name: 'Dr. Sultan Al Raddadi', title: 'Clinical Pharmacist', email: 'raddadis@ngha.med.sa', specialty: 'Cardiology', availability: [true, true, true, false, false, false, true, true, true, false] },
{ name: 'Dr. Alaa Al Anazi', title: 'Clinical Pharmacist', email: 'Alenazi-alenazial3@MNGHA.MED.SA', specialty: 'Cardiology', availability: [true, false, true, false, true, false, true, false, true, false] },

// Infectious Diseases
{ name: 'Dr. Khalid bin Saleh', title: 'Assistant Professor', email: 'salehk@ksau-hs.edu.sa', specialty: 'Infectious Diseases', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Hajar Alqahtani', title: 'Clinical Pharmacist', email: 'Alqahtaniha2@MNGHA.MED.SA', specialty: 'Infectious Diseases', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'D. Shuroug Alowais', title: 'Assistant Professor', email: 'owaiss@ksau-hs.edu.sa', specialty: 'Infectious Diseases', availability: [true, true, false, false, true, true, false, false, true, true] },

// Neonatal
{ name: 'Dr. Faisal Alsehli', title: 'Assistant Professor', email: 'sehlief@MNGHA.MED.SA', specialty: 'Neonatal', availability: [true, true, true, true, true, true, true, true, true, true] },

// Pharmacoeconomic
{ name: 'Dr. Hana Alabdulkarim', title: 'Director', email: 'alabdulkarimha@MNGHA.MED.SA', specialty: 'Pharmacoeconomic', availability: [false, false, false, false, false, false, false, false, false, false] },

// Quality Assurance
{ name: 'Dr. Saleh Alanizi', title: 'Assistant Professor', email: 'anazis@MNGHA.MED.SA', specialty: 'Quality Assurance', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Haya Almufrij', title: 'Q.I Pharmacist', email: 'MufrijH@MNGHA.MED.SA', specialty: 'Quality Assurance', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'Ms. Fawzyah Almutairi', title: 'Q.I Pharmacist', email: 'MutairiF@MNGHA.MED.SA', specialty: 'Quality Assurance', availability: [true, true, false, false, true, true, false, false, true, true] },

// Medication Safety
{ name: 'Dr. Hani Alhamdan', title: 'Chairman', email: 'hamdanhs@MNGHA.MED.SA', specialty: 'Medication Safety', availability: [true, true, true, true, true, true, true, true, true, true] },
{ name: 'Dr. Ghada Almardawi', title: 'Specialist', email: 'MardawiG@MNGHA.MED.SA', specialty: 'Medication Safety', availability: [true, false, true, false, true, false, true, false, true, false] },
{ name: 'Ms. Arwa Balharth', title: 'Specialist', email: 'balhartha@MNGHA.MED.SA', specialty: 'Medication Safety', availability: [true, true, false, false, true, true, false, false, true, true] },
{ name: 'Ms. Norah bin Sabbar', title: 'Specialist', email: 'binsabbarno@MNGHA.MED.SA', specialty: 'Medication Safety', availability: [false, false, true, true, true, true, false, false, true, true] },

// Emergency Medicine
{ name: 'Dr. Mohammed Alrashed', title: 'Assistant Professor', email: 'alrashidm@ksau-hs.edu.sa', specialty: 'Emergency Medicine', availability: [true, true, true, true, true, true, true, true, true, true] },

// Academia
{ name: 'Prof. Abdulkareem Albekairy', title: 'Dean', email: 'bekairya@MNGHA.MED.SA', specialty: 'Academia', availability: [false, false, false, false, false, false, false, false, false, false] }
    ],
outcomes: {
    glo: [
        { id: '1.0', desc: 'Knowledge and Understanding' },
        { id: '2.0', desc: 'Skills' },
        { id: '3.0', desc: 'Values' }
    ],
        plo: [
            { id: '1.3', desc: 'Describe pathophysiology...' },
            { id: '2.3', desc: 'Identify drug related problems...' },
            { id: '3.1', desc: 'Advocate patients rights...' }
        ],
            clo: [
                { id: 'CLO-IM-1', desc: 'Manage internal medicine cases', ploIds: ['1.3', '2.3'] },
                { id: 'CLO-ICU-1', desc: 'Handle critical care patients', ploIds: ['2.3', '3.1'] }
            ],
                rlo: [
                    { id: 'RLO-IM-01', desc: 'Daily rounds participation', cloIds: ['CLO-IM-1'] },
                    { id: 'RLO-ICU-01', desc: 'Ventilator settings review', cloIds: ['CLO-ICU-1'] }
                ]
},
stats: {
    evaluations: {
        studentAvg: 4.5,
            preceptorAvg: 4.2,
                siteAvg: 4.0
    },
    domains: {
        knowledge: 85,
            skills: 78,
                values: 92
    }
},
rotations: [
    { id: 'R001', block: 1, studentId: 'S001', siteId: 'H001', site: 'KAMC - Riyadh', preceptor: 'Dr. Majed Alyami', type: 'Internal Medicine', status: 'Completed' },
    { id: 'R002', block: 1, studentId: 'S002', siteId: 'H002', site: 'KFSH&RC', preceptor: 'Dr. Omar Alshaya', type: 'Ambulatory Care', status: 'Completed' },
    { id: 'R003', block: 2, studentId: 'S001', siteId: 'H003', site: 'PSCC', preceptor: 'Dr. Lama Alfehaid', type: 'Cardiology', status: 'In Progress' },
    { id: 'R004', block: 2, studentId: 'S004', siteId: 'C001', site: 'Al-Nahda PHC', preceptor: 'Dr. Khalid bin Saleh', type: 'Community', status: 'In Progress' },
],
    ippe_meta: {
    clos: [
        { id: '1.1', domain: 'Knowledge', desc: 'Foundational Knowledge' },
        { id: '1.2', domain: 'Knowledge', desc: 'Essentials for Practice' },
        { id: '2.1', domain: 'Skills', desc: 'Patient Care' },
        { id: '2.2', domain: 'Skills', desc: 'Problem Solving' },
        { id: '3.1', domain: 'Values', desc: 'Professionalism' },
        { id: '3.2', domain: 'Values', desc: 'Communication' }
    ],
        epas: [
            'Collect & Assess Information', 'Identify DRPs', 'Recommend Therapy',
            'Safety Tasks', 'Communication', 'Documentation', 'QA Standards',
            'Controlled Substances', 'Ethics'
        ],
            domains: [
                'Professionalism', 'Service Learning', 'Shadow Learning',
                'Patient Care', 'Practice Skills', 'Professional Development'
            ],
                sessions: [
                    'QA I', 'QA II', 'IV Room', 'Outpatient', 'Inpatient',
                    'Compounding', 'Packaging', 'KAIMRC', 'Informatics', 'Amb Care'
                ]
}
};

class Store {
    constructor() {
        this.init();
    }

    init() {
        const saved = localStorage.getItem('appe_data_v8');
        if (saved) {
            this.data = JSON.parse(saved);
        } else {
            this.data = INITIAL_DATA;
        }
        // Always run seed to hydrate missing new fields (like assessments)
        this.seedIPPEData();
        this.save();
    }

    save() {
        localStorage.setItem('appe_data_v8', JSON.stringify(this.data));
    }

    seedIPPEData() {
        const sessionsList = [
            'QA I', 'QA II', 'IV Room', 'Outpatient', 'Inpatient',
            'Compounding', 'Packaging', 'KAIMRC', 'Health Informatics', 'Ambulatory Care',
            'Inventory Management', 'Patient Counseling', 'Drug Information', 'Medication Safety', 'Narcotics Control',
            'Clinical Rounds', 'Journal Club', 'Case Presentation', 'Topic Discussion', 'Interprofessional Rounds',
            'Discharge Counseling', 'Medication Reconciliation', 'Anticoagulation Clinic', 'Diabetes Clinic', 'Hypertension Clinic',
            'Oncology Pharmacy', 'Pediatric Pharmacy', 'Emergency Medicine', 'Critical Care', 'Infectious Diseases'
        ];

        this.data.students.forEach((student, index) => {
            // 1. Demographics
            if (!student.demographics) {
                student.demographics = {
                    badgeNumber: `B${2025000 + index}`,
                    gender: Math.random() > 0.5 ? 'Female' : 'Male',
                    group: `Group ${String.fromCharCode(65 + (index % 5))}` // Groups A-E
                };
            }

            // 2. Attendance & Absence Tracking
            if (!student.attendanceRecords) {
                student.attendanceRecords = [];
                let excusedCount = 0;
                let unexcusedCount = 0;

                // Generate some random absences
                for (let i = 0; i < 20; i++) { // Simulate 20 weeks
                    if (Math.random() > 0.9) {
                        const isExcused = Math.random() > 0.4;
                        if (isExcused) excusedCount++;
                        else unexcusedCount++;

                        student.attendanceRecords.push({
                            date: `2024-09-${10 + i}`,
                            status: isExcused ? 'Excused' : 'Unexcused',
                            reason: isExcused ? 'Medical appointment' : 'Overslept',
                            documented: isExcused
                        });
                    }
                }
                student.attendanceStats = {
                    excused: excusedCount,
                    unexcused: unexcusedCount,
                    compliance: Math.max(0, 100 - ((excusedCount + unexcusedCount * 2) * 2)) // Mock calc
                };
            }

            // 3. Professionalism Dashboard
            if (!student.professionalism) {
                student.professionalism = {
                    score: Math.floor(Math.random() * 3) + 7, // 7-10
                    categories: {
                        punctuality: Math.floor(Math.random() * 2) + 8,
                        dressCode: 10,
                        responsibility: Math.floor(Math.random() * 3) + 7,
                        confidentiality: 10,
                        behavior: 10
                    },
                    violations: [],
                    trend: [8, 9, 9, 8, 9, 10] // Mock trend
                };

                if (student.professionalism.score < 9) {
                    student.professionalism.violations.push({
                        date: '2024-09-15',
                        category: 'Punctuality',
                        note: 'Late arrival to morning huddle',
                        corrected: Math.random() > 0.5
                    });
                }
            }

            // 16. Misconduct & 17. AI Policy
            if (!student.misconduct) {
                student.misconduct = [];
                if (Math.random() > 0.95) {
                    student.misconduct.push({
                        date: '2024-10-01',
                        type: Math.random() > 0.5 ? 'Plagiarism' : 'AI Misuse',
                        category: 'Reflection',
                        action: 'Warning Letter',
                        resolution: 'Counseling Session'
                    });
                }
            }

            // 5. Session-by-Session Tracking
            if (!student.competencies) {
                student.competencies = {
                    clos: {},
                    epas: {},
                    domains: {},
                    sessions: []
                };

                // Seed CLOs (0-100%)
                this.data.ippe_meta.clos.forEach(clo => {
                    student.competencies.clos[clo.id] = Math.floor(Math.random() * 30) + 70;
                });

                // Seed EPAs (1-5)
                this.data.ippe_meta.epas.forEach(epa => {
                    student.competencies.epas[epa] = Math.floor(Math.random() * 2) + 3;
                });

                // Seed Domains (0-100%)
                this.data.ippe_meta.domains.forEach(dom => {
                    student.competencies.domains[dom] = Math.floor(Math.random() * 20) + 80;
                });

                // Seed 30 Sessions
                sessionsList.forEach((sess, idx) => {
                    student.competencies.sessions.push({
                        id: idx + 1,
                        name: sess,
                        status: Math.random() > 0.1 ? 'Completed' : 'Pending',
                        score: Math.floor(Math.random() * 2) + 3, // 3-5
                        preceptor: 'Dr. Preceptor',
                        site: 'KAMC',
                        strengths: 'Good communication',
                        weaknesses: 'Needs more confidence'
                    });
                });
            }

            // 13. Site & 14. Preceptor Evaluations (Mock Data)
            if (!student.evaluations) {
                student.evaluations = {
                    site: { score: 4.5, comments: 'Great learning environment' },
                    preceptor: { score: 4.8, comments: 'Very supportive' }
                };
            }

            // 15. Assessments (Mid-Year, End-Year, Portfolio, EPA, Simulation)
            if (!student.assessments) {
                student.assessments = {
                    midYear: {
                        score: Math.floor(Math.random() * 20) + 80,
                        competencies: { '1.1': 3, '2.1': 3, '3.1': 3 } // Mock competency ratings
                    },
                    endYear: {
                        score: Math.floor(Math.random() * 20) + 80,
                        competencies: { '1.1': 4, '2.1': 4, '3.1': 4 }
                    },
                    portfolio: {
                        score: Math.floor(Math.random() * 20) + 80,
                        status: Math.random() > 0.9 ? 'Late' : 'Submitted'
                    },
                    epa: {
                        score: Math.floor(Math.random() * 20) + 80,
                        level: Math.floor(Math.random() * 3) + 2 // Levels 2-5
                    },
                    simulation: {
                        score: Math.floor(Math.random() * 20) + 80,
                        completed: true
                    }
                };
            }
        });
    }

    addStudent(student) {
        this.data.students.push(student);
        this.save();
    }

    getStudents() {
        return this.data.students || [];
    }

    getHighRiskStudents() {
        return this.data.students.filter(s => s.risk === 'high' || s.risk === 'medium');
    }

    getStudentAttendance(studentId) {
        const student = this.data.students.find(s => s.id === studentId);
        return student ? student.attendanceRecords : [];
    }

    getStudentProfessionalism(studentId) {
        const student = this.data.students.find(s => s.id === studentId);
        return student ? student.professionalism : null;
    }

    getStudentGrades(studentId) {
        const student = this.data.students.find(s => s.id === studentId);
        return student ? student.grades : null;
    }

    getIPPEMeta() {
        return this.data.ippe_meta;
    }

    getStudentCompetencies(studentId) {
        const student = this.data.students.find(s => s.id === studentId);
        return student ? student.competencies : null;
    }

    // Sites
    getSites() {
        return this.data.sites;
    }

    // Rotations
    getRotations() {
        return this.data.rotations || [];
    }

    // Preceptors
    getPreceptors() {
        return this.data.preceptors || [];
    }

    isPreceptorAvailable(preceptorName, blockNumber) {
        const preceptor = this.data.preceptors.find(p => p.name === preceptorName);
        if (!preceptor || !preceptor.availability) return false;
        // Block number is 1-indexed, array is 0-indexed
        return preceptor.availability[blockNumber - 1];
    }

    // Outcomes
    getOutcomes() {
        return this.data.outcomes || {};
    }

    // Stats
    getStats() {
        return this.data.stats || {};
    }

    // Student Assessments
    getStudentAssessments(studentId) {
        const student = this.data.students.find(s => s.id === studentId);
        return student ? student.assessments : null;
    }

    // Calculate Student Grade
    calculateStudentGrade(studentId) {
        const student = this.data.students.find(s => s.id === studentId);
        if (!student || !student.assessments) return null;

        const assessments = student.assessments;
        const prof = student.professionalism || { score: 10, violations: [] };

        // New Weights
        const weights = {
            professionalism: 30,
            midYear: 10,
            endYear: 20,
            portfolio: 15,
            epa: 10,
            simulation: 15
        };

        // 1. Professionalism (30%)
        // Penalty: Lose 20% of TOTAL grade if uncorrected violation exists
        // For now, we assume any violation in the list triggers this if not explicitly marked 'corrected'
        const hasUncorrectedViolation = prof.violations.some(v => !v.corrected);
        let professionalismScore = 100; // Base score
        // If score < 6/10, it's a risk, but the 20% penalty is specific to the rule
        // The user said "loses 20% of the grade". This usually means 20 percentage points from the final grade.
        // However, standard grading usually calculates component score. 
        // Let's calculate component score first.
        // If score is 10/10 -> 100%. 
        professionalismScore = (prof.score / 10) * 100;

        let professionalismPenalty = 0;
        if (hasUncorrectedViolation) {
            professionalismPenalty = 20; // 20% of total grade means we might need to deduct from final, or set this component to 0?
            // "student loses 20% of the grade" -> Likely 20 points off the final grade.
            // I will track this as a specific deduction.
        }

        // 2. Mid-Year (10%) & 3. Final (20%)
        // Penalty: 5% of grade for each persisting 'unsatisfactory'
        const countUnsatisfactory = (evalObj) => {
            if (!evalObj || !evalObj.competencies) return 0;
            return Object.values(evalObj.competencies).filter(val => val === 1).length; // Assuming 1 is Unsatisfactory
        };

        const midYearUnsatisfactoryCount = countUnsatisfactory(assessments.midYear);
        const finalYearUnsatisfactoryCount = countUnsatisfactory(assessments.endYear);

        const midYearPenalty = midYearUnsatisfactoryCount * 5; // 5% per item
        const finalYearPenalty = finalYearUnsatisfactoryCount * 5;

        const midYearScore = assessments.midYear?.score || 100; // Default to 100 if not set, or calculate from items
        const finalYearScore = assessments.endYear?.score || 100;

        // 4. Portfolio (15%)
        // Penalty: 2-8% for late/incomplete
        let portfolioPenalty = 0;
        if (assessments.portfolio?.status === 'Late') portfolioPenalty = 5; // Average 5%
        if (assessments.portfolio?.status === 'Incomplete') portfolioPenalty = 8;
        const portfolioScore = assessments.portfolio?.score || 100;

        // 5. EPA (10%)
        const epaScore = assessments.epa?.score || 0;

        // 6. Simulation (15%)
        const simulationScore = assessments.simulation?.score || 0;

        // Calculate Weighted Total
        let weightedTotal =
            (professionalismScore * 0.30) +
            (midYearScore * 0.10) +
            (finalYearScore * 0.20) +
            (portfolioScore * 0.15) +
            (epaScore * 0.10) +
            (simulationScore * 0.15);

        // Apply Penalties (Deducted from the Final Grade directly based on "loses X% of the grade")
        const totalPenalty = professionalismPenalty + midYearPenalty + finalYearPenalty + portfolioPenalty;
        let finalGrade = weightedTotal - totalPenalty;
        if (finalGrade < 0) finalGrade = 0;

        return {
            finalGrade: Math.round(finalGrade * 10) / 10,
            weightedTotal: Math.round(weightedTotal * 10) / 10,
            totalPenalty: totalPenalty,
            components: {
                professionalism: {
                    weight: 30,
                    score: professionalismScore,
                    penalty: professionalismPenalty,
                    note: hasUncorrectedViolation ? 'Uncorrected Violation (-20%)' : ''
                },
                midYear: {
                    weight: 10,
                    score: midYearScore,
                    penalty: midYearPenalty,
                    note: midYearUnsatisfactoryCount > 0 ? `${midYearUnsatisfactoryCount} Unsatisfactory Items (-${midYearPenalty}%)` : ''
                },
                endYear: {
                    weight: 20,
                    score: finalYearScore,
                    penalty: finalYearPenalty,
                    note: finalYearUnsatisfactoryCount > 0 ? `${finalYearUnsatisfactoryCount} Unsatisfactory Items (-${finalYearPenalty}%)` : ''
                },
                portfolio: {
                    weight: 15,
                    score: portfolioScore,
                    penalty: portfolioPenalty,
                    note: portfolioPenalty > 0 ? `Status: ${assessments.portfolio?.status} (-${portfolioPenalty}%)` : ''
                },
                epa: { weight: 10, score: epaScore, penalty: 0 },
                simulation: { weight: 15, score: simulationScore, penalty: 0 }
            }
        };
    }

    // Dashboard KPIs
    getKPIs() {
        return {
            totalStudents: this.data.students.length,
            activeRotations: this.data.rotations.filter(r => r.status === 'In Progress').length,
            avgGPA: (this.data.students.reduce((acc, s) => acc + s.gpa, 0) / this.data.students.length).toFixed(2),
            highRiskCount: this.data.students.filter(s => s.risk === 'high').length
        };
    }
}

// Initialize Store
const store = new Store();
window.appStore = store;
