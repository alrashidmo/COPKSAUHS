<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1B5E20">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQVBQRSBTdHVkZW50IFBvcnRhbCIsInNob3J0X25hbWUiOiJBUFBFIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxQjVFMjAiLCJ0aGVtZV9jb2xvciI6IiMxQjVFMjAifQ==">
    <title>APPE Student Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1B5E20;
            --primary-light: #4CAF50;
            --primary-dark: #0d3310;
            --bg-gray: #f5f7fa;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gray);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 70px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0 0 1.5rem 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            padding: 0.75rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        /* Content */
        .content {
            padding: 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-green {
            background: #dcfce7;
            color: #166534;
        }

        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-gray {
            background: #f3f4f6;
            color: #4b5563;
        }

        /* Info Rows */
        .info-row {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
            color: var(--primary-light);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        select, input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-light);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary);
            transform: scale(0.98);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
        }

        .nav-item.active {
            color: var(--primary-light);
        }

        .nav-item svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .login-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-icon {
            width: 4rem;
            height: 4rem;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .demo-info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #1e40af;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2.5rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 1.5rem;
            top: 3rem;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
        }

        .timeline-dot {
            position: absolute;
            left: -2.5rem;
            top: 0.5rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .timeline-dot.green { background: #22c55e; }
        .timeline-dot.blue { background: #3b82f6; }

        /* Preference Ranks */
        .rank-badge {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        /* Utility chips and progress */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.7rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            background: #f3f4f6;
            color: #374151;
        }

        .chip-success { background: #dcfce7; color: #166534; }
        .chip-info { background: #e0f2fe; color: #1d4ed8; }
        .chip-warning { background: #fef3c7; color: #92400e; }
        .chip-danger { background: #fee2e2; color: #b91c1c; }

        .progress-shell {
            background: #e5e7eb;
            height: 10px;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            transition: width 0.3s ease;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-dark);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: white;
            padding: 0.85rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            font-size: 0.9rem;
            z-index: 9999;
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -6px);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-header">
                <div class="login-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>
                    </svg>
                </div>
                <h1 class="login-title">APPE Student Portal</h1>
                <p style="color: var(--text-gray);">Advanced Pharmacy Practice Experience</p>
            </div>

            <!-- Tab Buttons -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <button type="button" id="tabSignIn" class="tab-btn active" onclick="switchLoginTab('signin')" style="flex: 1; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">Sign In</button>
                <button type="button" id="tabSignUp" class="tab-btn" onclick="switchLoginTab('signup')" style="flex: 1; padding: 0.75rem; background: #e5e7eb; color: var(--text-dark); border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">Sign Up</button>
            </div>

            <!-- Sign In Form -->
            <form id="loginForm" class="login-tab active">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="emailInput" placeholder="you@student.edu" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>

            <!-- Sign Up Form -->
            <form id="signupForm" class="login-tab hidden" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="signupName" placeholder="Your full name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="signupEmail" placeholder="you@student.edu" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Student ID</label>
                    <input type="text" id="signupStudentId" placeholder="Your student ID" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="signupPhone" placeholder="+966..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">Year Level</label>
                    <select id="signupYearLevel" required style="padding: 0.6rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; width: 100%;">
                        <option value="">Select your year...</option>
                        <option value="P1">First Year (P1)</option>
                        <option value="P2">Second Year (P2)</option>
                        <option value="P3">Third Year (P3)</option>
                        <option value="P4">Fourth Year (P4)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Request Access</button>
                <div id="signupMessage" style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; text-align: center; font-size: 0.85rem; display: none;"></div>
            </form>

            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                <p style="font-size: 0.75rem; color: var(--text-gray);">
                    Demo Accounts:<br>
                    Admin: alrashidm@ksau-hs.edu.sa / ALRASHED<br>
                    P1: first.year@student.edu / first123<br>
                    P2: second.year@student.edu / second123<br>
                    P3: third.year@student.edu / third123<br>
                    P4: fourth.year@student.edu / fourth123
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Home/Dashboard Page -->
        <div id="homePage" class="page active">
            <div class="header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">
                <h1 id="welcomeName">Welcome back!</h1>
                <p id="welcomeYear">Your clinical dashboard</p>
            </div>

            <div class="content">
                <div class="card" id="dashboardAlerts" style="display:none; background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b;">
                    <div class="section-title" style="color: #92400e;">‚ö†Ô∏è Alerts & Reminders</div>
                    <div id="alertsList"></div>
                </div>

                <div class="card" id="dashboardOverview">
                    <div class="section-title">üìä Quick Overview</div>
                    <div style="color: var(--text-gray);">Loading dashboard...</div>
                </div>

                <div class="card" id="dashboardGoals">
                    <div class="section-title">üéØ Weekly Goals</div>
                    <div id="goalsContent" style="color: var(--text-gray);">Loading goals...</div>
                </div>

                <div class="card">
                    <div class="section-title">üéØ Quick Actions</div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="showPage('clinical', event)" class="btn btn-primary" style="text-align: left; padding: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üè•</span>
                            <div>
                                <div style="font-weight: 600;">Clinical Experience</div>
                                <div style="font-size: 0.8rem; opacity: 0.8;">Log hours, track attendance & activities</div>
                            </div>
                        </button>
                        <button onclick="showPage('profile', event)" class="btn" style="text-align: left; padding: 1rem; display: flex; align-items: center; gap: 0.75rem; background: #f3f4f6; color: var(--text-dark);">
                            <span style="font-size: 1.5rem;">üë§</span>
                            <div>
                                <div style="font-weight: 600;">My Profile</div>
                                <div style="font-size: 0.8rem; opacity: 0.7;">View account information</div>
                            </div>
                        </button>
                        <button onclick="showPage('resources', event)" class="btn" style="text-align: left; padding: 1rem; display: flex; align-items: center; gap: 0.75rem; background: #f3f4f6; color: var(--text-dark);">
                            <span style="font-size: 1.5rem;">üìö</span>
                            <div>
                                <div style="font-weight: 600;">Resources</div>
                                <div style="font-size: 0.8rem; opacity: 0.7;">Forms, guidelines & contacts</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">üìö Recent Activity</div>
                    <div id="recentActivity" style="color: var(--text-gray); font-size: 0.9rem;">
                        Your recent clinical activities will appear here
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">
                <h1>My Profile</h1>
                <p>Account information & settings</p>
            </div>

            <div class="content">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="width: 5rem; height: 5rem; background: linear-gradient(135deg, var(--primary-light), var(--primary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">
                            <span id="profileInitials">--</span>
                        </div>
                        <div>
                            <h2 id="profileName" style="font-size: 1.25rem; font-weight: 600;">Student Name</h2>
                            <p id="profileId" style="color: var(--text-gray);">Student ID</p>
                            <div id="profileYear" class="chip chip-info" style="margin-top:0.35rem; width:max-content;">Year</div>
                        </div>
                    </div>

                    <div class="info-row">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-gray);">Email</div>
                            <div id="profileEmail" style="font-weight: 500; font-size: 0.875rem;">you@student.edu</div>
                        </div>
                    </div>

                    <div class="info-row">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-gray);">Phone</div>
                            <div id="profilePhone" style="font-weight: 500; font-size: 0.875rem;">+966500000000</div>
                        </div>
                    </div>

                    <div class="info-row">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-gray);">GPA</div>
                            <div id="profileGpa" style="font-weight: 500; font-size: 0.875rem;">-</div>
                        </div>
                    </div>

                    <div class="info-row">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-gray);">Enrollment Year</div>
                            <div id="profileEnrollment" style="font-weight: 500; font-size: 0.875rem;">-</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-weight: 600; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; margin-bottom: 0.5rem;">About</h3>
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">
                        <span>App Version</span>
                        <span style="font-weight: 500; color: var(--text-dark);">1.0.0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-gray);">
                        <span>Last Updated</span>
                        <span style="font-weight: 500; color: var(--text-dark);">Jan 2026</span>
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">üîî Notification Preferences</div>
                    <div style="display:flex; flex-direction:column; gap:0.75rem;">
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <input type="checkbox" id="enableDailyDigest" onchange="toggleDailyDigest(this.checked)" style="width:1.2rem; height:1.2rem; cursor:pointer;">
                            <label for="enableDailyDigest" style="flex:1; cursor:pointer; font-size:0.9rem;">üìß Enable Daily Digest (receive all announcements in one daily summary)</label>
                        </div>
                        <div id="digestTimeField" style="display:none; padding-left:1.7rem;">
                            <label style="font-size:0.85rem; color:#666; display:block; margin-bottom:0.25rem;">Preferred time:</label>
                            <input type="time" id="digestTime" value="08:00" onchange="saveDailyDigestTime(this.value)" style="padding:0.5rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                    </div>
                </div>

                <button onclick="logout()" class="btn btn-primary" style="background: #ef4444;">
                    üö™ Sign Out
                </button>
            </div>
        </div>

        <!-- Academic Page -->
        <div id="academicPage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                <h1>üéì Academic</h1>
                <p id="academicSemester">Academic tracking & readiness</p>
            </div>

            <div class="content">
                <!-- Student-Specific Announcements -->
                <div id="academicAnnouncements" class="card" style="display: none; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #3b82f6;">
                    <div class="section-title" style="color: #1e40af; display:flex; justify-content:space-between; align-items:center;">
                        <span>üì¢ Your Academic Announcements</span>
                        <div style="display:flex; gap:0.35rem; flex-wrap:wrap;">
                            <button onclick="setAnnouncementFilter('All')" class="chip" style="background:#eff6ff; color:#1e40af;">All</button>
                            <button onclick="setAnnouncementFilter('Grades')" class="chip" style="background:#f3f4f6;">Grades</button>
                            <button onclick="setAnnouncementFilter('Assignments')" class="chip" style="background:#f3f4f6;">Assignments</button>
                            <button onclick="setAnnouncementFilter('Exams')" class="chip" style="background:#f3f4f6;">Exams</button>
                            <button onclick="setAnnouncementFilter('Quizzes')" class="chip" style="background:#f3f4f6;">Quizzes</button>
                            <button onclick="setAnnouncementFilter('Attendance')" class="chip" style="background:#f3f4f6;">Attendance</button>
                            <button onclick="setAnnouncementFilter('Advising')" class="chip" style="background:#f3f4f6;">Advising</button>
                            <button onclick="setAnnouncementFilter('Schedule')" class="chip" style="background:#f3f4f6;">Schedule</button>
                            <button onclick="setAnnouncementFilter('General')" class="chip" style="background:#f3f4f6;">General</button>
                        </div>
                    </div>
                    <div id="announcementsList"></div>
                </div>

                <!-- Risk Alerts -->
                <div id="academicRisks" class="card" style="display: none; background: linear-gradient(135deg, #fee2e2, #fecaca); border-left: 4px solid #dc2626;">
                    <div class="section-title" style="color: #991b1b;">‚ö†Ô∏è Academic Alerts</div>
                    <div id="risksList"></div>
                </div>

                <!-- GPA & Performance -->
                <div class="card">
                    <div class="section-title">üìà Grades & Performance</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: #f3f4f6; border-radius: 0.75rem;">
                            <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Cumulative GPA</div>
                            <div id="cumulativeGpa" style="font-size: 1.75rem; font-weight: 800; color: var(--primary);">-</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f3f4f6; border-radius: 0.75rem;">
                            <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Semester GPA</div>
                            <div id="semesterGpa" style="font-size: 1.75rem; font-weight: 800; color: #7c3aed;">-</div>
                            <div id="gpaTrend" style="font-size: 0.875rem; margin-top: 0.25rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Courses & Blocks -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div class="section-title" style="margin: 0;">üìö Courses & Blocks</div>
                        <span id="totalCredits" class="chip chip-info"></span>
                    </div>
                    <div id="coursesList" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                </div>

                <!-- Assessments -->
                <div class="card">
                    <div class="section-title">üìù Assessments</div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="font-weight: 600; font-size: 0.875rem; color: var(--text-gray);">Upcoming Exams</div>
                            <button onclick="toggleExamForm()" style="background: none; border: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; padding: 0;">+</button>
                        </div>
                        <div id="examForm" class="hidden" style="padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                            <form id="addExamForm" onsubmit="handleAddExam(event)">
                                <select id="examCourse" required style="margin-bottom: 0.5rem;">
                                    <option value="">Select Course</option>
                                </select>
                                <input type="text" id="examTitle" placeholder="Exam Title" required style="margin-bottom: 0.5rem;">
                                <input type="date" id="examDate" required style="margin-bottom: 0.5rem;">
                                <select id="examType" required style="margin-bottom: 0.5rem;">
                                    <option value="">Select Type</option>
                                    <option value="Written">Written Exam</option>
                                    <option value="OSCE">OSCE</option>
                                    <option value="Practical">Practical</option>
                                    <option value="Oral">Oral Exam</option>
                                </select>
                                <button type="submit" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.625rem;">Add Exam</button>
                            </form>
                        </div>
                        <div id="upcomingExams" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="font-weight: 600; font-size: 0.875rem; color: var(--text-gray);">Recent Quizzes & OSCEs</div>
                            <button onclick="toggleQuizForm()" style="background: none; border: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; padding: 0;">+</button>
                        </div>
                        <div id="quizForm" class="hidden" style="padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                            <form id="addQuizForm" onsubmit="handleAddQuiz(event)">
                                <select id="quizCourse" required style="margin-bottom: 0.5rem;">
                                    <option value="">Select Course</option>
                                </select>
                                <input type="text" id="quizTitle" placeholder="Quiz/OSCE Title" required style="margin-bottom: 0.5rem;">
                                <input type="date" id="quizDate" required style="margin-bottom: 0.5rem;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <input type="number" id="quizScore" placeholder="Score" required min="0">
                                    <input type="number" id="quizTotal" placeholder="Total" required min="1">
                                </div>
                                <input type="text" id="quizFeedback" placeholder="Feedback (optional)" style="margin-bottom: 0.5rem;">
                                <button type="submit" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.625rem;">Add Quiz/OSCE</button>
                            </form>
                        </div>
                        <div id="recentQuizzes" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                    </div>
                    <div id="assignmentsList" style="margin-top: 1rem;"></div>
                    <div style="margin-top: 0.75rem;">
                        <button onclick="toggleAssignmentForm()" class="btn" style="background: var(--primary); color: white; font-size: 0.875rem; padding: 0.625rem;">+ Add Assignment</button>
                        <div id="assignmentForm" class="hidden" style="padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; margin-top: 0.75rem;">
                            <form id="addAssignmentForm" onsubmit="handleAddAssignment(event)">
                                <select id="assignmentCourse" required style="margin-bottom: 0.5rem;">
                                    <option value="">Select Course</option>
                                </select>
                                <input type="text" id="assignmentTitle" placeholder="Assignment Title" required style="margin-bottom: 0.5rem;">
                                <input type="date" id="assignmentDue" required style="margin-bottom: 0.5rem;">
                                <button type="submit" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.625rem;">Add Assignment</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Attendance (Academic) -->
                <div class="card">
                    <div class="section-title">‚úÖ Academic Attendance</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 0.75rem; background: #dcfce7; border-radius: 0.75rem;">
                            <div style="font-size: 0.75rem; color: #166534; margin-bottom: 0.25rem;">Lectures</div>
                            <div id="lectureAttendance" style="font-size: 1.5rem; font-weight: 700; color: #166534;">-</div>
                        </div>
                        <div style="text-align: center; padding: 0.75rem; background: #dbeafe; border-radius: 0.75rem;">
                            <div style="font-size: 0.75rem; color: #1e40af; margin-bottom: 0.25rem;">Labs</div>
                            <div id="labAttendance" style="font-size: 1.5rem; font-weight: 700; color: #1e40af;">-</div>
                        </div>
                    </div>
                    <div id="absencesList" style="margin-top: 0.75rem;"></div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                        <button onclick="toggleAbsenceForm()" class="btn" style="background: #ef4444; color: white; flex: 1; font-size: 0.875rem; padding: 0.625rem;">+ Report Absence</button>
                        <button onclick="uploadJustification()" class="btn" style="background: #6366f1; color: white; flex: 1; font-size: 0.875rem; padding: 0.625rem;">üìé Upload Justification</button>
                    </div>
                    <div id="absenceForm" class="hidden" style="padding: 0.75rem; background: #fef2f2; border-radius: 0.5rem; margin-top: 0.75rem;">
                        <form id="addAbsenceForm" onsubmit="handleAddAbsence(event)">
                            <input type="date" id="absenceDate" required style="margin-bottom: 0.5rem;">
                            <select id="absenceType" required style="margin-bottom: 0.5rem;">
                                <option value="">Select Type</option>
                                <option value="Lecture">Lecture</option>
                                <option value="Lab">Lab</option>
                            </select>
                            <select id="absenceCourse" required style="margin-bottom: 0.5rem;">
                                <option value="">Select Course</option>
                            </select>
                            <input type="text" id="absenceReason" placeholder="Reason" required style="margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="absenceJustified" style="width: auto;">
                                <label for="absenceJustified" style="font-size: 0.875rem;">I have justification documentation</label>
                            </div>
                            <button type="submit" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.625rem;">Report Absence</button>
                        </form>
                    </div>
                </div>

                <!-- Academic Advising -->
                <div class="card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                    <div class="section-title" style="color: #166534;">üë®‚Äçüè´ Academic Advising</div>
                    <div id="advisorInfo" style="margin-bottom: 1rem;"></div>
                    <div style="margin-bottom: 0.75rem;">
                        <div style="font-weight: 600; font-size: 0.875rem; color: #166534; margin-bottom: 0.5rem;">Recent Notes</div>
                        <div id="advisingNotes"></div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="font-weight: 600; font-size: 0.875rem; color: #166534;">Action Items</div>
                            <button onclick="toggleActionItemForm()" style="background: none; border: none; color: #166534; font-size: 1.5rem; cursor: pointer; padding: 0;">+</button>
                        </div>
                        <div id="actionItemForm" class="hidden" style="padding: 0.75rem; background: white; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                            <form id="addActionItemForm" onsubmit="handleAddActionItem(event)">
                                <input type="text" id="actionItemTask" placeholder="New action item..." required style="margin-bottom: 0.5rem;">
                                <button type="submit" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.625rem;">Add Action Item</button>
                            </form>
                        </div>
                        <div id="actionItems"></div>
                    </div>
                </div>

                <!-- Documents -->
                <div class="card">
                    <div class="section-title">üìÑ Documents</div>
                    <div id="documentsList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                </div>

                <!-- Recommended Resources -->
                <div id="recommendedResources" class="card" style="display: none; background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b;">
                    <div class="section-title" style="color: #92400e;">üí° Recommended Resources</div>
                    <div id="resourcesList"></div>
                </div>

                <!-- Schedule -->
                <div class="card">
                    <div class="section-title">üìÖ This Week's Schedule</div>
                    <div id="weekSchedule" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                </div>
            </div>
        </div>

        <!-- Messages Page -->
        <div id="messagesPage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, #0891b2, #06b6d4);">
                <h1>üí¨ Messages</h1>
                <p>Communicate with your advisor</p>
            </div>

            <div class="content">
                <div style="display:grid; grid-template-columns:200px 1fr; gap:1rem; min-height:calc(100vh - 300px);">
                    <!-- Conversations List -->
                    <div id="conversationsList" style="border-right:1px solid #e5e7eb; padding-right:1rem; overflow-y:auto;">
                        <div id="convList" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
                        <button onclick="startNewConversation()" class="btn" style="margin-top:1rem; width:100%; background:#0891b2; color:#fff;">+ New Message</button>
                    </div>
                    
                    <!-- Messages View -->
                    <div id="messagesView" style="display:flex; flex-direction:column; gap:1rem; overflow-y:auto;">
                        <div id="messagesList" style="flex:1; display:flex; flex-direction:column; gap:0.5rem;"></div>
                        <form id="messageForm" onsubmit="sendMessage(event)" style="display:flex; gap:0.5rem;">
                            <textarea id="messageInput" placeholder="Type your message..." style="flex:1; padding:0.75rem; border:1px solid #e5e7eb; border-radius:0.5rem; resize:none; height:80px; font-family:inherit;"></textarea>
                            <button type="submit" class="btn" style="background:#0891b2; color:#fff; align-self:flex-end;">Send</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analyticsPage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                <h1>üìä Grade Analytics</h1>
                <p>Your performance trends</p>
            </div>

            <div class="content">
                <div class="card">
                    <div class="section-title">üìà Grade Progression</div>
                    <canvas id="gradeChart" style="max-height:300px; margin-bottom:1rem;"></canvas>
                </div>

                <div class="card">
                    <div class="section-title">üìÇ Course Performance</div>
                    <div id="courseAnalytics" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
                </div>

                <div class="card">
                    <div class="section-title">üéØ Performance Insights</div>
                    <div id="analyticsInsights" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
                </div>
            </div>
        </div>
            <div class="header" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                <h1>Resources</h1>
                <p>Quick access to forms & guidelines</p>
            </div>

            <div class="content">
                <div class="card">
                    <div class="section-title">üìã Forms & Documents</div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <a href="#" onclick="showToast('Form will open'); return false;" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; text-decoration: none; color: var(--text-dark);">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">üìÑ Attendance Form</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Daily attendance submission</div>
                            </div>
                            <span style="color: var(--primary);">‚Üí</span>
                        </a>
                        <a href="#" onclick="showToast('Form will open'); return false;" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; text-decoration: none; color: var(--text-dark);">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">üìù Weekly Log Template</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Weekly activity summary</div>
                            </div>
                            <span style="color: var(--primary);">‚Üí</span>
                        </a>
                        <a href="#" onclick="showToast('Form will open'); return false;" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; text-decoration: none; color: var(--text-dark);">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">üìä Evaluation Form</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Preceptor evaluation</div>
                            </div>
                            <span style="color: var(--primary);">‚Üí</span>
                        </a>
                        <a href="#" onclick="showToast('Form will open'); return false;" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; text-decoration: none; color: var(--text-dark);">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">üéØ Learning Objectives</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Rotation objectives checklist</div>
                            </div>
                            <span style="color: var(--primary);">‚Üí</span>
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">üìñ Guidelines & Policies</div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <a href="#" onclick="showToast('Opening guideline'); return false;" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; text-decoration: none; color: var(--text-dark);">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">üìò APPE Handbook</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Complete program guide</div>
                            </div>
                            <span style="color: var(--primary);">‚Üí</span>
                        </a>
                        <a href="#" onclick="showToast('Opening guideline'); return false;" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; text-decoration: none; color: var(--text-dark);">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">‚öïÔ∏è Professionalism Standards</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Expected conduct & ethics</div>
                            </div>
                            <span style="color: var(--primary);">‚Üí</span>
                        </a>
                        <a href="#" onclick="showToast('Opening guideline'); return false;" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; text-decoration: none; color: var(--text-dark);">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">üè• Site Requirements</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Dress code, vaccinations, etc.</div>
                            </div>
                            <span style="color: var(--primary);">‚Üí</span>
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">üë®‚Äç‚öïÔ∏è Contacts</div>
                    <div class="info-row">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-gray);">APPE Coordinator</div>
                            <div style="font-weight: 500; font-size: 0.875rem;">coordinator@university.edu</div>
                        </div>
                    </div>
                    <div class="info-row">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-gray);">Emergency Contact</div>
                            <div style="font-weight: 500; font-size: 0.875rem;">+966 11 234 5678</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">Need Help?</div>
                        <p style="font-size: 0.875rem; color: #1e40af; margin-bottom: 1rem;">Contact your preceptor or APPE coordinator for any questions or concerns.</p>
                        <button onclick="showToast('Opening support')" class="btn btn-primary" style="background: #3b82f6;">üìß Contact Support</button>
                    </div>
                </div>

                <!-- Study Resources -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div class="section-title" style="margin: 0;">üìö Study Resources</div>
                        <button onclick="toggleResourceForm()" class="btn" style="background: var(--primary); color: white; font-size: 0.875rem; padding: 0.625rem;">+ Add Resource</button>
                    </div>
                    <div id="resourceForm" class="hidden" style="padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <form id="addResourceForm" onsubmit="handleAddResource(event)">
                            <select id="resourceCourse" required style="margin-bottom: 0.5rem;">
                                <option value="">Select Course</option>
                            </select>
                            <input type="text" id="resourceTitle" placeholder="Resource Title" required style="margin-bottom: 0.5rem;">
                            <input type="url" id="resourceLink" placeholder="Resource URL (https://...)" required style="margin-bottom: 0.5rem;">
                            <select id="resourceType" required style="margin-bottom: 0.5rem;">
                                <option value="">Select Type</option>
                                <option value="Notes">üìù Lecture Notes</option>
                                <option value="Video">üé• Video Lecture</option>
                                <option value="Textbook">üìñ Textbook</option>
                                <option value="Practice">‚úèÔ∏è Practice Exam</option>
                                <option value="Other">üìÑ Other</option>
                            </select>
                            <button type="submit" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.625rem;">Add Resource</button>
                        </form>
                    </div>
                    <div id="resourcesList" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                </div>

                <!-- Assignment Submissions -->
                <div class="card">
                    <div class="section-title">üì§ Assignment Submissions</div>
                    <div id="submissionsContainer" style="display: flex; flex-direction: column; gap: 1rem;"></div>
                </div>
            </div>
        </div>

        <!-- Clinical Page -->
        <div id="clinicalPage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                <h1>Clinical Experience</h1>
                <p>IPPE, hours, attendance, and activities</p>
            </div>
            <div class="content" id="clinicalContent"></div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, #6b7280, #9ca3af);">
                <h1>Settings</h1>
                <p>Preferences & notifications</p>
            </div>

            <div class="content">
                <div class="card">
                    <div class="section-title">üîî Notifications</div>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">Hour Reminders</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Daily reminder to log hours</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 48px; height: 24px;">
                                <input type="checkbox" id="notifHours" checked onchange="saveSettings()" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--primary-light); border-radius: 24px; transition: .4s;"></span>
                            </label>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">Low Hours Alert</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Alert when behind schedule</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 48px; height: 24px;">
                                <input type="checkbox" id="notifAlerts" checked onchange="saveSettings()" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--primary-light); border-radius: 24px; transition: .4s;"></span>
                            </label>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">Activity Reminders</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">Incomplete task notifications</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 48px; height: 24px;">
                                <input type="checkbox" id="notifActivities" checked onchange="saveSettings()" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--primary-light); border-radius: 24px; transition: .4s;"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">üéØ Goals</div>
                    <div class="form-group">
                        <label class="form-label">Weekly Hour Goal</label>
                        <input type="number" id="weeklyGoal" value="40" min="1" max="60" onchange="saveSettings()" style="text-align: center; font-weight: 600; font-size: 1.1rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Daily Activity Target</label>
                        <input type="number" id="activityGoal" value="3" min="1" max="10" onchange="saveSettings()" style="text-align: center; font-weight: 600; font-size: 1.1rem;">
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">üíæ Data Management</div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="exportAllData()" class="btn" style="background: #3b82f6; color: white;">
                            üì§ Export All Data (JSON)
                        </button>
                        <button onclick="document.getElementById('importAllData').click()" class="btn" style="background: #8b5cf6; color: white;">
                            üì• Import Data (JSON)
                        </button>
                        <button onclick="clearAllData()" class="btn" style="background: #ef4444; color: white;">
                            üóëÔ∏è Clear All Data
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">üë• Manage Users</div>
                    <div id="userList" style="display:flex; flex-direction:column; gap:0.35rem; margin-bottom:0.75rem;"></div>
                    <form id="addUserForm" onsubmit="handleAddUser(event)" style="display:flex; flex-direction:column; gap:0.5rem;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <input type="email" id="addUserEmail" name="addUserEmail" placeholder="Email" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                            <input type="password" id="addUserPassword" name="addUserPassword" placeholder="Password" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <input type="text" id="addUserName" name="addUserName" placeholder="Name" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                            <input type="text" id="addUserInitials" name="addUserInitials" placeholder="Initials" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <input type="text" id="addUserId" name="addUserId" placeholder="Student ID" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                            <input type="text" id="addUserPhone" name="addUserPhone" placeholder="Phone" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <input type="text" id="addUserEnrollment" name="addUserEnrollment" placeholder="Enrollment Year" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                            <input type="text" id="addUserGpa" name="addUserGpa" placeholder="GPA" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <select id="addUserYearLevel" name="addUserYearLevel" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                                <option value="P1">P1</option>
                                <option value="P2" selected>P2</option>
                                <option value="P3">P3</option>
                                <option value="P4">P4</option>
                            </select>
                            <input type="text" id="addUserYearLabel" name="addUserYearLabel" placeholder="Year Label (optional)" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <select id="addUserTemplate" name="addUserTemplate" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                                <option value="secondYear">Template: P2 style</option>
                                <option value="thirdYear" selected>Template: P3 style</option>
                            </select>
                            <button type="submit" class="btn" style="background: var(--primary); color: white; width:100%;">Add User</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div class="section-title">üì¨ Pending Signups</div>
                    <div id="pendingSignupsList" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
                </div>

                <div class="card" id="announcementAnalyticsCard" style="display: none;">
                    <div class="section-title">üìä Announcement Analytics</div>
                    <div id="analyticsOverview" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:0.75rem; margin-bottom:1rem;"></div>
                    <div id="analyticsDetails" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
                </div>

                <div class="card" id="adminAnnouncementsCard" style="display: none;">
                    <div class="section-title">üì¢ Manage Announcements</div>
                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
                        <button onclick="showAnnouncementTab('active')" id="activeAnnouncementsTab" class="btn" style="padding:0.5rem 1rem; background:#3b82f6; color:#fff; border:none; cursor:pointer; border-radius:0.5rem;">Active</button>
                        <button onclick="showAnnouncementTab('scheduled')" id="scheduledAnnouncementsTab" class="btn" style="padding:0.5rem 1rem; background:#e5e7eb; color:#374151; border:none; cursor:pointer; border-radius:0.5rem;">Scheduled</button>
                        <button onclick="showAnnouncementTab('archived')" id="archivedAnnouncementsTab" class="btn" style="padding:0.5rem 1rem; background:#e5e7eb; color:#374151; border:none; cursor:pointer; border-radius:0.5rem;">Archived</button>
                    </div>
                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
                        <button onclick="showAnnouncementTab('active')" id="activeAnnouncementsTab" class="btn" style="padding:0.5rem 1rem; background:#3b82f6; color:#fff;">Active</button>
                        <button onclick="showAnnouncementTab('scheduled')" id="scheduledAnnouncementsTab" class="btn" style="padding:0.5rem 1rem; background:#e5e7eb; color:#374151;">Scheduled</button>
                        <button onclick="showAnnouncementTab('archived')" id="archivedAnnouncementsTab" class="btn" style="padding:0.5rem 1rem; background:#e5e7eb; color:#374151;">Archived</button>
                    </div>
                    <div id="adminAnnouncementsList" style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;"></div>
                    <form id="addAnnouncementForm" onsubmit="handleAddAnnouncement(event)" style="display:flex; flex-direction:column; gap:0.5rem; padding:1rem; background:#f0fdf4; border-radius:0.5rem;">
                        <div style="font-weight:600; margin-bottom:0.5rem;">Create New Announcement</div>
                        <select id="announcementTarget" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                            <option value="">Select Target...</option>
                            <option value="all">All Students</option>
                            <option value="P1">Year 1 (P1)</option>
                            <option value="P2">Year 2 (P2)</option>
                            <option value="P3">Year 3 (P3)</option>
                            <option value="P4">Year 4 (P4)</option>
                            <option value="course">Specific Course</option>
                            <option value="specific">Specific Student</option>
                        </select>
                        <input type="email" id="announcementSpecificEmail" placeholder="Student email (if specific)" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem; display:none;">
                        <div id="announcementCourseField" style="display:none;">
                            <input type="text" id="announcementCourse" placeholder="Course code (e.g., PHRM 405)" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <select id="announcementType" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                                <option value="info">Info (Blue)</option>
                                <option value="warning">Warning (Yellow)</option>
                                <option value="danger">Urgent (Red)</option>
                            </select>
                            <select id="announcementPriority" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                                <option value="normal">Priority: Normal</option>
                                <option value="high">Priority: High ‚≠ê</option>
                            </select>
                        </div>
                        <select id="announcementCategory" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                            <option value="General">General</option>
                            <option value="Grades">Grades</option>
                            <option value="Assignments">Assignments</option>
                            <option value="Exams">Exams</option>
                            <option value="Quizzes">Quizzes</option>
                            <option value="Attendance">Attendance</option>
                            <option value="Advising">Advising</option>
                            <option value="Schedule">Schedule</option>
                        </select>
                        <input type="text" id="announcementTitle" placeholder="Announcement title" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        <textarea id="announcementMessage" placeholder="Announcement message" required style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem; min-height:80px; font-family:inherit;"></textarea>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <input type="date" id="announcementExpiry" placeholder="Expires On (optional)" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                            <input type="url" id="announcementLink" placeholder="Link (optional)" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem;">
                        </div>
                        <div style="display:flex; gap:0.5rem; align-items:center; padding:0.5rem; background:#fef3c7; border-radius:0.5rem;">
                            <input type="checkbox" id="announcementPinned" style="width:1.2rem; height:1.2rem; cursor:pointer;">
                            <label for="announcementPinned" style="flex:1; font-size:0.9rem; cursor:pointer;">üìå Pin to top</label>
                        </div>
                        <div id="announcementPinDaysField" style="display:none;">
                            <input type="number" id="announcementPinDays" placeholder="Pin for X days" min="0" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem; width:100%;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                            <div>
                                <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:0.25rem;">üìÖ Schedule Send (optional)</label>
                                <input type="datetime-local" id="announcementScheduled" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem; width:100%; font-size:0.85rem;">
                            </div>
                            <div>
                                <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:0.25rem;">üóÑÔ∏è Auto-archive after (days)</label>
                                <input type="number" id="announcementArchiveDays" placeholder="Never" min="0" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:0.5rem; width:100%;">
                            </div>
                        </div>
                        <button type="submit" id="announcementSubmitBtn" class="btn" style="background:var(--primary); color:white;">üì¢ Send Announcement</button>
                    </form>
                </div>

                <div class="card" style="background: #f9fafb;">
                    <div style="font-size: 0.75rem; color: var(--text-gray); text-align: center;">
                        <div><strong>Version:</strong> 2.0.0</div>
                        <div style="margin-top: 0.25rem;"><strong>Last Updated:</strong> Jan 2026</div>
                        <div style="margin-top: 0.5rem;">APPE Student Portal</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Page -->
        <div id="messagesPage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, #0891b2, #06b6d4);">
                <h1>üí¨ Messages</h1>
                <p>Chat with your advisor</p>
            </div>
            <div class="content">
                <div class="card">
                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                        <textarea id="messageInput" placeholder="Type message..." style="flex:1; padding:0.75rem; border:1px solid #e5e7eb; border-radius:0.5rem; height:60px; resize:none; font-family:inherit;"></textarea>
                        <button onclick="sendMessage()" class="btn" style="background:#0891b2; color:#fff; align-self:flex-start; padding:0.75rem 1.5rem;">Send</button>
                    </div>
                    <div id="messagesList" style="display:flex; flex-direction:column; gap:0.5rem; max-height:400px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analyticsPage" class="page hidden">
            <div class="header" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                <h1>üìä Analytics</h1>
                <p>Your performance dashboard</p>
            </div>
            <div class="content">
                <div class="card">
                    <div class="section-title">üìà Grade Statistics</div>
                    <div id="gradeStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:0.75rem; margin-bottom:1rem;"></div>
                    <div id="courseAnalytics" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
                </div>
                <div class="card">
                    <div class="section-title">üí° Performance Insights</div>
                    <div id="analyticsInsights" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->

        <nav class="bottom-nav">
            <button class="nav-item active" data-target="home" onclick="showPage('home', event)" aria-pressed="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span class="nav-label">Home</span>
            </button>
            <button class="nav-item" data-target="academic" onclick="showPage('academic', event)" aria-pressed="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                <span class="nav-label">Academic</span>
            </button>
            <button class="nav-item" data-target="clinical" onclick="showPage('clinical', event)" aria-pressed="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 7h-9M14 17H5M6 3v4M10 3v4M6 13v8M10 13v8"></path>
                    <circle cx="18" cy="17" r="3"></circle>
                </svg>
                <span class="nav-label">Clinical</span>
            </button>
            <button class="nav-item" data-target="messages" onclick="showPage('messages', event)" aria-pressed="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="nav-label">Messages</span>
            </button>
            <button class="nav-item" data-target="analytics" onclick="showPage('analytics', event)" aria-pressed="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="2" x2="12" y2="22"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                <span class="nav-label">Analytics</span>
            </button>
        </nav>

        <!-- More Menu Popup -->
        <div id="moreMenu" class="hidden" style="position: fixed; bottom: 70px; right: 1rem; background: white; border-radius: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 0.5rem; z-index: 1000; min-width: 200px;">
            <button onclick="showPage('profile', event); closeMoreMenu();" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem; background: none; border: none; border-radius: 0.5rem; cursor: pointer; text-align: left; font-size: 0.9rem;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                <span style="font-size: 1.25rem;">üë§</span>
                <span style="font-weight: 500;">Profile</span>
            </button>
            <button onclick="showPage('resources', event); closeMoreMenu();" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem; background: none; border: none; border-radius: 0.5rem; cursor: pointer; text-align: left; font-size: 0.9rem;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                <span style="font-size: 1.25rem;">üìö</span>
                <span style="font-weight: 500;">Resources</span>
            </button>
            <button onclick="showPage('settings', event); closeMoreMenu();" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem; background: none; border: none; border-radius: 0.5rem; cursor: pointer; text-align: left; font-size: 0.9rem;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                <span style="font-size: 1.25rem;">‚öôÔ∏è</span>
                <span style="font-weight: 500;">Settings</span>
            </button>
            <div style="height: 1px; background: #e5e7eb; margin: 0.5rem 0;"></div>
            <button onclick="logout(); closeMoreMenu();" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem; background: none; border: none; border-radius: 0.5rem; cursor: pointer; text-align: left; font-size: 0.9rem; color: #ef4444;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='transparent'">
                <span style="font-size: 1.25rem;">üö™</span>
                <span style="font-weight: 500;">Sign Out</span>
            </button>
        </div>
    </div>
    <input id="importClinicalInput" type="file" accept="application/json" style="display:none" aria-hidden="true">
    <input id="importAllData" type="file" accept="application/json" style="display:none" aria-hidden="true">
    
    <!-- Course Evaluation Modal -->
    <div id="evaluationModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 1rem; padding: 1.5rem; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.25rem;">üìù Course Evaluation</h2>
                <button onclick="closeEvaluationModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div id="evaluationCourseName" style="font-weight: 600; margin-bottom: 1.5rem; color: var(--text-gray);"></div>
            
            <form id="evaluationForm" onsubmit="submitCourseEvaluation(event)" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Overall Course Quality</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="radio" name="quality" value="5" id="q5" required style="cursor: pointer;">
                        <label for="q5" style="cursor: pointer;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</label>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="radio" name="quality" value="4" id="q4" style="cursor: pointer;">
                        <label for="q4" style="cursor: pointer;">‚≠ê‚≠ê‚≠ê‚≠ê Good</label>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="radio" name="quality" value="3" id="q3" style="cursor: pointer;">
                        <label for="q3" style="cursor: pointer;">‚≠ê‚≠ê‚≠ê Average</label>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="radio" name="quality" value="2" id="q2" style="cursor: pointer;">
                        <label for="q2" style="cursor: pointer;">‚≠ê‚≠ê Fair</label>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="radio" name="quality" value="1" id="q1" style="cursor: pointer;">
                        <label for="q1" style="cursor: pointer;">‚≠ê Poor</label>
                    </div>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Instructor Effectiveness</label>
                    <select name="instructor" required style="width: 100%; padding: 0.6rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                        <option value="">Select...</option>
                        <option value="excellent">Excellent - Very clear and engaging</option>
                        <option value="good">Good - Generally well organized</option>
                        <option value="average">Average - Adequate instruction</option>
                        <option value="fair">Fair - Could be improved</option>
                        <option value="poor">Poor - Needs significant improvement</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Course Materials & Resources</label>
                    <select name="materials" required style="width: 100%; padding: 0.6rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                        <option value="">Select...</option>
                        <option value="excellent">Excellent - Comprehensive and helpful</option>
                        <option value="good">Good - Adequate resources</option>
                        <option value="average">Average - Some gaps</option>
                        <option value="poor">Poor - Insufficient</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Difficulty Level</label>
                    <select name="difficulty" required style="width: 100%; padding: 0.6rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                        <option value="">Select...</option>
                        <option value="too-easy">Too Easy</option>
                        <option value="just-right">Just Right</option>
                        <option value="challenging">Challenging</option>
                        <option value="too-hard">Too Hard</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Additional Comments</label>
                    <textarea name="comments" placeholder="Share your feedback..." style="width: 100%; padding: 0.6rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; min-height: 100px; font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    <button type="submit" class="btn" style="flex: 1; background: var(--primary); color: white;">Submit Evaluation</button>
                    <button type="button" onclick="closeEvaluationModal()" class="btn" style="flex: 1; background: #e5e7eb; color: var(--text-dark);">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        const STORAGE_PREFIX = 'clinicalStateMobile:';

        const USERS_KEY = `${STORAGE_PREFIX}userDirectory`;
        const defaultYearLabels = { P1: 'First Year (P1)', P2: 'Second Year (P2)', P3: 'Third Year (P3)', P4: 'Fourth Year (P4)' };

        const baseUsers = {
            'second.year@student.edu': {
                password: 'second123',
                name: 'Maha Al-Qahtani',
                studentId: '442202102',
                phone: '+966501112233',
                gpa: '4.52',
                enrollmentYear: '2025',
                yearLabel: 'Second Year (P2)',
                yearLevel: 'P2',
                initials: 'MQ',
                template: 'secondYear'
            },
            'third.year@student.edu': {
                password: 'third123',
                name: 'Ahmed Al-Mansour',
                studentId: '442202001',
                phone: '+966501234567',
                gpa: '4.75',
                enrollmentYear: '2024',
                yearLabel: 'Third Year (P3)',
                yearLevel: 'P3',
                initials: 'AA',
                template: 'thirdYear'
            },
            'first.year@student.edu': {
                password: 'first123',
                name: 'Laila Al-Harbi',
                studentId: '452203001',
                phone: '+966501998877',
                gpa: '4.10',
                enrollmentYear: '2026',
                yearLabel: 'First Year (P1)',
                yearLevel: 'P1',
                initials: 'LH',
                template: 'secondYear'
            },
            'fourth.year@student.edu': {
                password: 'fourth123',
                name: 'Sara Al-Jaber',
                studentId: '422201234',
                phone: '+966502224455',
                gpa: '4.35',
                enrollmentYear: '2023',
                yearLabel: 'Fourth Year (P4)',
                yearLevel: 'P4',
                initials: 'SJ',
                template: 'thirdYear'
            },
            'alrashidm@ksau-hs.edu.sa': {
                password: 'ALRASHED',
                name: 'Admin Al-Rashid',
                studentId: 'ADMIN001',
                phone: '+966501234567',
                gpa: '4.90',
                enrollmentYear: '2020',
                yearLabel: 'Administrator',
                yearLevel: 'ADMIN',
                initials: 'AR',
                template: 'thirdYear',
                isAdmin: true
            }
        };

        let userDirectory = {};

        // Year-based academic catalog (from official study plan)
        const courseCatalog = {
            P1: {
                semester: 'Year 1',
                courses: [
                    { code: 'PHRB-301', name: 'Pharmacology I', credits: 4, status: 'Active' },
                    { code: 'PHRB-303', name: 'Medicinal Chemistry I', credits: 4, status: 'Active' },
                    { code: 'PHRB-305', name: 'Pharmaceutics I', credits: 3, status: 'Active' },
                    { code: 'PHRB-307', name: 'Pharmaceutical Calculations', credits: 2, status: 'Active' },
                    { code: 'PHRP-301', name: 'Introduction to Pharmacy', credits: 1, status: 'Active' },
                    { code: 'PHRC-302', name: 'Communication Skills', credits: 2, status: 'Active' },
                    { code: 'PHRC-303', name: 'Clinical Microbiology', credits: 2, status: 'Active' },
                    { code: 'PHRC-300', name: 'IPPE I (Longitudinal)', credits: 1, status: 'Active' }
                ],
                schedule: [],
                assignments: [],
                exams: [],
                quizzes: [],
                attendance: { lectures: { attended: 0, total: 0, percentage: 0 }, labs: { attended: 0, total: 0, percentage: 0 }, absences: [] },
                advisor: { name: 'Assigned Advisor', email: 'advisor@ksau-hs.edu.sa', phone: '', office: '', notes: [], actionItems: [] },
                documents: [],
                risks: [],
                recommendations: []
            },
            P2: {
                semester: 'Year 2',
                courses: [
                    { code: 'PHRC-401', name: 'Integrated Pharmacotherapy I', credits: 6, status: 'Active' },
                    { code: 'PHRC-403', name: 'Patient Assessment', credits: 2, status: 'Active' },
                    { code: 'PHRC-404', name: 'Self-Care and Non-Prescription Drugs', credits: 3, status: 'Active' },
                    { code: 'PHRC-405', name: 'Clinical Research Methodology', credits: 2, status: 'Active' },
                    { code: 'PHRC-406', name: 'Pharm.D. Research I (Longitudinal)', credits: 3, status: 'Active' },
                    { code: 'PHRC-400', name: 'IPPE II (Longitudinal)', credits: 10, status: 'Active' }
                ],
                schedule: [],
                assignments: [],
                exams: [],
                quizzes: [],
                attendance: { lectures: { attended: 0, total: 0, percentage: 0 }, labs: { attended: 0, total: 0, percentage: 0 }, absences: [] },
                advisor: { name: 'Assigned Advisor', email: 'advisor@ksau-hs.edu.sa', phone: '', office: '', notes: [], actionItems: [] },
                documents: [],
                risks: [],
                recommendations: []
            },
            P3: {
                semester: 'Year 3',
                courses: [
                    { code: 'PHRC-501', name: 'Integrated Pharmacotherapy III', credits: 6, status: 'Active' },
                    { code: 'PHRC-503', name: 'Pharmacogenetics / Pharmacogenomics', credits: 2, status: 'Active' },
                    { code: 'PHRC-504', name: 'Seminar', credits: 1, status: 'Active' },
                    { code: 'PHRC-511', name: 'Applied Pharmacokinetics', credits: 2, status: 'At Risk' },
                    { code: 'PHRC-516', name: 'Pharm.D. Research II (Longitudinal)', credits: 4, status: 'Active' },
                    { code: 'PHRC-500', name: 'IPPE III (Longitudinal)', credits: 10, status: 'Active' }
                ],
                schedule: [],
                assignments: [],
                exams: [],
                quizzes: [],
                attendance: { lectures: { attended: 0, total: 0, percentage: 0 }, labs: { attended: 0, total: 0, percentage: 0 }, absences: [] },
                advisor: { name: 'Assigned Advisor', email: 'advisor@ksau-hs.edu.sa', phone: '', office: '', notes: [], actionItems: [] },
                documents: [],
                risks: [],
                recommendations: []
            },
            P4: {
                semester: 'Year 4',
                courses: [
                    { code: 'PHRC-611', name: 'APPE I', credits: 4, status: 'Active' },
                    { code: 'PHRC-612', name: 'APPE II', credits: 4, status: 'Active' },
                    { code: 'PHRC-613', name: 'APPE III', credits: 4, status: 'Active' },
                    { code: 'PHRC-614', name: 'APPE IV', credits: 4, status: 'Active' },
                    { code: 'PHRC-615', name: 'APPE V', credits: 4, status: 'Active' },
                    { code: 'PHRC-616', name: 'APPE VI', credits: 4, status: 'Active' },
                    { code: 'PHRC-617', name: 'APPE VII', credits: 4, status: 'Active' },
                    { code: 'PHRC-618', name: 'APPE VIII', credits: 4, status: 'Active' },
                    { code: 'PHRC-619', name: 'APPE IX', credits: 4, status: 'Active' },
                    { code: 'PHRC-620', name: 'APPE X', credits: 4, status: 'Active' }
                ],
                schedule: [],
                assignments: [],
                exams: [],
                quizzes: [],
                attendance: { lectures: { attended: 0, total: 0, percentage: 0 }, labs: { attended: 0, total: 0, percentage: 0 }, absences: [] },
                advisor: { name: 'Assigned Advisor', email: 'advisor@ksau-hs.edu.sa', phone: '', office: '', notes: [], actionItems: [] },
                documents: [],
                risks: [],
                recommendations: []
            }
        };

        function cloneCourseCatalog(yearLevel) {
            const catalog = courseCatalog[yearLevel];
            return catalog ? JSON.parse(JSON.stringify(catalog)) : null;
        }

        function loadUserDirectory() {
            try {
                const stored = localStorage.getItem(USERS_KEY);
                if (stored) {
                    userDirectory = JSON.parse(stored);
                } else {
                    userDirectory = { ...baseUsers };
                }
            } catch (err) {
                // fall through to base users
                userDirectory = { ...baseUsers };
            }
            // ensure new seed users are added if missing
            let updated = false;
            Object.entries(baseUsers).forEach(([email, data]) => {
                if (!userDirectory[email]) {
                    userDirectory[email] = data;
                    updated = true;
                }
            });
            if (updated) {
                saveUserDirectory();
            }
        }

        function saveUserDirectory() {
            localStorage.setItem(USERS_KEY, JSON.stringify(userDirectory));
        }

        function renderUserList() {
            const listEl = document.getElementById('userList');
            if (!listEl) return;
            const entries = Object.entries(userDirectory || {});
            if (!entries.length) {
                listEl.innerHTML = '<div style="font-size:0.9rem; color:var(--text-gray);">No users configured.</div>';
                return;
            }
            const items = entries.map(([email, user]) => {
                const badge = user.yearLevel ? `<span style="background:#e5e7eb; padding:2px 8px; border-radius:999px; font-size:0.75rem;">${user.yearLevel}</span>` : '';
                return `
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:0.65rem 0; border-bottom:1px solid #f1f5f9;">
                        <div>
                            <div style="font-weight:600;">${user.name || 'Unnamed'}</div>
                            <div style="font-size:0.85rem; color:var(--text-gray);">${email}</div>
                            <div style="font-size:0.8rem; color:var(--text-gray); margin-top:2px;">${user.yearLabel || defaultYearLabels[user.yearLevel] || ''}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            ${badge}
                            <button onclick="deleteUser('${email.replace(/'/g, '')}')" class="btn" style="background:#fef2f2; color:#ef4444; padding:0.35rem 0.75rem;">Remove</button>
                        </div>
                    </div>`;
            }).join('');
            listEl.innerHTML = items;
        }

        function handleAddUser(event) {
            event.preventDefault();
            const form = event.target;
            const email = form.addUserEmail.value.trim().toLowerCase();
            const password = form.addUserPassword.value.trim();
            if (!email || !password) {
                showToast('Email and password are required');
                return;
            }
            const name = form.addUserName.value.trim() || email.split('@')[0];
            const studentId = form.addUserId.value.trim();
            const phone = form.addUserPhone.value.trim();
            const gpa = form.addUserGpa.value.trim();
            const enrollmentYear = form.addUserEnrollment.value.trim();
            const yearLevel = form.addUserYearLevel.value || 'P2';
            const yearLabel = form.addUserYearLabel.value.trim() || defaultYearLabels[yearLevel];
            const initials = form.addUserInitials.value.trim() || name.slice(0, 2).toUpperCase();
            const template = form.addUserTemplate.value || 'thirdYear';
            userDirectory[email] = { password, name, studentId, phone, gpa, enrollmentYear, yearLabel, yearLevel, initials, template };
            saveUserDirectory();
            renderUserList();
            form.reset();
            showToast('User added');
        }

        function deleteUser(email) {
            if (!email || !userDirectory[email]) return;
            if (currentUser && currentUser.email === email) {
                logout();
            }
            delete userDirectory[email];
            saveUserDirectory();
            renderUserList();
            showToast('User removed');
        }

        function renderPendingSignups() {
            const listEl = document.getElementById('pendingSignupsList');
            if (!listEl) return;
            const signupRequests = JSON.parse(localStorage.getItem('signupRequests') || '{}');
            const entries = Object.entries(signupRequests || {});
            if (!entries.length) {
                listEl.innerHTML = '<div style="font-size:0.9rem; color:var(--text-gray); padding:0.5rem;">No pending signup requests.</div>';
                return;
            }
            const items = entries.map(([email, data]) => {
                return `
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:0.65rem; background:#fef3c7; border-radius:0.5rem; border-left:3px solid #f59e0b;">
                        <div>
                            <div style="font-weight:600;">${data.name}</div>
                            <div style="font-size:0.85rem; color:var(--text-gray);">${email}</div>
                            <div style="font-size:0.8rem; color:var(--text-gray); margin-top:2px;">ID: ${data.studentId} | ${data.yearLevel}</div>
                        </div>
                        <div style="display:flex; gap:0.3rem;">
                            <button onclick="approveSignup('${email.replace(/'/g, '')}', '${data.name.replace(/'/g, '')}', '${data.studentId}', '${data.phone}', '${data.yearLevel}')" class="btn" style="background:#22c55e; color:white; padding:0.4rem 0.7rem; font-size:0.75rem;">Approve</button>
                            <button onclick="rejectSignup('${email.replace(/'/g, '')}')" class="btn" style="background:#ef4444; color:white; padding:0.4rem 0.7rem; font-size:0.75rem;">Reject</button>
                        </div>
                    </div>`;
            }).join('');
            listEl.innerHTML = items;
        }

        function approveSignup(email, name, studentId, phone, yearLevel) {
            const gpa = '0.00';
            const enrollmentYear = new Date().getFullYear();
            const yearLabel = defaultYearLabels[yearLevel] || yearLevel;
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const template = yearLevel === 'P1' ? 'secondYear' : yearLevel === 'P4' ? 'thirdYear' : yearLevel === 'P2' ? 'secondYear' : 'thirdYear';
            const password = Math.random().toString(36).substring(2, 10); // Generate random password
            
            userDirectory[email] = { password, name, studentId, phone, gpa, enrollmentYear, yearLabel, yearLevel, initials, template };
            saveUserDirectory();
            
            // Remove from signup requests
            const signupRequests = JSON.parse(localStorage.getItem('signupRequests') || '{}');
            delete signupRequests[email];
            localStorage.setItem('signupRequests', JSON.stringify(signupRequests));
            
            renderUserList();
            renderPendingSignups();
            showToast(`‚úÖ ${name} approved! Password: ${password}`);
        }

        function rejectSignup(email) {
            const signupRequests = JSON.parse(localStorage.getItem('signupRequests') || '{}');
            delete signupRequests[email];
            localStorage.setItem('signupRequests', JSON.stringify(signupRequests));
            renderPendingSignups();
            showToast('Signup request rejected');
        }

        function openCourseEvaluation(courseCode, courseName) {
            const modal = document.getElementById('evaluationModal');
            const courseNameEl = document.getElementById('evaluationCourseName');
            const form = document.getElementById('evaluationForm');
            
            modal.style.display = 'flex';
            courseNameEl.textContent = `${courseCode} - ${courseName}`;
            form.reset();
            form.dataset.courseCode = courseCode;
        }

        function closeEvaluationModal() {
            const modal = document.getElementById('evaluationModal');
            modal.style.display = 'none';
        }

        function submitCourseEvaluation(e) {
            e.preventDefault();
            const form = e.target;
            const courseCode = form.dataset.courseCode;
            const quality = form.quality.value;
            const instructor = form.instructor.value;
            const materials = form.materials.value;
            const difficulty = form.difficulty.value;
            const comments = form.comments.value;

            // Save evaluation to localStorage
            const evaluations = JSON.parse(localStorage.getItem('courseEvaluations') || '{}');
            if (!evaluations[courseCode]) evaluations[courseCode] = [];
            
            evaluations[courseCode].push({
                date: new Date().toISOString(),
                quality, instructor, materials, difficulty, comments,
                student: currentUser.email
            });
            
            localStorage.setItem('courseEvaluations', JSON.stringify(evaluations));
            
            showToast('‚úÖ Evaluation submitted successfully!');
            closeEvaluationModal();
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('evaluationModal');
            if (e.target === modal) {
                closeEvaluationModal();
            }
        });

        const clinicalTemplates = {
            secondYear: {
                hours: { today: 6, week: 30, rotation: 62, rotationTotal: 120, daily: [6, 6, 6, 6, 6] },
                attendance: {
                    present: 14,
                    total: 15,
                    professionalism: 4.6,
                    logs: [
                        { date: 'Jan 15, 2026', note: 'Great patient counseling', status: 'Excellent', archived: false },
                        { date: 'Jan 14, 2026', note: 'Participated in med safety briefing', status: 'Good', archived: false },
                        { date: 'Jan 13, 2026', note: 'Late by 5 minutes, stayed late', status: 'Acceptable', archived: false }
                    ]
                },
                activities: [
                    { title: 'Community Dispensing', detail: 'Processed 35 prescriptions | 2.0 hours', done: true },
                    { title: 'OTC Counseling', detail: 'Counseled 6 patients on OTC meds | 1.0 hour', done: true },
                    { title: 'Inventory Cycle Count', detail: 'Counted antibiotics shelf | 1.0 hour', done: false }
                ],
                ippes: [
                    { title: 'IPPE I - Community', site: 'Al-Ahli Pharmacy, Riyadh', hours: { completed: 120, total: 120 }, grade: 'A', color: '#3b82f6' },
                    { title: 'IPPE II - Foundations', site: 'University Simulation Labs', hours: { completed: 60, total: 100 }, grade: 'B+', color: '#a855f7' }
                ],
                academic: {
                    semester: 'Spring 2026',
                    cumulativeGpa: 4.52,
                    previousSemesterGpa: 4.48,
                    courses: [
                        { code: 'PHRM 301', name: 'Pharmacology II', credits: 4, grade: 'A', percentage: 92, instructor: 'Dr. Sarah Ahmed', status: 'Active' },
                        { code: 'PHRM 302', name: 'Medicinal Chemistry', credits: 3, grade: 'A-', percentage: 88, instructor: 'Dr. Mohammed Ali', status: 'Active' },
                        { code: 'PHRM 310', name: 'Pharmaceutics Lab', credits: 2, grade: 'A+', percentage: 96, instructor: 'Dr. Fatima Hassan', status: 'Active' },
                        { code: 'PHRM 320', name: 'Clinical Skills', credits: 3, grade: 'A', percentage: 90, instructor: 'Dr. Omar Abdullah', status: 'Active' }
                    ],
                    schedule: [
                        { day: 'Sunday', time: '08:00-10:00', course: 'PHRM 301', room: 'B201' },
                        { day: 'Sunday', time: '10:30-12:00', course: 'PHRM 302', room: 'A105' },
                        { day: 'Monday', time: '09:00-12:00', course: 'PHRM 310', room: 'Lab 3' },
                        { day: 'Tuesday', time: '08:00-10:00', course: 'PHRM 320', room: 'C303' },
                        { day: 'Wednesday', time: '08:00-10:00', course: 'PHRM 301', room: 'B201' },
                        { day: 'Thursday', time: '10:00-12:00', course: 'PHRM 302', room: 'A105' }
                    ],
                    assignments: [
                        { course: 'PHRM 301', title: 'Drug Interaction Case Study', due: '2026-01-20', status: 'pending' },
                        { course: 'PHRM 302', title: 'Structure-Activity Analysis', due: '2026-01-22', status: 'pending' },
                        { course: 'PHRM 320', title: 'Patient Counseling Video', due: '2026-01-25', status: 'submitted' }
                    ],
                    exams: [
                        { course: 'PHRM 301', title: 'Midterm Exam', date: '2026-01-22', type: 'Written', status: 'Upcoming' },
                        { course: 'PHRM 310', title: 'Lab Practical', date: '2026-01-25', type: 'OSCE', status: 'Upcoming' }
                    ],
                    quizzes: [
                        { course: 'PHRM 302', title: 'Quiz 3', date: '2026-01-15', score: 18, total: 20, feedback: 'Good understanding of core concepts' },
                        { course: 'PHRM 320', title: 'Communication OSCE', date: '2026-01-14', score: 48, total: 50, feedback: 'Excellent patient interaction' }
                    ],
                    attendance: {
                        lectures: { attended: 42, total: 45, percentage: 93 },
                        labs: { attended: 18, total: 18, percentage: 100 },
                        absences: [
                            { date: '2026-01-10', type: 'Lecture', course: 'PHRM 301', reason: 'Medical appointment', justified: true },
                            { date: '2026-01-08', type: 'Lecture', course: 'PHRM 302', reason: 'Family emergency', justified: true }
                        ]
                    },
                    advisor: {
                        name: 'Dr. Nadia Al-Shareef',
                        email: 'n.alshareef@ksau-hs.edu.sa',
                        phone: '+966 11 429 4444',
                        office: 'Building A, Room 305',
                        notes: [
                            { date: '2026-01-10', note: 'Discussed course selection for next semester. Recommended advanced therapeutics.' },
                            { date: '2025-12-15', note: 'Reviewed fall semester performance. Encouraged to maintain strong GPA.' }
                        ],
                        actionItems: [
                            { task: 'Submit elective preferences by Jan 25', status: 'pending' },
                            { task: 'Schedule research project meeting', status: 'pending' }
                        ]
                    },
                    documents: [
                        { name: 'Spring 2026 Course Syllabi', type: 'PDF', date: '2026-01-05' },
                        { name: 'Academic Study Plan', type: 'PDF', date: '2025-09-01' },
                        { name: 'Final Exam Schedule', type: 'PDF', date: '2026-01-12' }
                    ],
                    risks: [],
                    recommendations: []
                },
                ui: { ippesCollapsed: false },
                settings: {
                    notifications: { hours: true, alerts: true, activities: true },
                    goals: { weeklyHours: 40, dailyActivities: 3 }
                }
            },
            thirdYear: {
                hours: {
                    today: 8.5,
                    week: 38.5,
                    rotation: 88,
                    rotationTotal: 160,
                    daily: [8, 8, 8, 8, 6.5]
                },
                attendance: {
                    present: 18,
                    total: 20,
                    professionalism: 4.8,
                    logs: [
                        { date: 'Jan 16, 2026', note: 'Arrived on time, completed all tasks, great teamwork', status: 'Good', archived: false },
                        { date: 'Jan 15, 2026', note: 'Excellent communication with patients', status: 'Excellent', archived: false },
                        { date: 'Jan 14, 2026', note: 'Minor delay due to traffic, made up time', status: 'Acceptable', archived: false }
                    ]
                },
                activities: [
                    { title: 'Patient Consultation & Counseling', detail: 'Counseled 8 patients | 2.5 hours', done: true },
                    { title: 'Drug Information Preparation', detail: 'Prepared 3 drug information sheets | 2 hours', done: true },
                    { title: 'Inventory Management', detail: 'Updated pharmaceutical inventory | 1.5 hours', done: true },
                    { title: 'Interprofessional Collaboration', detail: 'Attend patient case conference - Friday', done: false }
                ],
                ippes: [
                    {
                        title: 'IPPE I - Year 1 (Community)',
                        site: 'Al-Ahli Pharmacy, Riyadh',
                        hours: { completed: 150, total: 150 },
                        grade: 'A',
                        color: '#a855f7'
                    },
                    {
                        title: 'IPPE II - Year 2 (Hospital/Clinic)',
                        site: 'King Abdulaziz Medical City Hospital, Jeddah',
                        hours: { completed: 150, total: 150 },
                        grade: 'A+',
                        color: '#3b82f6'
                    }
                ],
                academic: {
                    semester: 'Spring 2026',
                    cumulativeGpa: 4.75,
                    previousSemesterGpa: 4.68,
                    courses: [
                        { code: 'PHRM 401', name: 'Advanced Therapeutics', credits: 4, grade: 'A+', percentage: 95, instructor: 'Dr. Khalid Rahman', status: 'Active' },
                        { code: 'PHRM 405', name: 'Pharmacokinetics', credits: 3, grade: 'B+', percentage: 78, instructor: 'Dr. Layla Mansour', status: 'At Risk' },
                        { code: 'PHRM 410', name: 'Clinical Pharmacy Practice', credits: 4, grade: 'A', percentage: 91, instructor: 'Dr. Ahmed Youssef', status: 'Active' },
                        { code: 'PHRM 420', name: 'Pharmacy Management', credits: 3, grade: 'A-', percentage: 89, instructor: 'Dr. Nora Salem', status: 'Active' },
                        { code: 'PHRM 425', name: 'Research Methods', credits: 2, grade: 'A+', percentage: 97, instructor: 'Dr. Hassan Ibrahim', status: 'Active' }
                    ],
                    schedule: [
                        { day: 'Sunday', time: '08:00-10:00', course: 'PHRM 401', room: 'A301' },
                        { day: 'Sunday', time: '11:00-13:00', course: 'PHRM 405', room: 'B205' },
                        { day: 'Monday', time: '09:00-11:00', course: 'PHRM 410', room: 'Clinical Center' },
                        { day: 'Tuesday', time: '08:00-10:00', course: 'PHRM 420', room: 'C402' },
                        { day: 'Wednesday', time: '10:00-12:00', course: 'PHRM 425', room: 'Research Lab' },
                        { day: 'Thursday', time: '08:00-11:00', course: 'PHRM 410', room: 'Clinical Center' }
                    ],
                    assignments: [
                        { course: 'PHRM 401', title: 'Hypertension Treatment Protocol', due: '2026-01-18', status: 'submitted' },
                        { course: 'PHRM 405', title: 'PK/PD Modeling Project', due: '2026-01-21', status: 'pending' },
                        { course: 'PHRM 425', title: 'Literature Review Draft', due: '2026-01-24', status: 'pending' },
                        { course: 'PHRM 410', title: 'Clinical Case Presentation', due: '2026-01-27', status: 'pending' }
                    ],
                    exams: [
                        { course: 'PHRM 405', title: 'Pharmacokinetics Midterm', date: '2026-01-20', type: 'Written', status: 'Upcoming' },
                        { course: 'PHRM 410', title: 'Clinical Assessment OSCE', date: '2026-01-28', type: 'OSCE', status: 'Upcoming' }
                    ],
                    quizzes: [
                        { course: 'PHRM 405', title: 'Quiz 4 - Clearance', date: '2026-01-15', score: 14, total: 20, feedback: 'Review volume of distribution concepts' },
                        { course: 'PHRM 401', title: 'Diabetes Management Quiz', date: '2026-01-13', score: 19, total: 20, feedback: 'Excellent application of guidelines' }
                    ],
                    attendance: {
                        lectures: { attended: 38, total: 42, percentage: 90 },
                        labs: { attended: 15, total: 16, percentage: 94 },
                        absences: [
                            { date: '2026-01-12', type: 'Lecture', course: 'PHRM 405', reason: 'Illness', justified: false },
                            { date: '2026-01-09', type: 'Lab', course: 'PHRM 410', reason: 'Medical appointment', justified: true },
                            { date: '2026-01-05', type: 'Lecture', course: 'PHRM 420', reason: 'Illness', justified: true }
                        ]
                    },
                    advisor: {
                        name: 'Dr. Ibrahim Al-Zahrani',
                        email: 'i.alzahrani@ksau-hs.edu.sa',
                        phone: '+966 11 429 5555',
                        office: 'Building A, Room 402',
                        notes: [
                            { date: '2026-01-15', note: 'Discussed PHRM 405 performance. Recommended tutoring sessions and extra practice problems.' },
                            { date: '2026-01-08', note: 'Reviewed graduation requirements. On track for May 2027 graduation.' }
                        ],
                        actionItems: [
                            { task: 'Attend PHRM 405 review sessions (Tues/Thurs 4pm)', status: 'pending' },
                            { task: 'Complete graduation application by Feb 1', status: 'pending' },
                            { task: 'Meet with research advisor for thesis update', status: 'completed' }
                        ]
                    },
                    documents: [
                        { name: 'Spring 2026 Course Syllabi', type: 'PDF', date: '2026-01-05' },
                        { name: 'Academic Study Plan - Year 3', type: 'PDF', date: '2025-09-01' },
                        { name: 'Final Exam Schedule', type: 'PDF', date: '2026-01-12' },
                        { name: 'Graduation Requirements Checklist', type: 'PDF', date: '2026-01-08' }
                    ],
                    risks: [
                        { course: 'PHRM 405 - Pharmacokinetics', reason: 'Current grade B+ (78%). Below expected performance.', severity: 'Medium' }
                    ],
                    recommendations: [
                        { title: 'Pharmacokinetics Study Guide', description: 'Interactive PK/PD calculations with practice problems', link: '#' },
                        { title: 'Tutoring Sessions', description: 'One-on-one tutoring available Tues/Thurs 4-6pm in Learning Center', link: '#' },
                        { title: 'Khan Academy: Pharmacokinetics', description: 'Video tutorials on clearance, volume of distribution, and dosing', link: '#' }
                    ]
                },
                ui: {
                    ippesCollapsed: false
                },
                settings: {
                    notifications: { hours: true, alerts: true, activities: true },
                    goals: { weeklyHours: 40, dailyActivities: 3 }
                }
            }
        };

        let toastEl = null;
        let clinicalState = null;
        let currentUser = null;
        let editActivityIndex = null;
        let editAttendanceIndex = null;
        let academicAnnouncementsFilter = 'All';
        let editingAnnouncementIndex = null;
        let announcementTab = 'active';
        let currentConversation = null; // For messaging

        function cloneTemplate(key) {
            return JSON.parse(JSON.stringify(clinicalTemplates[key] || clinicalTemplates.thirdYear));
        }

        function getUserStorageKey(email) {
            return `${STORAGE_PREFIX}${email.toLowerCase()}`;
        }

        function loadStateForUser(user) {
            const key = getUserStorageKey(user.email);
            let state;
            try {
                const stored = localStorage.getItem(key);
                state = stored ? JSON.parse(stored) : cloneTemplate(user.template);
            } catch (err) {
                state = cloneTemplate(user.template);
            }
            const catalog = cloneCourseCatalog(user.yearLevel);
            console.log('Loading state for user:', user.email, 'yearLevel:', user.yearLevel, 'catalog:', catalog);
            if (catalog) {
                // Preserve existing academic data but override with catalog courses
                const existingAcademic = state.academic || {};
                state.academic = {
                    semester: catalog.semester || existingAcademic.semester || 'Current Semester',
                    cumulativeGpa: typeof existingAcademic.cumulativeGpa === 'number' ? existingAcademic.cumulativeGpa : 0,
                    previousSemesterGpa: typeof existingAcademic.previousSemesterGpa === 'number' ? existingAcademic.previousSemesterGpa : 0,
                    courses: (catalog.courses || []).map(course => ({
                        ...course,
                        credits: course.credits || 0,
                        percentage: course.percentage ?? 0,
                        grade: (course.grade || course.grade === 0) ? course.grade : 'IP',
                        instructor: course.instructor || 'TBD',
                        status: course.status || 'Active'
                    })),
                    schedule: existingAcademic.schedule || catalog.schedule || [],
                    assignments: existingAcademic.assignments || catalog.assignments || [],
                    exams: existingAcademic.exams || catalog.exams || [],
                    quizzes: existingAcademic.quizzes || catalog.quizzes || [],
                    attendance: existingAcademic.attendance || catalog.attendance || { lectures: { attended: 0, total: 0, percentage: 0 }, labs: { attended: 0, total: 0, percentage: 0 }, absences: [] },
                    advisor: existingAcademic.advisor || catalog.advisor || { name: 'Assigned Advisor', email: '', phone: '', office: '', notes: [], actionItems: [] },
                    documents: existingAcademic.documents || catalog.documents || [],
                    risks: existingAcademic.risks || catalog.risks || [],
                    recommendations: existingAcademic.recommendations || catalog.recommendations || []
                };
                console.log('Academic state after catalog merge:', state.academic);
            } else {
                console.warn('No catalog found for year level:', user.yearLevel);
            }
            return state;
        }

        function saveState() {
            if (!currentUser) return;
            localStorage.setItem(getUserStorageKey(currentUser.email), JSON.stringify(clinicalState));
        }

        function setProfile(user) {
            const nameEl = document.getElementById('profileName');
            const idEl = document.getElementById('profileId');
            const emailEl = document.getElementById('profileEmail');
            const phoneEl = document.getElementById('profilePhone');
            const gpaEl = document.getElementById('profileGpa');
            const enrollEl = document.getElementById('profileEnrollment');
            const initialsEl = document.getElementById('profileInitials');
            const yearEl = document.getElementById('profileYear');
            if (nameEl) nameEl.textContent = user.name;
            if (idEl) idEl.textContent = user.studentId;
            if (emailEl) emailEl.textContent = user.email;
            if (phoneEl) phoneEl.textContent = user.phone;
            if (gpaEl) gpaEl.textContent = user.gpa;
            if (enrollEl) enrollEl.textContent = user.enrollmentYear;
            if (initialsEl) initialsEl.textContent = user.initials;
            if (yearEl) yearEl.textContent = user.yearLabel;
        }

        // Initialize on page load
        console.log('Script starting...');
        loadUserDirectory();
        console.log('User directory loaded:', Object.keys(userDirectory));

        function switchLoginTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabSignIn = document.getElementById('tabSignIn');
            const tabSignUp = document.getElementById('tabSignUp');
            
            if (tab === 'signin') {
                loginForm.classList.remove('hidden');
                loginForm.style.display = 'block';
                signupForm.classList.add('hidden');
                signupForm.style.display = 'none';
                tabSignIn.style.background = 'var(--primary)';
                tabSignIn.style.color = 'white';
                tabSignUp.style.background = '#e5e7eb';
                tabSignUp.style.color = 'var(--text-dark)';
            } else {
                loginForm.classList.add('hidden');
                loginForm.style.display = 'none';
                signupForm.classList.remove('hidden');
                signupForm.style.display = 'block';
                tabSignIn.style.background = '#e5e7eb';
                tabSignIn.style.color = 'var(--text-dark)';
                tabSignUp.style.background = 'var(--primary)';
                tabSignUp.style.color = 'white';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize toast element now that DOM is ready
            toastEl = document.getElementById('toast');
            
            console.log('DOM loaded, initializing...');
            loadUserDirectory();  // Load users from localStorage or use baseUsers
            renderUserList();
            
            // Helper: announcements filter setter
            window.setAnnouncementFilter = function(category) {
                academicAnnouncementsFilter = category;
                renderAcademic();
            };

            // Announcement form: show/hide conditional fields
            const targetSelect = document.getElementById('announcementTarget');
            const pinnedCheckbox = document.getElementById('announcementPinned');
            
            if (targetSelect) {
                targetSelect.addEventListener('change', function() {
                    const specificField = document.getElementById('announcementSpecificEmail');
                    const courseField = document.getElementById('announcementCourseField');
                    specificField.style.display = this.value === 'specific' ? 'block' : 'none';
                    courseField.style.display = this.value === 'course' ? 'block' : 'none';
                });
            }
            
            if (pinnedCheckbox) {
                pinnedCheckbox.addEventListener('change', function() {
                    const pinDaysField = document.getElementById('announcementPinDaysField');
                    pinDaysField.style.display = this.checked ? 'block' : 'none';
                });
            }

            // Login
            const loginForm = document.getElementById('loginForm');
            console.log('Login form:', loginForm);
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Login form submitted');
                    const emailInput = document.getElementById('emailInput');
                    const passwordInput = document.getElementById('passwordInput');
                    const email = emailInput?.value?.trim().toLowerCase();
                    const password = passwordInput?.value?.trim();
                    console.log('Login attempt:', email);
                    const user = email ? userDirectory[email] : null;
                    console.log('User found:', user);
                    if (!user || user.password !== password) {
                        showToast('Invalid email or password');
                        return;
                    }
                    currentUser = { ...user, email };
                    clinicalState = loadStateForUser(currentUser);
                    setProfile(currentUser);
                    updateWelcome(currentUser);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    showPage('home');
                    renderDashboard();
                });
            } else {
                console.error('Login form not found!');
            }

            // Signup
            const signupForm = document.getElementById('signupForm');
            if (signupForm) {
                signupForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Signup form submitted');
                    const name = document.getElementById('signupName')?.value?.trim();
                    const email = document.getElementById('signupEmail')?.value?.trim().toLowerCase();
                    const studentId = document.getElementById('signupStudentId')?.value?.trim();
                    const phone = document.getElementById('signupPhone')?.value?.trim();
                    const yearLevel = document.getElementById('signupYearLevel')?.value;
                    
                    if (!name || !email || !studentId || !phone || !yearLevel) {
                        showToast('Please fill in all fields');
                        return;
                    }

                    // Save signup request to localStorage
                    const signupRequests = JSON.parse(localStorage.getItem('signupRequests') || '{}');
                    signupRequests[email] = { name, email, studentId, phone, yearLevel, timestamp: new Date().toISOString() };
                    localStorage.setItem('signupRequests', JSON.stringify(signupRequests));

                    // Send to admin via Formspree
                    fetch('https://formspree.io/f/xyzabc', { // Replace xyzabc with your Formspree form ID
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, studentId, phone, yearLevel })
                    }).catch(() => {
                        // Formspree not configured, show manual instruction
                        console.log('Email to admin: ca-cop@ksau-hs.edu.sa');
                    });

                    const msgEl = document.getElementById('signupMessage');
                    msgEl.style.display = 'block';
                    msgEl.style.background = '#dcfce7';
                    msgEl.style.color = '#166534';
                    msgEl.innerHTML = `
                        ‚úÖ <strong>Request Sent!</strong><br>
                        Your signup request has been submitted.<br>
                        You will receive an email at <strong>${email}</strong> once approved.<br>
                        <span style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">Request ID: ${email}</span>
                    `;
                    
                    signupForm.reset();
                    setTimeout(() => {
                        msgEl.style.display = 'none';
                        switchLoginTab('signin');
                    }, 3000);
                });
            }
        });

        // Navigation
        function showPage(pageName, evt) {
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.classList.add('hidden');
            });
            const target = document.getElementById(pageName + 'Page');
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('active');
            }

            document.querySelectorAll('.nav-item').forEach(btn => {
                const isActive = btn.dataset.target === pageName;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive);
            });

            if (pageName === 'clinical') {
                renderClinical();
            } else if (pageName === 'home') {
                renderDashboard();
            } else if (pageName === 'academic') {
                processScheduledAnnouncements();
                processAutoArchive();
                renderAcademic();
            } else if (pageName === 'settings') {
                renderPendingSignups();
                processScheduledAnnouncements();
                processAutoArchive();
                renderAdminAnnouncements();
                renderAnnouncementAnalytics();
            } else if (pageName === 'profile') {
                loadNotificationPreferences();
            } else if (pageName === 'messages') {
                renderMessages();
            } else if (pageName === 'analytics') {
                renderGradeAnalytics();
            }
        }

        function showToast(message) {
            if (!toastEl) return;
            toastEl.textContent = message;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 2000);
        }

        function toggleMoreMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.toggle('hidden');
        }

        function closeMoreMenu() {
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.add('hidden');
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('moreMenu');
            const moreBtn = e.target.closest('[onclick*="toggleMoreMenu"]');
            if (menu && !menu.contains(e.target) && !moreBtn) {
                menu.classList.add('hidden');
            }
        });

        function saveSettings() {
            if (!clinicalState) return;
            const weeklyGoal = document.getElementById('weeklyGoal')?.value;
            const activityGoal = document.getElementById('activityGoal')?.value;
            const notifHours = document.getElementById('notifHours')?.checked;
            const notifAlerts = document.getElementById('notifAlerts')?.checked;
            const notifActivities = document.getElementById('notifActivities')?.checked;
            
            if (!clinicalState.settings) clinicalState.settings = { notifications: {}, goals: {} };
            clinicalState.settings.goals = {
                weeklyHours: parseInt(weeklyGoal) || 40,
                dailyActivities: parseInt(activityGoal) || 3
            };
            clinicalState.settings.notifications = {
                hours: notifHours !== false,
                alerts: notifAlerts !== false,
                activities: notifActivities !== false
            };
            saveState();
            renderPendingSignups();
            renderAdminAnnouncements();
            showToast('Settings saved');
            renderDashboard();
        }

        // Admin announcements management
        function loadAnnouncementsForUser() {
            if (!currentUser) return [];
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            const dismissed = getDismissedAnnouncementsForUser();
            const now = new Date();
            return allAnnouncements.filter(a => {
                // Filter out unpublished scheduled announcements
                if (a.published === false) return false;
                // Filter out archived announcements
                if (a.archived) return false;
                // Filter by target
                if (a.target === 'all') {} else if (a.target === currentUser.yearLevel) {} else if (a.target === 'specific' && a.specificEmail === currentUser.email) {} else if (a.target === 'course') {
                    // Check if student is enrolled in the specific course
                    if (!clinicalState?.academic?.courses) return false;
                    const enrolled = clinicalState.academic.courses.some(c => c.code === a.courseCode);
                    if (!enrolled) return false;
                } else { return false; }
                // Expiry check
                if (a.expiresOn) {
                    const exp = new Date(a.expiresOn);
                    if (isNaN(exp.getTime()) === false && exp < now) return false;
                }
                // Dismissed check
                if (a.id && dismissed.includes(a.id)) return false;
                return true;
            }).map(a => {
                // Track view
                trackAnnouncementView(a.id);
                return {
                    id: a.id || null,
                    icon: a.type === 'danger' ? 'üö®' : a.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è',
                    text: `${a.title}: ${a.message}`,
                    type: a.type,
                    category: a.category || 'General',
                    isAdmin: true,
                    link: a.link || null,
                    priority: a.priority || 'normal',
                    pinned: a.pinned || false,
                    pinnedUntil: a.pinnedUntil || null
                };
            });
        }

        function renderAdminAnnouncements() {
            const card = document.getElementById('adminAnnouncementsCard');
            const listEl = document.getElementById('adminAnnouncementsList');
            
            if (!currentUser || !currentUser.isAdmin) {
                if (card) card.style.display = 'none';
                return;
            }
            
            if (card) card.style.display = 'block';
            
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            
            // Filter based on tab
            let filtered;
            if (announcementTab === 'scheduled') {
                filtered = allAnnouncements.filter(a => a.scheduledFor && !a.published);
            } else if (announcementTab === 'archived') {
                filtered = allAnnouncements.filter(a => a.archived);
            } else {
                // active
                filtered = allAnnouncements.filter(a => (a.published !== false) && !a.archived);
            }
            
            if (!listEl) return;
            
            if (filtered.length === 0) {
                listEl.innerHTML = `<div style="color:var(--text-gray); font-size:0.9rem; padding:0.5rem;">No ${announcementTab} announcements.</div>`;
                return;
            }
            
            listEl.innerHTML = filtered.map((announcement, idx) => {
                const actualIndex = allAnnouncements.indexOf(announcement);
                const bgColor = announcement.type === 'danger' ? '#fee2e2' : announcement.type === 'warning' ? '#fef3c7' : '#dbeafe';
                const textColor = announcement.type === 'danger' ? '#991b1b' : announcement.type === 'warning' ? '#92400e' : '#1e40af';
                const targetLabel = announcement.target === 'all' ? 'All Students' : 
                                   announcement.target === 'specific' ? announcement.specificEmail :
                                   announcement.target === 'course' ? `Course: ${announcement.courseCode}` :
                                   `Year ${announcement.target}`;
                const expInfo = announcement.expiresOn ? ` | ‚è≥ Expires: ${announcement.expiresOn}` : '';
                const pinInfo = announcement.pinned ? ` | üìå Pinned` : '';
                const scheduledInfo = announcement.scheduledFor ? ` | ‚è∞ Scheduled: ${new Date(announcement.scheduledFor).toLocaleString()}` : '';
                const archiveInfo = announcement.archiveOn ? ` | üóÑÔ∏è Auto-archive: ${new Date(announcement.archiveOn).toLocaleString()}` : '';
                const linkBtn = announcement.link ? `<a href=\"${announcement.link}\" target=\"_blank\" style=\"font-size:0.85rem; color:${textColor}; text-decoration:underline;\">Open Link</a>` : '';
                const priorityTag = announcement.priority === 'high' ? '‚≠ê ' : '';
                
                // Get analytics
                const analytics = JSON.parse(localStorage.getItem('announcementAnalytics') || '{}');
                const stats = analytics[announcement.id] || { views: {}, dismissals: [] };
                const viewCount = Object.keys(stats.views).length;
                const dismissCount = stats.dismissals.length;
                
                return `
                    <div style="padding:0.75rem; background:${bgColor}; border-radius:0.5rem; border-left:3px solid ${textColor};">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.5rem;">
                            <div style="flex:1;">
                                <div style="font-weight:700; color:${textColor}; margin-bottom:0.25rem;">${priorityTag}${announcement.title}</div>
                                <div style="font-size:0.85rem; color:${textColor};">${announcement.message}</div>
                                <div style="font-size:0.75rem; color:var(--text-gray); margin-top:0.5rem;">
                                    üìç ${targetLabel} | üìÇ ${announcement.category} | üïí ${new Date(announcement.timestamp).toLocaleString()}${expInfo}${pinInfo}${scheduledInfo}${archiveInfo}
                                </div>
                                <div style="font-size:0.75rem; color:var(--text-gray); margin-top:0.25rem;">
                                    üëÅÔ∏è ${viewCount} views | üö´ ${dismissCount} dismissed
                                </div>
                                <div style="margin-top:0.35rem; display:flex; gap:0.5rem;">${linkBtn}<button onclick="editAnnouncement(${actualIndex})" style="font-size:0.85rem; padding:0.25rem 0.5rem; background:#3b82f6; color:#fff; border:none; border-radius:0.25rem; cursor:pointer;">Edit</button></div>
                            </div>
                            <button onclick="deleteAnnouncement(${actualIndex})" style="background:none; border:none; color:#ef4444; font-size:1.2rem; cursor:pointer; padding:0.25rem;">‚úï</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editAnnouncement(index) {
            if (!currentUser || !currentUser.isAdmin) return;
            
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            const a = allAnnouncements[index];
            
            // Populate form
            document.getElementById('announcementTarget').value = a.target;
            document.getElementById('announcementType').value = a.type;
            document.getElementById('announcementPriority').value = a.priority;
            document.getElementById('announcementCategory').value = a.category;
            document.getElementById('announcementTitle').value = a.title;
            document.getElementById('announcementMessage').value = a.message;
            document.getElementById('announcementExpiry').value = a.expiresOn || '';
            document.getElementById('announcementLink').value = a.link || '';
            document.getElementById('announcementPinned').checked = a.pinned || false;
            
            // Show conditional fields
            if (a.target === 'specific') {
                document.getElementById('announcementSpecificEmail').style.display = 'block';
                document.getElementById('announcementSpecificEmail').value = a.specificEmail || '';
            }
            if (a.target === 'course') {
                document.getElementById('announcementCourseField').style.display = 'block';
                document.getElementById('announcementCourse').value = a.courseCode || '';
            }
            if (a.pinned) {
                document.getElementById('announcementPinDaysField').style.display = 'block';
                if (a.pinnedUntil) {
                    const days = Math.ceil((new Date(a.pinnedUntil) - new Date()) / (1000 * 60 * 60 * 24));
                    document.getElementById('announcementPinDays').value = days > 0 ? days : 0;
                }
            }
            
            // Set edit mode
            editingAnnouncementIndex = index;
            document.getElementById('announcementSubmitBtn').textContent = 'Update Announcement';
            
            // Scroll to form
            document.getElementById('announcementForm').scrollIntoView({ behavior: 'smooth' });
        }

        function handleAddAnnouncement(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Admin-only action');
                return;
            }
            
            const target = document.getElementById('announcementTarget').value;
            const specificEmail = document.getElementById('announcementSpecificEmail').value.trim().toLowerCase();
            const courseCode = document.getElementById('announcementCourse').value.trim();
            const type = document.getElementById('announcementType').value;
            const priority = document.getElementById('announcementPriority').value;
            const category = document.getElementById('announcementCategory').value;
            const title = document.getElementById('announcementTitle').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            const expiresOn = document.getElementById('announcementExpiry').value;
            const link = document.getElementById('announcementLink').value.trim();
            const pinned = document.getElementById('announcementPinned').checked;
            const pinDays = parseInt(document.getElementById('announcementPinDays').value) || 0;
            const scheduledFor = document.getElementById('announcementScheduled').value;
            const archiveDays = parseInt(document.getElementById('announcementArchiveDays').value) || 0;
            
            if (!target || !type || !category || !title || !message) {
                showToast('Please fill all fields');
                return;
            }
            
            if (target === 'specific' && !specificEmail) {
                showToast('Please enter student email');
                return;
            }
            
            if (target === 'course' && !courseCode) {
                showToast('Please enter course code');
                return;
            }
            
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            
            // Calculate pinned until date
            let pinnedUntil = null;
            if (pinned && pinDays > 0) {
                const until = new Date();
                until.setDate(until.getDate() + pinDays);
                pinnedUntil = until.toISOString();
            }
            
            // Calculate archive date
            let archiveOn = null;
            if (archiveDays > 0) {
                const archiveDate = new Date();
                archiveDate.setDate(archiveDate.getDate() + archiveDays);
                archiveOn = archiveDate.toISOString();
            }
            
            const announcement = {
                id: null,
                target,
                specificEmail: target === 'specific' ? specificEmail : null,
                courseCode: target === 'course' ? courseCode : null,
                type,
                priority,
                category,
                title,
                message,
                link: link || null,
                expiresOn: expiresOn || null,
                pinned,
                pinnedUntil,
                scheduledFor: scheduledFor || null,
                archiveOn,
                archived: false,
                published: scheduledFor ? false : true, // Only publish if not scheduled
                timestamp: new Date().toISOString(),
                createdBy: currentUser.email
            };
            
            if (editingAnnouncementIndex !== null) {
                // Update existing announcement
                announcement.id = allAnnouncements[editingAnnouncementIndex].id;
                allAnnouncements[editingAnnouncementIndex] = announcement;
                editingAnnouncementIndex = null;
                showToast('üì¢ Announcement updated!');
            } else {
                // Create new announcement
                announcement.id = 'ann_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
                allAnnouncements.push(announcement);
                showToast('üì¢ Announcement sent!');
                
                // Send email notification (Formspree stub)
                sendAnnouncementEmail(announcement);
            }
            
            localStorage.setItem('adminAnnouncements', JSON.stringify(allAnnouncements));
            
            e.target.reset();
            document.getElementById('announcementSpecificEmail').style.display = 'none';
            document.getElementById('announcementCourseField').style.display = 'none';
            document.getElementById('announcementPinDaysField').style.display = 'none';
            document.getElementById('announcementSubmitBtn').textContent = 'Send Announcement';
            processScheduledAnnouncements(); // Check for any to publish
            processAutoArchive(); // Archive old ones
            renderAdminAnnouncements();
            renderAnnouncementAnalytics();
        }

        function sendAnnouncementEmail(announcement) {
            // Formspree stub - replace endpoint with actual Formspree URL
            const formspreeEndpoint = 'https://formspree.io/f/YOUR_FORM_ID';
            
            fetch(formspreeEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subject: `New Announcement: ${announcement.title}`,
                    message: `Target: ${announcement.target}\nCategory: ${announcement.category}\nPriority: ${announcement.priority}\n\n${announcement.message}\n\nLink: ${announcement.link || 'None'}\nExpires: ${announcement.expiresOn || 'Never'}`,
                    announcement: announcement
                })
            }).catch(err => console.log('Email notification failed:', err));
        }

        function processScheduledAnnouncements() {
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            const now = new Date();
            let changed = false;
            
            allAnnouncements.forEach(a => {
                if (a.scheduledFor && !a.published) {
                    const scheduledDate = new Date(a.scheduledFor);
                    if (scheduledDate <= now) {
                        a.published = true;
                        changed = true;
                        console.log('Publishing scheduled announcement:', a.title);
                    }
                }
            });
            
            if (changed) {
                localStorage.setItem('adminAnnouncements', JSON.stringify(allAnnouncements));
            }
        }

        function processAutoArchive() {
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            const now = new Date();
            let changed = false;
            
            allAnnouncements.forEach(a => {
                if (a.archiveOn && !a.archived) {
                    const archiveDate = new Date(a.archiveOn);
                    if (archiveDate <= now) {
                        a.archived = true;
                        changed = true;
                        console.log('Auto-archiving announcement:', a.title);
                    }
                }
            });
            
            if (changed) {
                localStorage.setItem('adminAnnouncements', JSON.stringify(allAnnouncements));
            }
        }

        function showAnnouncementTab(tab) {
            announcementTab = tab;
            
            // Update tab button styles
            const tabs = ['active', 'scheduled', 'archived'];
            tabs.forEach(t => {
                const btn = document.getElementById(`${t}AnnouncementsTab`);
                if (btn) {
                    if (t === tab) {
                        btn.style.background = '#3b82f6';
                        btn.style.color = '#fff';
                    } else {
                        btn.style.background = '#e5e7eb';
                        btn.style.color = '#374151';
                    }
                }
            });
            
            renderAdminAnnouncements();
        }

        function renderAnnouncementAnalytics() {
            const card = document.getElementById('announcementAnalyticsCard');
            if (!currentUser || !currentUser.isAdmin) {
                if (card) card.style.display = 'none';
                return;
            }
            
            if (card) card.style.display = 'block';
            
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            const analytics = JSON.parse(localStorage.getItem('announcementAnalytics') || '{}');
            
            // Calculate overall stats
            let totalViews = 0;
            let totalDismissals = 0;
            const published = allAnnouncements.filter(a => a.published !== false && !a.archived);
            
            published.forEach(a => {
                const stats = analytics[a.id] || { views: {}, dismissals: [] };
                totalViews += Object.keys(stats.views).length;
                totalDismissals += stats.dismissals.length;
            });
            
            const overviewEl = document.getElementById('analyticsOverview');
            if (overviewEl) {
                overviewEl.innerHTML = `
                    <div style="padding:1rem; background:#dbeafe; border-radius:0.5rem; text-align:center;">
                        <div style="font-size:1.75rem; font-weight:700; color:#1e40af;">${published.length}</div>
                        <div style="font-size:0.85rem; color:#1e40af;">Active Announcements</div>
                    </div>
                    <div style="padding:1rem; background:#dcfce7; border-radius:0.5rem; text-align:center;">
                        <div style="font-size:1.75rem; font-weight:700; color:#166534;">${totalViews}</div>
                        <div style="font-size:0.85rem; color:#166534;">Total Views</div>
                    </div>
                    <div style="padding:1rem; background:#fee2e2; border-radius:0.5rem; text-align:center;">
                        <div style="font-size:1.75rem; font-weight:700; color:#991b1b;">${totalDismissals}</div>
                        <div style="font-size:0.85rem; color:#991b1b;">Total Dismissals</div>
                    </div>
                    <div style="padding:1rem; background:#fef3c7; border-radius:0.5rem; text-align:center;">
                        <div style="font-size:1.75rem; font-weight:700; color:#92400e;">${allAnnouncements.filter(a => a.scheduledFor && !a.published).length}</div>
                        <div style="font-size:0.85rem; color:#92400e;">Scheduled</div>
                    </div>
                `;
            }
        }

        function toggleDailyDigest(enabled) {
            const field = document.getElementById('digestTimeField');
            if (field) field.style.display = enabled ? 'block' : 'none';
            
            // Save preference
            if (currentUser) {
                const prefs = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}notificationPrefs:${currentUser.email}`) || '{}');
                prefs.dailyDigest = enabled;
                if (!enabled) delete prefs.digestTime;
                localStorage.setItem(`${STORAGE_PREFIX}notificationPrefs:${currentUser.email}`, JSON.stringify(prefs));
                showToast(enabled ? '‚úÖ Daily digest enabled' : 'Daily digest disabled');
            }
        }

        function saveDailyDigestTime(time) {
            if (currentUser) {
                const prefs = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}notificationPrefs:${currentUser.email}`) || '{}');
                prefs.digestTime = time;
                localStorage.setItem(`${STORAGE_PREFIX}notificationPrefs:${currentUser.email}`, JSON.stringify(prefs));
                showToast(`Digest time set to ${time}`);
            }
        }

        function loadNotificationPreferences() {
            if (!currentUser) return;
            const prefs = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}notificationPrefs:${currentUser.email}`) || '{}');
            
            const checkbox = document.getElementById('enableDailyDigest');
            const timeInput = document.getElementById('digestTime');
            const field = document.getElementById('digestTimeField');
            
            if (checkbox) checkbox.checked = prefs.dailyDigest || false;
            if (timeInput && prefs.digestTime) timeInput.value = prefs.digestTime;
            if (field) field.style.display = prefs.dailyDigest ? 'block' : 'none';
        }

        function sendMessage() {
            if (!currentUser) return;
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            if (!text) { showToast('Message cannot be empty'); return; }
            
            const messages = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}messages:${currentUser.email}`) || '[]');
            messages.push({
                sender: currentUser.email,
                recipient: 'advisor@ksau-hs.edu.sa',
                text,
                timestamp: new Date().toISOString(),
                read: false
            });
            localStorage.setItem(`${STORAGE_PREFIX}messages:${currentUser.email}`, JSON.stringify(messages));
            
            messageInput.value = '';
            renderMessages();
            showToast('‚úâÔ∏è Message sent to advisor!');
        }

        function renderMessages() {
            const messagesList = document.getElementById('messagesList');
            if (!messagesList || !currentUser) return;
            
            const messages = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}messages:${currentUser.email}`) || '[]')
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            messagesList.innerHTML = messages.length === 0 ? 
                '<div style=\"color:#999; text-align:center; padding:2rem;\">No messages yet. Start a conversation!</div>' :
                messages.map(msg => `
                    <div style=\"display:flex; ${msg.sender === currentUser.email ? 'justify-content:flex-end;' : 'justify-content:flex-start;'}\">
                        <div style=\"max-width:70%; padding:0.75rem 1rem; background:${msg.sender === currentUser.email ? '#0891b2' : '#f3f4f6'}; color:${msg.sender === currentUser.email ? '#fff' : '#000'}; border-radius:0.75rem;\">
                            <div>${msg.text}</div>
                            <div style=\"font-size:0.7rem; opacity:0.7; margin-top:0.25rem;\">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `).join('');
        }

        function renderGradeAnalytics() {
            if (!clinicalState?.academic?.courses) return;
            
            const courses = clinicalState.academic.courses;
            const gradeStats = document.getElementById('gradeStats');
            const courseAnalytics = document.getElementById('courseAnalytics');
            const analyticsInsights = document.getElementById('analyticsInsights');
            
            if (!gradeStats) return;
            
            const grades = courses.map(c => gradeToNumeric(c.grade));
            const avgGrade = (grades.reduce((a, b) => a + b, 0) / grades.length).toFixed(2);
            const maxGrade = Math.max(...grades);
            const minGrade = Math.min(...grades);
            const atRisk = courses.filter(c => gradeToNumeric(c.grade) < 70).length;
            
            gradeStats.innerHTML = `
                <div style=\"padding:1rem; background:#dbeafe; border-radius:0.5rem; text-align:center;\">
                    <div style=\"font-size:1.75rem; font-weight:700; color:#1e40af;\">${avgGrade}</div>
                    <div style=\"font-size:0.75rem; color:#1e40af;\">GPA Average</div>
                </div>
                <div style=\"padding:1rem; background:#dcfce7; border-radius:0.5rem; text-align:center;\">
                    <div style=\"font-size:1.75rem; font-weight:700; color:#166534;\">${maxGrade}</div>
                    <div style=\"font-size:0.75rem; color:#166534;\">Highest</div>
                </div>
                <div style=\"padding:1rem; background:#fee2e2; border-radius:0.5rem; text-align:center;\">
                    <div style=\"font-size:1.75rem; font-weight:700; color:#991b1b;\">${atRisk}</div>
                    <div style=\"font-size:0.75rem; color:#991b1b;\">At Risk</div>
                </div>
            `;
            
            courseAnalytics.innerHTML = courses.map(c => {
                const numeric = gradeToNumeric(c.grade);
                const color = numeric >= 85 ? '#16a34a' : numeric >= 70 ? '#eab308' : '#ef4444';
                return `
                    <div style=\"padding:0.75rem; background:#f9fafb; border-left:3px solid ${color}; border-radius:0.25rem; display:flex; justify-content:space-between; align-items:center;\">
                        <div><strong>${c.code}</strong> <span style=\"font-size:0.85rem; color:#999;\">${c.credits} credits</span></div>
                        <div style=\"font-size:1.25rem; font-weight:700; color:${color};\">${c.grade}</div>
                    </div>
                `;
            }).join('');
            
            analyticsInsights.innerHTML = `
                <div style=\"padding:1rem; background:#${atRisk > 0 ? 'fee2e2' : 'dcfce7'}; border-left:3px solid ${atRisk > 0 ? '#ef4444' : '#16a34a'}; border-radius:0.5rem;\">
                    <strong>${atRisk > 0 ? '‚ö†Ô∏è Action Needed' : '‚úÖ Great Progress'}</strong><br>
                    <span style=\"font-size:0.9rem;\">${atRisk > 0 ? `You have ${atRisk} course(s) below 70%. Consider reaching out to your advisor.` : 'Excellent performance across all courses!'}</span>
                </div>
            `;
        }

        function gradeToNumeric(grade) {
            const map = { 'A+': 95, 'A': 90, 'A-': 87, 'B+': 85, 'B': 80, 'B-': 77, 'C+': 75, 'C': 70, 'C-': 67, 'D': 60, 'F': 0 };
            return map[grade] || 0;
        }

        function startNewConversation() {
            if (!currentUser) return;
            const advisorEmail = 'advisor@ksau-hs.edu.sa';
            currentConversation = { with: advisorEmail };
            renderMessages();
        }

        function loadConversations() {
            if (!currentUser) return [];
            const messages = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}messages:${currentUser.email}`) || '[]');
            const convos = new Map();
            messages.forEach(msg => {
                const key = msg.sender === currentUser.email ? msg.recipient : msg.sender;
                if (!convos.has(key)) {
                    convos.set(key, { with: key, lastMessage: msg.text, timestamp: msg.timestamp });
                }
                convos.set(key, { ...convos.get(key), timestamp: msg.timestamp, lastMessage: msg.text });
            });
            return Array.from(convos.values()).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function renderMessages() {
            const convList = document.getElementById('convList');
            const messagesList = document.getElementById('messagesList');
            const messageForm = document.getElementById('messageForm');
            
            if (!convList || !messagesList) return;
            
            const conversations = loadConversations();
            convList.innerHTML = conversations.map(conv => `
                <button onclick="selectConversation('${conv.with}')" style="padding:0.75rem; background:${currentConversation?.with === conv.with ? '#0891b2' : '#f3f4f6'}; color:${currentConversation?.with === conv.with ? '#fff' : '#000'}; border:none; border-radius:0.5rem; cursor:pointer; text-align:left;">
                    <div style="font-weight:600; font-size:0.9rem;">${conv.with}</div>
                    <div style="font-size:0.75rem; opacity:0.8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${conv.lastMessage}</div>
                </button>
            `).join('');
            
            if (currentConversation) {
                const messages = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}messages:${currentUser.email}`) || '[]')
                    .filter(m => (m.sender === currentUser.email && m.recipient === currentConversation.with) || 
                                  (m.sender === currentConversation.with && m.recipient === currentUser.email))
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                messagesList.innerHTML = messages.length === 0 ? '<div style="color:#999; text-align:center; padding:2rem;">No messages yet. Start the conversation!</div>' :
                    messages.map(msg => `
                        <div style="display:flex; ${msg.sender === currentUser.email ? 'justify-content:flex-end;' : ''}">
                            <div style="max-width:60%; padding:0.75rem 1rem; background:${msg.sender === currentUser.email ? '#0891b2' : '#f3f4f6'}; color:${msg.sender === currentUser.email ? '#fff' : '#000'}; border-radius:0.5rem;">
                                <div>${msg.text}</div>
                                <div style="font-size:0.75rem; opacity:0.7; margin-top:0.25rem;">${new Date(msg.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('');
                
                messageForm.style.display = 'flex';
            } else {
                messagesList.innerHTML = '<div style="color:#999; text-align:center; padding:2rem;">Select a conversation to view messages</div>';
                messageForm.style.display = 'none';
            }
        }

        function selectConversation(email) {
            currentConversation = { with: email };
            renderMessages();
        }

        function sendMessage(e) {
            e.preventDefault();
            if (!currentUser || !currentConversation) return;
            
            const text = document.getElementById('messageInput').value.trim();
            if (!text) return;
            
            const messages = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}messages:${currentUser.email}`) || '[]');
            messages.push({
                sender: currentUser.email,
                recipient: currentConversation.with,
                text,
                timestamp: new Date().toISOString(),
                read: false
            });
            localStorage.setItem(`${STORAGE_PREFIX}messages:${currentUser.email}`, JSON.stringify(messages));
            
            document.getElementById('messageInput').value = '';
            renderMessages();
            showToast('Message sent!');
        }

        function renderGradeAnalytics() {
            if (!clinicalState?.academic?.courses) return;
            
            const courses = clinicalState.academic.courses;
            const courseAnalytics = document.getElementById('courseAnalytics');
            const analyticsInsights = document.getElementById('analyticsInsights');
            
            if (!courseAnalytics) return;
            
            const grades = courses.map(c => ({
                name: c.code,
                grade: c.grade,
                credits: c.credits,
                numeric: gradeToNumeric(c.grade)
            }));
            
            // Calculate stats
            const avgGrade = (grades.reduce((sum, g) => sum + g.numeric, 0) / grades.length).toFixed(2);
            const highestGrade = Math.max(...grades.map(g => g.numeric));
            const lowestGrade = Math.min(...grades.map(g => g.numeric));
            const atRisk = grades.filter(g => g.numeric < 70).length;
            
            courseAnalytics.innerHTML = grades.map(g => {
                const color = g.numeric >= 85 ? '#16a34a' : g.numeric >= 70 ? '#eab308' : '#ef4444';
                return `
                    <div style="padding:0.75rem; background:#f9fafb; border-radius:0.5rem; border-left:3px solid ${color};">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:600;">${g.name}</span>
                            <span style="font-size:1.25rem; font-weight:700; color:${color};">${g.grade}</span>
                        </div>
                        <div style="font-size:0.75rem; color:#999; margin-top:0.25rem;">${g.credits} Credits</div>
                    </div>
                `;
            }).join('');
            
            analyticsInsights.innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:0.75rem;">
                    <div style="padding:1rem; background:#dbeafe; border-radius:0.5rem; text-align:center;">
                        <div style="font-size:1.75rem; font-weight:700; color:#1e40af;">${avgGrade}</div>
                        <div style="font-size:0.75rem; color:#1e40af;">Average GPA</div>
                    </div>
                    <div style="padding:1rem; background:#dcfce7; border-radius:0.5rem; text-align:center;">
                        <div style="font-size:1.75rem; font-weight:700; color:#166534;">${highestGrade}</div>
                        <div style="font-size:0.75rem; color:#166534;">Highest Grade</div>
                    </div>
                    <div style="padding:1rem; background:#fee2e2; border-radius:0.5rem; text-align:center;">
                        <div style="font-size:1.75rem; font-weight:700; color:#991b1b;">${atRisk}</div>
                        <div style="font-size:0.75rem; color:#991b1b;">Courses at Risk</div>
                    </div>
                </div>
                <div style="padding:0.75rem; background:#fef3c7; border-left:3px solid #f59e0b; border-radius:0.25rem;">
                    <strong>üí° Insight:</strong> ${atRisk > 0 ? `You have ${atRisk} course(s) below 70%. Consider reaching out to your advisor or faculty.` : 'Great performance! Keep up the excellent work.'}
                </div>
            `;
        }

        function gradeToNumeric(grade) {
            const map = { 'A+': 95, 'A': 90, 'A-': 87, 'B+': 85, 'B': 80, 'B-': 77, 'C+': 75, 'C': 70, 'C-': 67, 'D': 60, 'F': 0 };
            return map[grade] || 0;
        }

        function toggleResourceForm() {
            const form = document.getElementById('resourceForm');
            if (form) form.classList.toggle('hidden');
        }

        function handleAddResource(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const courseSelect = document.getElementById('resourceCourse');
            const title = document.getElementById('resourceTitle').value;
            const link = document.getElementById('resourceLink').value;
            const type = document.getElementById('resourceType').value;
            const courseCode = courseSelect.value;
            
            if (!courseCode || !title || !link || !type) {
                showToast('Please fill all fields');
                return;
            }
            
            const resources = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}resources`) || '{}');
            if (!resources[courseCode]) resources[courseCode] = [];
            
            resources[courseCode].push({ 
                id: Date.now(),
                title, 
                link, 
                type, 
                addedBy: currentUser.email, 
                timestamp: new Date().toISOString() 
            });
            localStorage.setItem(`${STORAGE_PREFIX}resources`, JSON.stringify(resources));
            
            document.getElementById('addResourceForm').reset();
            toggleResourceForm();
            renderResources();
            showToast('üìö Resource added!');
        }

        function renderResources() {
            try {
                if (!clinicalState?.academic?.courses) return;
                
                const resourcesList = document.getElementById('resourcesList');
                const resources = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}resources`) || '{}');
                
                if (!resourcesList) return;
            
            let html = '';
            for (const [courseCode, items] of Object.entries(resources)) {
                const course = clinicalState.academic.courses.find(c => c.code === courseCode);
                if (!course) continue;
                
                html += `
                    <div style="padding:0.75rem; background:#f9fafb; border-radius:0.5rem;">
                        <div style="font-weight:600; color:var(--primary); margin-bottom:0.5rem;">üìç ${courseCode}</div>
                        <div style="display:flex; flex-direction:column; gap:0.5rem;">
                `;
                
                items.forEach((res, idx) => {
                    const icons = { 'Notes': 'üìù', 'Video': 'üé•', 'Textbook': 'üìñ', 'Practice': '‚úèÔ∏è', 'Other': 'üìÑ' };
                    html += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem; background:#fff; border-radius:0.25rem;">
                            <div>
                                <div style="font-size:0.875rem; font-weight:500;">${icons[res.type] || 'üìÑ'} ${res.title}</div>
                                <div style="font-size:0.75rem; color:#999;">Added: ${new Date(res.timestamp).toLocaleDateString()}</div>
                            </div>
                            <div style="display:flex; gap:0.5rem;">
                                <a href="${res.link}" target="_blank" class="btn" style="padding:0.375rem 0.75rem; font-size:0.75rem; background:#0891b2; color:#fff; text-decoration:none;">Open</a>
                                <button onclick="deleteResource('${courseCode}', ${idx})" class="btn" style="padding:0.375rem 0.75rem; font-size:0.75rem; background:#ef4444; color:#fff;">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
                if (!html) {
                    html = '<div style="color:#999; text-align:center; padding:1rem;">No resources yet. Add one to get started!</div>';
                }
                
                resourcesList.innerHTML = html;
            } catch (err) {
                console.error('Error rendering resources:', err);
            }
        }

        function deleteResource(courseCode, index) {
            if (!confirm('Delete this resource?')) return;
            
            const resources = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}resources`) || '{}');
            if (resources[courseCode]) {
                resources[courseCode].splice(index, 1);
                if (resources[courseCode].length === 0) delete resources[courseCode];
                localStorage.setItem(`${STORAGE_PREFIX}resources`, JSON.stringify(resources));
                renderResources();
                showToast('Resource deleted');
            }
        }

        function renderSubmissions() {
            try {
                if (!clinicalState?.academic?.courses) return;
                
                const submissionsContainer = document.getElementById('submissionsContainer');
                if (!submissionsContainer) return;
                
                const assignments = clinicalState.academic.assignments || [];
                const submissions = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}submissions:${currentUser.email}`) || '{}');
                
                let html = '';
                assignments.forEach((assignment, idx) => {
                    const status = submissions[`${assignment.courseCode}_${idx}`] ? 'submitted' : 'pending';
                    const submission = submissions[`${assignment.courseCode}_${idx}`];
                    
                    html += `
                        <div style="padding:1rem; background:#f9fafb; border-radius:0.5rem; border-left:3px solid ${status === 'submitted' ? '#16a34a' : '#ef4444'};">
                            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.75rem;">
                                <div>
                                    <div style="font-weight:600; font-size:0.95rem;">${assignment.title}</div>
                                    <div style="font-size:0.875rem; color:#999;">üìÖ Due: ${new Date(assignment.dueDate).toLocaleDateString()}</div>
                                </div>
                                <span style="padding:0.25rem 0.75rem; background:${status === 'submitted' ? '#dcfce7' : '#fee2e2'}; color:${status === 'submitted' ? '#166534' : '#991b1b'}; border-radius:0.25rem; font-size:0.75rem; font-weight:600;">
                                    ${status === 'submitted' ? '‚úÖ Submitted' : '‚è≥ Not Submitted'}
                                </span>
                            </div>
                            ${submission ? `
                                <div style="font-size:0.875rem; padding:0.5rem; background:#dbeafe; border-radius:0.25rem; margin-bottom:0.75rem;">
                                    üìé ${submission.filename} (${(submission.size / 1024).toFixed(2)} KB)
                                    <br>Submitted: ${new Date(submission.submittedAt).toLocaleString()}
                                    ${submission.grade ? `<br>Grade: <strong>${submission.grade}</strong>` : ''}
                                </div>
                            ` : ''}
                            <form onsubmit="handleSubmitAssignment(event, '${assignment.courseCode}', ${idx})" style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                                <input type="file" id="assignmentFile_${idx}" required style="flex:1; padding:0.5rem; border:1px solid #e5e7eb; border-radius:0.25rem;">
                                <textarea id="submissionComments_${idx}" placeholder="Comments (optional)" style="flex:1; padding:0.5rem; border:1px solid #e5e7eb; border-radius:0.25rem; min-width:200px;"></textarea>
                                <button type="submit" class="btn" style="background:#0891b2; color:#fff; padding:0.5rem 1rem;">Submit</button>
                            </form>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div style="color:#999; text-align:center; padding:2rem;">No assignments yet</div>';
                }
                
                submissionsContainer.innerHTML = html;
            } catch (err) {
                console.error('Error rendering submissions:', err);
            }
        }

        function handleSubmitAssignment(e, courseCode, assignmentIdx) {
            e.preventDefault();
            if (!currentUser) return;
            
            const fileInput = document.getElementById(`assignmentFile_${assignmentIdx}`);
            const commentsInput = document.getElementById(`submissionComments_${assignmentIdx}`);
            const file = fileInput.files[0];
            const comments = commentsInput.value;
            
            if (!file) {
                showToast('Please select a file');
                return;
            }
            
            const submissions = JSON.parse(localStorage.getItem(`${STORAGE_PREFIX}submissions:${currentUser.email}`) || '{}');
            const submissionKey = `${courseCode}_${assignmentIdx}`;
            
            submissions[submissionKey] = {
                filename: file.name,
                size: file.size,
                comments,
                submittedAt: new Date().toISOString(),
                status: 'submitted',
                grade: null
            };
            
            localStorage.setItem(`${STORAGE_PREFIX}submissions:${currentUser.email}`, JSON.stringify(submissions));
            
            fileInput.value = '';
            commentsInput.value = '';
            renderSubmissions();
            showToast('‚úÖ Assignment submitted!');
        }

        function deleteAnnouncement(index) {
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Admin-only action');
                return;
            }
            
            if (!confirm('Delete this announcement?')) return;
            
            const allAnnouncements = JSON.parse(localStorage.getItem('adminAnnouncements') || '[]');
            allAnnouncements.splice(index, 1);
            localStorage.setItem('adminAnnouncements', JSON.stringify(allAnnouncements));
            
            renderAdminAnnouncements();
            showToast('Announcement deleted');
        }

        function exportAllData() {
            if (!currentUser || !clinicalState) return;
            try {
                const data = { user: currentUser.email, data: clinicalState, exported: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `student-data-${currentUser.email.split('@')[0]}-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('All data exported');
            } catch (err) {
                showToast('Export failed');
            }
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL your clinical data. This cannot be undone. Continue?')) return;
            if (!currentUser) return;
            localStorage.removeItem(getUserStorageKey(currentUser.email));
            clinicalState = cloneTemplate(currentUser.template);
            saveState();
            renderClinical();
            renderDashboard();
            showToast('All data cleared');
        }

        function updateWelcome(user) {
            const nameEl = document.getElementById('welcomeName');
            const yearEl = document.getElementById('welcomeYear');
            if (nameEl) nameEl.textContent = `Welcome, ${user.name.split(' ')[0]}!`;
            if (yearEl) yearEl.textContent = user.yearLabel;
        }

        function renderDashboard() {
            const overviewEl = document.getElementById('dashboardOverview');
            const recentEl = document.getElementById('recentActivity');
            const alertsCard = document.getElementById('dashboardAlerts');
            const alertsList = document.getElementById('alertsList');
            const goalsEl = document.getElementById('goalsContent');
            if (!overviewEl || !clinicalState || !currentUser) return;

            const { hours, attendance, activities, ippes } = clinicalState;
            const rotationPct = percent(hours.rotation, hours.rotationTotal);
            const attendancePct = percent(attendance.present, attendance.total);
            const completedActivities = activities.filter(a => a.done).length;
            const completedIppes = ippes.filter(i => i.hours.completed >= i.hours.total).length;

            overviewEl.innerHTML = `
                <div class="section-title">üìä Quick Overview</div>
                <div class="grid-2" style="gap: 1rem; margin-top: 0.75rem;">
                    <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 0.75rem;">
                        <div style="font-size: 2rem; font-weight: 800; color: #065f46;">${hours.rotation}</div>
                        <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-top: 0.25rem;">Clinical Hours</div>
                        <div style="font-size: 0.7rem; color: #059669; margin-top: 0.15rem;">${rotationPct}% of ${hours.rotationTotal}</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 0.75rem;">
                        <div style="font-size: 2rem; font-weight: 800; color: #1e40af;">${attendance.present}/${attendance.total}</div>
                        <div style="font-size: 0.75rem; color: #1e40af; font-weight: 600; margin-top: 0.25rem;">Attendance</div>
                        <div style="font-size: 0.7rem; color: #2563eb; margin-top: 0.15rem;">${attendancePct}% present</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 0.75rem;">
                        <div style="font-size: 2rem; font-weight: 800; color: #92400e;">${completedActivities}/${activities.length}</div>
                        <div style="font-size: 0.75rem; color: #92400e; font-weight: 600; margin-top: 0.25rem;">Activities Done</div>
                        <div style="font-size: 0.7rem; color: #b45309; margin-top: 0.15rem;">Tasks completed</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border-radius: 0.75rem;">
                        <div style="font-size: 2rem; font-weight: 800; color: #6b21a8;">${completedIppes}/${ippes.length}</div>
                        <div style="font-size: 0.75rem; color: #6b21a8; font-weight: 600; margin-top: 0.25rem;">IPPE Complete</div>
                        <div style="font-size: 0.7rem; color: #7c3aed; margin-top: 0.15rem;">Experiences</div>
                    </div>
                </div>
            `;

            if (recentEl) {
                const recentActivities = activities.slice(0, 3);
                if (recentActivities.length === 0) {
                    recentEl.innerHTML = '<div style="color: var(--text-gray); font-size: 0.9rem;">No activities logged yet</div>';
                } else {
                    recentEl.innerHTML = recentActivities.map(act => `
                        <div style="display: flex; align-items: start; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;">${act.done ? '‚úÖ' : '‚è≥'}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.875rem;">${act.title}</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">${act.detail}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Render alerts
            const alerts = [];
            const settings = clinicalState.settings || { goals: { weeklyHours: 40 }, notifications: { hours: true, alerts: true } };
            if (settings.notifications?.alerts && hours.week < settings.goals.weeklyHours * 0.7) {
                alerts.push({ icon: '‚ö†Ô∏è', text: `You're behind on weekly hours (${hours.week.toFixed(1)}/${settings.goals.weeklyHours})`, color: '#f59e0b' });
            }
            if (settings.notifications?.activities && activities.filter(a => !a.done).length > 3) {
                alerts.push({ icon: 'üìã', text: `${activities.filter(a => !a.done).length} pending activities need attention`, color: '#f59e0b' });
            }
            if (settings.notifications?.hours && hours.today === 0) {
                alerts.push({ icon: '‚è∞', text: 'Remember to log your hours for today!', color: '#3b82f6' });
            }

            if (alerts.length > 0 && alertsCard && alertsList) {
                alertsCard.style.display = 'block';
                alertsList.innerHTML = alerts.map(alert => `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem; background: white; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">${alert.icon}</span>
                        <div style="flex: 1; font-size: 0.875rem; color: var(--text-dark);">${alert.text}</div>
                    </div>
                `).join('');
            } else if (alertsCard) {
                alertsCard.style.display = 'none';
            }

            // Render goals
            if (goalsEl) {
                const weeklyGoal = settings.goals?.weeklyHours || 40;
                const weeklyPct = Math.min(100, (hours.week / weeklyGoal) * 100);
                const dailyGoal = settings.goals?.dailyActivities || 3;
                const todayActivities = activities.filter(a => a.done).length;
                const activityPct = Math.min(100, (todayActivities / dailyGoal) * 100);
                
                goalsEl.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.875rem; font-weight: 600;">Weekly Hours Goal</span>
                            <span style="font-size: 0.875rem; color: var(--text-gray);">${hours.week.toFixed(1)} / ${weeklyGoal}</span>
                        </div>
                        <div style="height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); width: ${weeklyPct}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.875rem; font-weight: 600;">Daily Activities Goal</span>
                            <span style="font-size: 0.875rem; color: var(--text-gray);">${todayActivities} / ${dailyGoal}</span>
                        </div>
                        <div style="height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); width: ${activityPct}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }
        }

        function getDismissedAnnouncementsForUser() {
            if (!currentUser) return [];
            const key = `${STORAGE_PREFIX}dismissedAnnouncements:${currentUser.email}`;
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : [];
            } catch { return []; }
        }

        function trackAnnouncementView(announcementId) {
            if (!announcementId || !currentUser?.email) return;
            
            const analytics = JSON.parse(localStorage.getItem('announcementAnalytics') || '{}');
            if (!analytics[announcementId]) {
                analytics[announcementId] = { views: {}, dismissals: [] };
            }
            
            // Track view with timestamp
            analytics[announcementId].views[currentUser.email] = new Date().toISOString();
            localStorage.setItem('announcementAnalytics', JSON.stringify(analytics));
        }

        function dismissAnnouncement(id) {
            if (!currentUser || !id) return;
            const key = `${STORAGE_PREFIX}dismissedAnnouncements:${currentUser.email}`;
            const list = getDismissedAnnouncementsForUser();
            if (!list.includes(id)) list.push(id);
            
            // Track dismissal in analytics
            const analytics = JSON.parse(localStorage.getItem('announcementAnalytics') || '{}');
            if (analytics[id] && !analytics[id].dismissals.includes(currentUser.email)) {
                analytics[id].dismissals.push(currentUser.email);
                localStorage.setItem('announcementAnalytics', JSON.stringify(analytics));
            }
            
            localStorage.setItem(key, JSON.stringify(list));
            showToast('Announcement dismissed');
            renderAcademic();
        }

        function generateAcademicAnnouncements() {
            if (!clinicalState || !clinicalState.academic) return [];
            const academic = clinicalState.academic;
            const announcements = [];
            
            // Load admin-created announcements first
            const adminAnnouncements = loadAnnouncementsForUser();
            announcements.push(...adminAnnouncements);
            
            // 1. Check grades at risk
            if (academic.courses) {
                academic.courses.forEach(course => {
                    if (course.percentage > 0 && course.percentage < 70) {
                        announcements.push({ icon: '‚ö†Ô∏è', text: `${course.code}: Your grade is ${course.percentage}% - At Risk!`, type: 'danger', category: 'Grades' });
                    } else if (course.percentage >= 70 && course.percentage < 80) {
                        announcements.push({ icon: 'üìä', text: `${course.code}: Grade ${course.percentage}% - Consider improvement`, type: 'warning', category: 'Grades' });
                    }
                });
            }
            
            // 2. Pending assignments
            if (academic.assignments) {
                const pending = academic.assignments.filter(a => a.status === 'pending');
                const urgent = pending.filter(a => {
                    const daysUntil = Math.ceil((new Date(a.due) - new Date()) / (1000 * 60 * 60 * 24));
                    return daysUntil <= 3 && daysUntil >= 0;
                });
                if (urgent.length > 0) {
                    announcements.push({ icon: 'üö®', text: `${urgent.length} assignment${urgent.length > 1 ? 's' : ''} due within 3 days!`, type: 'danger', category: 'Assignments' });
                } else if (pending.length > 0) {
                    announcements.push({ icon: 'üìù', text: `You have ${pending.length} pending assignment${pending.length > 1 ? 's' : ''}`, type: 'info', category: 'Assignments' });
                }
            }
            
            // 3. Upcoming exams
            if (academic.exams) {
                const upcoming = academic.exams.filter(e => {
                    const daysUntil = Math.ceil((new Date(e.date) - new Date()) / (1000 * 60 * 60 * 24));
                    return daysUntil >= 0 && daysUntil <= 7;
                });
                upcoming.forEach(exam => {
                    const daysUntil = Math.ceil((new Date(exam.date) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 2) {
                        announcements.push({ icon: 'üì¢', text: `${exam.course} ${exam.type} in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}!`, type: 'danger', category: 'Exams' });
                    } else {
                        announcements.push({ icon: 'üìÖ', text: `${exam.course} ${exam.type} on ${new Date(exam.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`, type: 'warning', category: 'Exams' });
                    }
                });
            }
            
            // 4. Recent quiz performance
            if (academic.quizzes && academic.quizzes.length > 0) {
                const recent = academic.quizzes[0];
                const scorePercent = (recent.score / recent.total) * 100;
                if (scorePercent < 70) {
                    announcements.push({ icon: 'üìâ', text: `Recent quiz ${recent.title}: ${recent.score}/${recent.total} (${scorePercent.toFixed(0)}%) - Review needed`, type: 'warning', category: 'Quizzes' });
                }
            }
            
            // 5. Attendance warnings
            if (academic.attendance) {
                if (academic.attendance.lectures.percentage < 80) {
                    announcements.push({ icon: '‚ö†Ô∏è', text: `Lecture attendance ${academic.attendance.lectures.percentage}% - Below 80%!`, type: 'danger', category: 'Attendance' });
                }
                if (academic.attendance.labs.percentage < 90) {
                    announcements.push({ icon: '‚ö†Ô∏è', text: `Lab attendance ${academic.attendance.labs.percentage}% - Improvement needed`, type: 'warning', category: 'Attendance' });
                }
                const unjustified = (academic.attendance.absences || []).filter(a => !a.justified);
                if (unjustified.length > 0) {
                    announcements.push({ icon: 'üìã', text: `${unjustified.length} unjustified absence${unjustified.length > 1 ? 's' : ''} - Upload documentation`, type: 'warning', category: 'Attendance' });
                }
            }
            
            // 6. Advisor action items
            if (academic.advisor && academic.advisor.actionItems) {
                const pending = academic.advisor.actionItems.filter(item => item.status === 'pending');
                if (pending.length > 0) {
                    announcements.push({ icon: 'üë®‚Äçüè´', text: `${pending.length} action item${pending.length > 1 ? 's' : ''} from your advisor`, type: 'info', category: 'Advising' });
                }
            }
            
            // 7. Today's schedule
            if (academic.schedule) {
                const today = new Date().getDay();
                const daysMap = { 0: 'Sunday', 1: 'Monday', 2: 'Tuesday', 3: 'Wednesday', 4: 'Thursday', 5: 'Friday', 6: 'Saturday' };
                const todayName = daysMap[today];
                const todayClasses = academic.schedule.filter(s => s.day === todayName);
                if (todayClasses.length > 0) {
                    announcements.push({ icon: 'üìö', text: `You have ${todayClasses.length} class${todayClasses.length > 1 ? 'es' : ''} today`, type: 'info', category: 'Schedule' });
                }
            }
            
            return announcements;
        }

        function renderAcademic() {
            if (!clinicalState || !currentUser || !clinicalState.academic) return;

            const academic = clinicalState.academic;
            const { semester, courses = [], schedule, assignments, exams, quizzes, attendance, advisor, documents, risks, recommendations, cumulativeGpa, previousSemesterGpa } = academic;
            
            if (!Array.isArray(courses) || courses.length === 0) {
                console.warn('No courses available for rendering');
            }
            
            const semesterEl = document.getElementById('academicSemester');
            if (semesterEl) semesterEl.textContent = semester;

            // Generate student-specific announcements
            const announcements = generateAcademicAnnouncements();

            // Calculate semester GPA
            const totalPoints = courses.reduce((sum, c) => sum + ((c.percentage || 0) / 100 * 5 * (c.credits || 0)), 0);
            const totalCredits = courses.reduce((sum, c) => sum + (c.credits || 0), 0);
            const semesterGpa = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';

            // Render Announcements
            const announcementsCard = document.getElementById('academicAnnouncements');
            const announcementsListEl = document.getElementById('announcementsList');
            if (announcements.length > 0 && announcementsCard && announcementsListEl) {
                announcementsCard.style.display = 'block';
                
                // Sort: pinned first, then by priority, then by timestamp
                const now = new Date();
                const sorted = announcements.sort((a, b) => {
                    // Check if pinned and not expired
                    const aPinned = a.pinned && (!a.pinnedUntil || new Date(a.pinnedUntil) > now);
                    const bPinned = b.pinned && (!b.pinnedUntil || new Date(b.pinnedUntil) > now);
                    if (aPinned && !bPinned) return -1;
                    if (!aPinned && bPinned) return 1;
                    // Then by priority
                    if (a.priority === 'high' && b.priority !== 'high') return -1;
                    if (a.priority !== 'high' && b.priority === 'high') return 1;
                    return 0;
                });
                
                const grouped = {};
                const filtered = academicAnnouncementsFilter === 'All' ? sorted : sorted.filter(a => a.category === academicAnnouncementsFilter);
                filtered.forEach(a => {
                    if (!grouped[a.category]) grouped[a.category] = [];
                    grouped[a.category].push(a);
                });
                announcementsListEl.innerHTML = Object.entries(grouped).map(([category, items]) => `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 700; font-size: 0.85rem; color: #1e40af; margin-bottom: 0.5rem;">${category}</div>
                        ${items.map(announcement => {
                            const bgColor = announcement.type === 'danger' ? '#fef2f2' : announcement.type === 'warning' ? '#fef3c7' : '#dbeafe';
                            const borderColor = announcement.type === 'danger' ? '#ef4444' : announcement.type === 'warning' ? '#f59e0b' : '#3b82f6';
                            const textColor = announcement.type === 'danger' ? '#991b1b' : announcement.type === 'warning' ? '#92400e' : '#1e40af';
                            const aPinned = announcement.pinned && (!announcement.pinnedUntil || new Date(announcement.pinnedUntil) > now);
                            const priorityMark = announcement.priority === 'high' ? '‚≠ê ' : '';
                            const pinMark = aPinned ? 'üìå ' : '';
                            const linkHtml = announcement.link ? `<a href=\"${announcement.link}\" target=\"_blank\" style=\"font-size:0.8rem; color:${textColor}; text-decoration:underline;\">Open</a>` : '';
                            const dismissBtn = (!currentUser?.isAdmin && announcement.isAdmin && announcement.id) ? `<button onclick=\"dismissAnnouncement('${announcement.id}')\" style=\"background:none; border:none; color:${textColor}; font-size:0.9rem; cursor:pointer;\">Dismiss ‚úï</button>` : '';
                            return `
                                <div style="display: flex; align-items: start; gap: 0.5rem; padding: 0.75rem; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 0.5rem; margin-bottom: 0.5rem; ${aPinned ? 'box-shadow: 0 2px 8px rgba(0,0,0,0.15);' : ''}">
                                    <span style="font-size: 1.25rem;">${announcement.icon}</span>
                                    <div style="flex: 1; font-size: 0.875rem; color: ${textColor}; font-weight: 500;">${pinMark}${priorityMark}${announcement.text}</div>
                                    <div style="display:flex; gap:0.5rem; align-items:center;">${linkHtml}${dismissBtn}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `).join('');
            } else if (announcementsCard) {
                announcementsCard.style.display = 'none';
            }

            // Render GPAs
            const cumulativeGpaEl = document.getElementById('cumulativeGpa');
            const semesterGpaEl = document.getElementById('semesterGpa');
            const gpaTrendEl = document.getElementById('gpaTrend');
            
            const safeCumulativeGpa = typeof cumulativeGpa === 'number' ? cumulativeGpa : 0;
            const safePrevGpa = typeof previousSemesterGpa === 'number' ? previousSemesterGpa : 0;
            if (cumulativeGpaEl) cumulativeGpaEl.textContent = safeCumulativeGpa.toFixed(2);
            if (semesterGpaEl) semesterGpaEl.textContent = semesterGpa;
            if (gpaTrendEl) {
                const trend = parseFloat(semesterGpa) > safePrevGpa ? 'üìà Improving' : parseFloat(semesterGpa) < safePrevGpa ? 'üìâ Declining' : '‚û°Ô∏è Stable';
                const trendColor = parseFloat(semesterGpa) > safePrevGpa ? '#22c55e' : parseFloat(semesterGpa) < safePrevGpa ? '#ef4444' : '#6b7280';
                gpaTrendEl.innerHTML = `<span style="color: ${trendColor};">${trend}</span>`;
            }

            // Render risks
            const risksCard = document.getElementById('academicRisks');
            const risksListEl = document.getElementById('risksList');
            if (risks && risks.length > 0 && risksCard && risksListEl) {
                risksCard.style.display = 'block';
                risksListEl.innerHTML = risks.map(risk => `
                    <div style="display: flex; align-items: start; gap: 0.5rem; padding: 0.75rem; background: white; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.25rem;">‚ö†Ô∏è</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.875rem; color: #991b1b;">${risk.course}</div>
                            <div style="font-size: 0.8rem; color: #7f1d1d; margin-top: 0.25rem;">${risk.reason}</div>
                        </div>
                        <span class="chip chip-danger" style="font-size: 0.7rem;">${risk.severity}</span>
                    </div>
                `).join('');
            } else if (risksCard) {
                risksCard.style.display = 'none';
            }

            // Render courses
            const coursesEl = document.getElementById('coursesList');
            const creditsEl = document.getElementById('totalCredits');
            if (creditsEl) creditsEl.textContent = `${totalCredits} Credits`;
            
            if (coursesEl) {
                coursesEl.innerHTML = courses.map((course, idx) => {
                    const pct = course.percentage || 0;
                    const gradeColor = pct >= 90 ? '#22c55e' : pct >= 80 ? '#3b82f6' : pct >= 70 ? '#f59e0b' : pct > 0 ? '#ef4444' : '#9ca3af';
                    const statusColor = course.status === 'At Risk' ? '#ef4444' : '#22c55e';
                    return `
                        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.75rem; border-left: 4px solid ${gradeColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 700; font-size: 0.95rem; color: var(--text-dark);">${course.code}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-gray); margin-top: 0.15rem;">${course.name}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: 800; color: ${gradeColor};">${course.grade}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-gray);">${pct > 0 ? pct + '%' : 'In Progress'}</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.75rem;">
                                <span>üë®‚Äçüè´ ${course.instructor}</span>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span>${course.credits} Credits</span>
                                    <span class="chip" style="background: ${statusColor}15; color: ${statusColor}; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${course.status}</span>
                                </div>
                            </div>
                            <button onclick="openCourseEvaluation('${course.code.replace(/'/g, '')}', '${course.name.replace(/'/g, '')}')" style="width: 100%; padding: 0.5rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.85rem;">üìù Course Evaluation</button>
                        </div>
                    `;
                }).join('');
            }

            // Render exams
            const examsEl = document.getElementById('upcomingExams');
            if (examsEl && exams) {
                if (exams.length === 0) {
                    examsEl.innerHTML = '<div style="color: var(--text-gray); font-size: 0.85rem; padding: 0.5rem;">No upcoming exams</div>';
                } else {
                    examsEl.innerHTML = exams.map(exam => {
                        const examDate = new Date(exam.date);
                        const daysUntil = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24));
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fef3c7; border-radius: 0.5rem; border-left: 3px solid #f59e0b;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.875rem; color: #92400e;">${exam.title}</div>
                                    <div style="font-size: 0.75rem; color: #78350f; margin-top: 0.15rem;">${exam.course} ‚Ä¢ ${exam.type}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #92400e;">${examDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                    <div style="font-size: 0.7rem; color: #78350f;">${daysUntil} days</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Render quizzes
            const quizzesEl = document.getElementById('recentQuizzes');
            if (quizzesEl && quizzes) {
                if (quizzes.length === 0) {
                    quizzesEl.innerHTML = '<div style="color: var(--text-gray); font-size: 0.85rem; padding: 0.5rem;">No recent quizzes</div>';
                } else {
                    quizzesEl.innerHTML = quizzes.map(quiz => {
                        const scorePercent = (quiz.score / quiz.total) * 100;
                        const scoreColor = scorePercent >= 90 ? '#22c55e' : scorePercent >= 80 ? '#3b82f6' : scorePercent >= 70 ? '#f59e0b' : '#ef4444';
                        return `
                            <div style="padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; border-left: 3px solid ${scoreColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 0.85rem;">${quiz.title}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-gray);">${quiz.course} ‚Ä¢ ${quiz.date}</div>
                                    </div>
                                    <div style="font-weight: 700; color: ${scoreColor};">${quiz.score}/${quiz.total}</div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-gray); font-style: italic;">üí¨ ${quiz.feedback}</div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Render assignments
            const assignmentsListEl = document.getElementById('assignmentsList');
            if (assignmentsListEl && assignments) {
                const pending = assignments.filter(a => a.status === 'pending');
                if (pending.length > 0) {
                    assignmentsListEl.innerHTML = `
                        <div style="font-weight: 600; font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">Pending Assignments (${pending.length})</div>
                        ${pending.map((item, idx) => {
                            const fullIndex = assignments.indexOf(item);
                            const dueDate = new Date(item.due);
                            const daysUntil = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                            const urgency = daysUntil <= 2 ? '#ef4444' : daysUntil <= 5 ? '#f59e0b' : '#22c55e';
                            return `
                                <div style="padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; border-left: 3px solid ${urgency}; margin-bottom: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.875rem;">${item.title}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-gray); margin-top: 0.15rem;">${item.course}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.75rem; font-weight: 600; color: ${urgency};">Due ${dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                        <div style="font-size: 0.7rem; color: var(--text-gray);">${daysUntil} days</div>
                                                                        </div>
                                                                        ${currentUser && currentUser.isAdmin ? `<div style=\"display: flex; gap: 0.5rem;\">\n                                                                            <button onclick=\"markAssignmentSubmitted(${fullIndex})\" style=\"flex: 1; padding: 0.4rem; background: #22c55e; color: white; border: none; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer;\">‚úì Submit</button>\n                                                                            <button onclick=\"deleteAssignment(${fullIndex})\" style=\"flex: 1; padding: 0.4rem; background: #ef4444; color: white; border: none; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer;\">‚úó Delete</button>\n                                                                        </div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
            }

            // Render attendance
            const lectureAttEl = document.getElementById('lectureAttendance');
            const labAttEl = document.getElementById('labAttendance');
            const absencesEl = document.getElementById('absencesList');
            
            if (attendance && lectureAttEl) {
                lectureAttEl.textContent = `${attendance.lectures.attended}/${attendance.lectures.total} (${attendance.lectures.percentage}%)`;
            }
            if (attendance && labAttEl) {
                labAttEl.textContent = `${attendance.labs.attended}/${attendance.labs.total} (${attendance.labs.percentage}%)`;
            }
            if (attendance && absencesEl && attendance.absences) {
                if (attendance.absences.length > 0) {
                    absencesEl.innerHTML = `
                        <div style="font-weight: 600; font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">Recent Absences</div>
                        ${attendance.absences.map(absence => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.65rem; background: ${absence.justified ? '#f0fdf4' : '#fef2f2'}; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.85rem;">${absence.course} ‚Ä¢ ${absence.type}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-gray); margin-top: 0.15rem;">${absence.date} ‚Ä¢ ${absence.reason}</div>
                                </div>
                                <span class="chip ${absence.justified ? 'chip-success' : 'chip-danger'}" style="font-size: 0.7rem;">${absence.justified ? '‚úì Justified' : '‚úó Unjustified'}</span>
                            </div>
                        `).join('')}
                    `;
                }
            }

            // Render advisor info
            const advisorInfoEl = document.getElementById('advisorInfo');
            const advisingNotesEl = document.getElementById('advisingNotes');
            const actionItemsEl = document.getElementById('actionItems');
            
            if (advisor && advisorInfoEl) {
                advisorInfoEl.innerHTML = `
                    <div style="padding: 0.75rem; background: white; border-radius: 0.75rem;">
                        <div style="font-weight: 700; font-size: 0.95rem; color: #166534; margin-bottom: 0.5rem;">${advisor.name}</div>
                        <div style="display: flex; flex-direction: column; gap: 0.35rem; font-size: 0.8rem; color: #166534;">
                            <div>üìß ${advisor.email}</div>
                            <div>üìû ${advisor.phone}</div>
                            <div>üè¢ ${advisor.office}</div>
                        </div>
                    </div>
                `;
            }
            
            if (advisor && advisingNotesEl && advisor.notes) {
                advisingNotesEl.innerHTML = advisor.notes.slice(0, 2).map(note => `
                    <div style="padding: 0.65rem; background: white; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.75rem; color: #166534; font-weight: 600; margin-bottom: 0.25rem;">${note.date}</div>
                        <div style="font-size: 0.8rem; color: #166534;">${note.note}</div>
                    </div>
                `).join('');
            }
            
            if (advisor && actionItemsEl && advisor.actionItems) {
                actionItemsEl.innerHTML = advisor.actionItems.map((item, idx) => `
                    <div ${currentUser && currentUser.isAdmin ? `onclick=\"toggleActionItem(${idx})\"` : ''} style="display: flex; align-items: start; gap: 0.5rem; padding: 0.65rem; background: white; border-radius: 0.5rem; margin-bottom: 0.5rem; ${currentUser && currentUser.isAdmin ? 'cursor: pointer;' : ''}">
                        <span style="font-size: 1.1rem;">${item.status === 'completed' ? '‚úÖ' : 'üî≤'}</span>
                        <div style="flex: 1; font-size: 0.85rem; color: #166534; ${item.status === 'completed' ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${item.task}</div>
                    </div>
                `).join('');
            }

            // Render documents
            const documentsListEl = document.getElementById('documentsList');
            if (documents && documentsListEl) {
                documentsListEl.innerHTML = documents.map(doc => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; cursor: pointer;" onclick="showToast('Document: ${doc.name}')">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">üìÑ</span>
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">${doc.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">${doc.type} ‚Ä¢ ${doc.date}</div>
                            </div>
                        </div>
                        <span style="font-size: 1.2rem; color: var(--primary);">‚Üí</span>
                    </div>
                `).join('');
            }

            // Render recommendations
            const recommendationsCard = document.getElementById('recommendedResources');
            const resourcesListEl = document.getElementById('resourcesList');
            if (recommendations && recommendations.length > 0 && recommendationsCard && resourcesListEl) {
                recommendationsCard.style.display = 'block';
                resourcesListEl.innerHTML = recommendations.map(rec => `
                    <div style="padding: 0.75rem; background: white; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;" onclick="showToast('Resource: ${rec.title}')">
                        <div style="font-weight: 600; font-size: 0.875rem; color: #92400e; margin-bottom: 0.25rem;">üìö ${rec.title}</div>
                        <div style="font-size: 0.8rem; color: #78350f;">${rec.description}</div>
                    </div>
                `).join('');
            } else if (recommendationsCard) {
                recommendationsCard.style.display = 'none';
            }

            // Render schedule
            const scheduleEl = document.getElementById('weekSchedule');
            const today = new Date().getDay();
            const daysMap = { 0: 'Sunday', 1: 'Monday', 2: 'Tuesday', 3: 'Wednesday', 4: 'Thursday', 5: 'Friday', 6: 'Saturday' };
            const todayName = daysMap[today];
            const thisWeekSchedule = schedule.filter(s => {
                const dayIndex = Object.keys(daysMap).find(k => daysMap[k] === s.day);
                return dayIndex >= today;
            }).slice(0, 6);

            if (scheduleEl) {
                if (thisWeekSchedule.length === 0) {
                    scheduleEl.innerHTML = '<div style="color: var(--text-gray); font-size: 0.9rem;">No upcoming classes this week</div>';
                } else {
                    scheduleEl.innerHTML = thisWeekSchedule.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: ${item.day === todayName ? '#dbeafe' : '#f9fafb'}; border-radius: 0.5rem;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">${item.course}</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray); margin-top: 0.15rem;">üìç ${item.room}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 0.875rem; color: var(--primary);">${item.day}</div>
                                <div style="font-size: 0.75rem; color: var(--text-gray);">‚è∞ ${item.time}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Role-based gating: hide academic edit controls for non-admins
            const isAdmin = !!(currentUser && currentUser.isAdmin);
            // Attendance controls
            const reportAbsenceBtn = document.querySelector('button[onclick*="toggleAbsenceForm"]');
            const uploadJustificationBtn = document.querySelector('button[onclick*="uploadJustification"]');
            const absenceFormEl = document.getElementById('absenceForm');
            if (!isAdmin) {
                if (reportAbsenceBtn) reportAbsenceBtn.style.display = 'none';
                if (uploadJustificationBtn) uploadJustificationBtn.style.display = 'none';
                if (absenceFormEl) absenceFormEl.classList.add('hidden');
            } else {
                if (reportAbsenceBtn) reportAbsenceBtn.style.display = '';
                if (uploadJustificationBtn) uploadJustificationBtn.style.display = '';
                // keep form hidden by default until toggled
            }

            // Advising action item controls
            const actionItemFormEl = document.getElementById('actionItemForm');
            const addActionItemBtn = document.querySelector('button[onclick*="toggleActionItemForm"]');
            if (!isAdmin) {
                if (addActionItemBtn) addActionItemBtn.style.display = 'none';
                if (actionItemFormEl) actionItemFormEl.classList.add('hidden');
            } else {
                if (addActionItemBtn) addActionItemBtn.style.display = '';
            }

            // Assessments controls (admin-only)
            const addExamBtn = document.querySelector('button[onclick*="toggleExamForm"]');
            const addQuizBtn = document.querySelector('button[onclick*="toggleQuizForm"]');
            const addAssignmentBtn = document.querySelector('button[onclick*="toggleAssignmentForm"]');
            const examFormEl = document.getElementById('examForm');
            const quizFormEl = document.getElementById('quizForm');
            const assignmentFormEl = document.getElementById('assignmentForm');
            if (!isAdmin) {
                if (addExamBtn) addExamBtn.style.display = 'none';
                if (addQuizBtn) addQuizBtn.style.display = 'none';
                if (addAssignmentBtn) addAssignmentBtn.style.display = 'none';
                if (examFormEl) examFormEl.classList.add('hidden');
                if (quizFormEl) quizFormEl.classList.add('hidden');
                if (assignmentFormEl) assignmentFormEl.classList.add('hidden');
            } else {
                if (addExamBtn) addExamBtn.style.display = '';
                if (addQuizBtn) addQuizBtn.style.display = '';
                if (addAssignmentBtn) addAssignmentBtn.style.display = '';
            }

            // Populate course dropdowns in add forms
            const courseSelectIds = ['examCourse', 'quizCourse', 'assignmentCourse', 'resourceCourse'];
            courseSelectIds.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Select Course</option>' + 
                        courses.map(c => `<option value="${c.code}">${c.code} - ${c.name}</option>`).join('');
                }
            });

            // Render resources and submissions (safely)
            try {
                if (document.getElementById('resourcesList')) {
                    renderResources();
                }
            } catch (err) {
                console.error('Error in renderResources:', err);
            }
            
            try {
                if (document.getElementById('submissionsContainer')) {
                    renderSubmissions();
                }
            } catch (err) {
                console.error('Error in renderSubmissions:', err);
            }
        }

        function percent(completed, total) {
            if (!total) return 0;
            return Math.round((completed / total) * 100);
        }

        function renderClinical() {
            const container = document.getElementById('clinicalContent');
            if (!container) return;
            if (!clinicalState || !currentUser) {
                container.innerHTML = '<div class="card" style="color: var(--text-gray);">Sign in to see clinical data.</div>';
                return;
            }

            const { ippes, hours, activities, attendance, ui } = clinicalState;
            const rotationPct = percent(hours.rotation, hours.rotationTotal);
            const yearBadge = currentUser ? `<div style="margin-bottom:0.5rem;"><span class="chip chip-info">${currentUser.yearLabel}</span></div>` : '';
            
            // Calculate insights
            const weekProgress = (hours.week / 40) * 100;
            const isOnTrack = weekProgress >= 70;
            const pendingActivities = activities.filter(a => !a.done).length;
            const currentIppe = ippes.find(i => i.hours.completed < i.hours.total) || ippes[0];
            
            // Quick actions
            const quickActions = `
                <div class="card" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; padding: 1rem;">
                    <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.95;">‚ö° QUICK ACTIONS</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                        <button type="button" onclick="document.getElementById('logHoursForm').scrollIntoView({behavior:'smooth'})" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem; font-size: 0.85rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.3);">‚è±Ô∏è Log Hours</button>
                        <button type="button" onclick="document.getElementById('activityForm').scrollIntoView({behavior:'smooth'})" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem; font-size: 0.85rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.3);">üìã Add Task</button>
                        <button type="button" onclick="document.getElementById('attendanceForm').scrollIntoView({behavior:'smooth'})" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem; font-size: 0.85rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.3);">‚úì Attendance</button>
                        <button type="button" id="exportCsvBtn2" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem; font-size: 0.85rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.3);">üìä Export CSV</button>
                    </div>
                </div>
            `;
            
            // Current rotation info
            const rotationInfo = currentIppe ? `
                <div class="card" style="border-left: 4px solid ${currentIppe.color}; background: linear-gradient(135deg, #fefce8, #fef9c3);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: #854d0e; font-weight: 600; margin-bottom: 0.25rem;">CURRENT ROTATION</div>
                            <div style="font-size: 1.1rem; font-weight: 800; color: #422006;">${currentIppe.title}</div>
                            <div style="font-size: 0.9rem; color: #713f12; margin-top: 0.25rem;">üìç ${currentIppe.site}</div>
                        </div>
                        <span class="chip" style="background: ${currentIppe.color}; color: white; font-weight: 700;">${currentIppe.grade}</span>
                    </div>
                    <div class="progress-shell" style="height: 8px; margin-bottom: 0.5rem;">
                        <div class="progress-bar" style="width: ${percent(currentIppe.hours.completed, currentIppe.hours.total)}%; background: ${currentIppe.color};"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #78350f;">
                        <span style="font-weight: 700;">${currentIppe.hours.completed} / ${currentIppe.hours.total} hours</span>
                        <span>${percent(currentIppe.hours.completed, currentIppe.hours.total)}% complete</span>
                    </div>
                </div>
            ` : '';

            const ippeCards = ui?.ippesCollapsed ? '<div style="color: var(--text-gray); padding: 1rem; text-align: center;">IPPE cards collapsed. Click "Expand" to view.</div>' : ippes.map(ippe => {
                const isActive = ippe === currentIppe;
                return `
                <div class="card" style="border-left: 4px solid ${ippe.color}; ${isActive ? 'background: #f0fdf4;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div class="section-title" style="color:${ippe.color}; margin-bottom: 0.5rem;">${ippe.title}</div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-dark);">${ippe.site}</div>
                        </div>
                        ${isActive ? '<span class="chip chip-success" style="font-size: 0.7rem;">ACTIVE</span>' : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <span class="chip chip-info">${ippe.hours.completed}/${ippe.hours.total} hrs</span>
                        <span class="chip" style="background: ${ippe.color}; color: white;">Grade: ${ippe.grade}</span>
                    </div>
                    <div class="progress-shell"><div class="progress-bar" style="width: ${percent(ippe.hours.completed, ippe.hours.total)}%; background: ${ippe.color};"></div></div>
                </div>
            `}).join('');

            const activityItems = activities.map((act, idx) => `
                <div class="card" style="margin-bottom: 0; padding: 0.9rem; border-left: 4px solid ${act.done ? '#22c55e' : '#f59e0b'}; ${act.done ? 'background: #f0fdf4;' : ''}">
                    <div style="display:flex; align-items:center; gap:0.5rem; justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:0.75rem; flex:1;">
                            <input type="checkbox" data-activity-toggle="${idx}" ${act.done ? 'checked' : ''} aria-label="${act.title} status" style="width: 20px; height: 20px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: var(--text-dark); ${act.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${act.title}</div>
                                <div style="color: var(--text-gray); font-size: 0.85rem; margin-top: 0.15rem;">${act.detail}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:0.35rem;">
                            <button type="button" data-activity-edit="${idx}" style="border:none; background:none; color:#1d4ed8; font-size: 1.2rem; cursor: pointer; padding: 0.25rem;" title="Edit">‚úé</button>
                            <button type="button" data-activity-delete="${idx}" style="border:none; background:none; color:#ef4444; font-size: 1.2rem; cursor: pointer; padding: 0.25rem;" title="Delete">‚úï</button>
                        </div>
                    </div>
                </div>
            `).join('');

            const activeLogs = attendance.logs.filter(l => !l.archived);
            const archivedLogs = attendance.logs.filter(l => l.archived);

            const attendanceItems = activeLogs.map((log) => {
                const idx = attendance.logs.indexOf(log);
                return `
                <div style="display:flex; justify-content: space-between; gap:0.5rem; padding: 0.75rem; background: #f8fafc; border-radius: 0.6rem; align-items: center;">
                    <div style="min-width: 90px; color: var(--text-dark); font-weight: 700;">${log.date}</div>
                    <div style="color: var(--text-gray); flex: 1;">${log.note}</div>
                    <span class="chip ${log.status === 'Excellent' ? 'chip-success' : log.status === 'Good' ? 'chip-info' : 'chip-warning'}">${log.status}</span>
                    <div style="display:flex; gap:0.35rem;">
                        <button type="button" data-attendance-edit="${idx}" style="border:none; background:none; color:#1d4ed8; font-weight:700;">‚úé</button>
                        <button type="button" data-attendance-delete="${idx}" style="border:none; background:none; color:#ef4444; font-weight:700;">‚úï</button>
                    </div>
                </div>
                `;
            }).join('');

            const archivedItems = archivedLogs.map((log) => {
                const idx = attendance.logs.indexOf(log);
                return `
                <div style="display:flex; justify-content: space-between; gap:0.5rem; padding: 0.75rem; background: #fff7ed; border-radius: 0.6rem; align-items: center;">
                    <div style="min-width: 90px; color: #9a3412; font-weight: 700;">${log.date}</div>
                    <div style="color: #b45309; flex: 1;">${log.note}</div>
                    <span class="chip chip-warning">Archived</span>
                    <button type="button" data-attendance-restore="${idx}" style="border:none; background:none; color:#0f766e; font-weight:700;">‚Ü∫ Restore</button>
                </div>
                `;
            }).join('');

            container.innerHTML = `
                ${yearBadge}
                ${quickActions}
                
                ${rotationInfo}
                
                <!-- Insights Card -->
                <div class="card" style="background: ${isOnTrack ? 'linear-gradient(135deg, #ecfdf5, #d1fae5)' : 'linear-gradient(135deg, #fef3c7, #fde68a)'}; border-left: 4px solid ${isOnTrack ? '#10b981' : '#f59e0b'};">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="font-size: 2rem;">${isOnTrack ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                        <div>
                            <div style="font-weight: 800; color: ${isOnTrack ? '#065f46' : '#78350f'}; font-size: 1rem;">${isOnTrack ? 'On Track!' : 'Catch Up Needed'}</div>
                            <div style="font-size: 0.85rem; color: ${isOnTrack ? '#047857' : '#92400e'}; margin-top: 0.15rem;">
                                ${isOnTrack ? 'Great progress this week' : `${(40 - hours.week).toFixed(1)} hours needed to meet weekly goal`}
                            </div>
                        </div>
                    </div>
                    ${pendingActivities > 0 ? `<div style="background: rgba(255,255,255,0.7); padding: 0.75rem; border-radius: 0.5rem; font-size: 0.85rem; color: #92400e;">üìã ${pendingActivities} pending task${pendingActivities > 1 ? 's' : ''} to complete</div>` : ''}
                </div>

                <div class="card" style="background: linear-gradient(135deg, #111827, #1e293b); color: white;">
                    <div style="display:flex; justify-content: space-between; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                        <div class="section-title" style="color: white; margin-bottom: 0;">‚è±Ô∏è Hours Tracker</div>
                        <div style="display:flex; gap:0.4rem;">
                            <button type="button" id="exportCsvBtn" class="btn" style="width:auto; padding:0.5rem 0.75rem; font-size: 0.8rem; background: rgba(255,255,255,0.12); color:white; border:1px solid rgba(255,255,255,0.25);">üìä CSV</button>
                            <button type="button" id="exportClinicalBtn" class="btn" style="width:auto; padding:0.5rem 0.75rem; font-size: 0.8rem; background: rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2);">üíæ Export</button>
                            <button type="button" id="importClinicalBtn" class="btn" style="width:auto; padding:0.5rem 0.75rem; font-size: 0.8rem; background: rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2);">üì• Import</button>
                        </div>
                    </div>
                    
                    <div class="grid-3" style="gap: 0.75rem;">
                        <div style="text-align:center; padding: 1rem 0.75rem; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1)); border-radius: 0.75rem; border: 1px solid rgba(59,130,246,0.3);">
                            <div style="font-size: 0.75rem; opacity: 0.85; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Today</div>
                            <div style="font-size: 2rem; font-weight: 900; margin: 0.25rem 0;">${hours.today.toFixed(1)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.75;">hours</div>
                        </div>
                        <div style="text-align:center; padding: 1rem 0.75rem; background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.1)); border-radius: 0.75rem; border: 1px solid rgba(16,185,129,0.3);">
                            <div style="font-size: 0.75rem; opacity: 0.85; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">This Week</div>
                            <div style="font-size: 2rem; font-weight: 900; margin: 0.25rem 0;">${hours.week.toFixed(1)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.75;">${weekProgress.toFixed(0)}% of 40</div>
                        </div>
                        <div style="text-align:center; padding: 1rem 0.75rem; background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.1)); border-radius: 0.75rem; border: 1px solid rgba(245,158,11,0.3);">
                            <div style="font-size: 0.75rem; opacity: 0.85; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Rotation</div>
                            <div style="font-size: 2rem; font-weight: 900; margin: 0.25rem 0;">${hours.rotation}</div>
                            <div style="font-size: 0.75rem; opacity: 0.75;">${rotationPct}% of ${hours.rotationTotal}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.25rem; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                            <div style="font-weight: 700; font-size: 0.9rem;">Weekly Goal Progress</div>
                            <div style="font-weight: 800; font-size: 0.9rem;">${weekProgress.toFixed(0)}%</div>
                        </div>
                        <div class="progress-shell" style="height: 12px; background: rgba(255,255,255,0.1);">
                            <div class="progress-bar" style="width: ${Math.min(100, weekProgress)}%; background: ${isOnTrack ? '#10b981' : '#f59e0b'};"></div>
                        </div>
                        <div style="display:flex; justify-content: space-between; color: rgba(255,255,255,0.7); font-size: 0.75rem; margin-top: 0.5rem;">
                            <span>Mon-Fri Target</span>
                            <span>${hours.week.toFixed(1)} / 40 hrs</span>
                        </div>
                    </div>
                    
                    <form id="logHoursForm" style="margin-top: 1.25rem; background: rgba(255,255,255,0.08); padding: 1rem; border-radius: 0.75rem;">
                        <label class="form-label" style="color: white; font-weight: 600; margin-bottom: 0.5rem;">‚ûï Log Today's Hours</label>
                        <div style="display:flex; gap: 0.5rem;">
                            <input type="number" step="0.5" min="0.5" max="24" aria-label="Hours to add" placeholder="e.g., 2.5" style="flex:1; border: none; padding: 0.875rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 600;" required>
                            <button type="submit" class="btn btn-primary" style="width:auto; padding: 0.875rem 1.5rem; font-weight: 700; font-size: 1rem;">Add Hours</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content: space-between; align-items:center; gap:0.5rem; margin-bottom: 1rem;">
                        <div>
                            <div class="section-title" style="margin-bottom:0.25rem;">üìã Tasks & Activities</div>
                            <div style="font-size: 0.8rem; color: var(--text-gray);">${activities.length} total ‚Ä¢ ${pendingActivities} pending</div>
                        </div>
                    </div>
                    ${activities.length > 0 ? `<div style="display:flex; flex-direction:column; gap:0.6rem; margin-bottom: 1rem;">${activityItems}</div>` : '<div style="color: var(--text-gray); text-align: center; padding: 2rem 1rem; background: #f9fafb; border-radius: 0.75rem; margin-bottom: 1rem;">üìù No tasks yet. Add your first activity below!</div>'}
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.75rem; border: 2px dashed #86efac;">
                        <form id="activityForm">
                            <div style="font-weight: 700; font-size: 0.9rem; color: var(--primary); margin-bottom: 0.75rem;">‚ûï ${editActivityIndex !== null ? 'Update' : 'Add New'} Activity</div>
                            <input type="text" id="activityTitle" placeholder="Activity title (e.g., Patient Counseling)" required style="margin-bottom: 0.5rem;">
                            <input type="text" id="activityDetail" placeholder="Details (e.g., 2.0 hours - counsel 5 patients on medications)" required>
                            <button type="submit" class="btn btn-primary" style="margin-top: 0.75rem; width: 100%;">${editActivityIndex !== null ? '‚úì Update Activity' : '‚ûï Add Activity'}</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content: space-between; align-items:center; gap:0.5rem; margin-bottom: 1rem;">
                        <div>
                            <div class="section-title" style="margin-bottom:0.25rem;">üè• IPPE Rotations</div>
                            <div style="font-size: 0.8rem; color: var(--text-gray);">${ippes.length} rotation${ippes.length > 1 ? 's' : ''} total</div>
                        </div>
                        <button type="button" id="toggleIppesBtn" class="btn" style="width:auto; padding:0.5rem 0.9rem; background: #f3f4f6; color: var(--text-dark); border:1px solid #e5e7eb; font-weight: 600; font-size: 0.85rem;">${ui?.ippesCollapsed ? 'üëÅÔ∏è Show' : 'üëÅÔ∏è‚Äçüó®Ô∏è Hide'}</button>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.75rem;">
                        ${ippeCards}
                    </div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.04)); border-left: 4px solid var(--danger);">
                    <div style="display:flex; justify-content: space-between; align-items: center; gap:0.5rem;">
                        <div class="section-title" style="color: var(--danger); margin-bottom:0;">üìÖ Attendance & Professionalism</div>
                        <button type="button" id="toggleAttendanceBtn" class="btn" style="width:auto; padding:0.5rem 0.75rem; background: white; color: var(--danger); border: 1px solid #fecdd3;">Toggle Logs</button>
                    </div>
                    <div class="grid-2" style="margin-bottom: 1rem;">
                        <div style="text-align:center; padding: 0.75rem; background: white; border-radius: 0.75rem;">
                            <div style="font-size: 0.9rem; color: var(--text-gray);">Days Present</div>
                            <div style="font-size: 1.6rem; font-weight: 800; color: var(--primary);">${attendance.present}/${attendance.total}</div>
                            <div style="font-size: 0.8rem; color: var(--text-gray);">${percent(attendance.present, attendance.total)}% attendance</div>
                        </div>
                        <div style="text-align:center; padding: 0.75rem; background: white; border-radius: 0.75rem;">
                            <div style="font-size: 0.9rem; color: var(--text-gray);">Professionalism</div>
                            <div style="font-size: 1.6rem; font-weight: 800; color: #22c55e;">${attendance.professionalism.toFixed(1)}/5</div>
                            <div style="font-size: 0.8rem; color: var(--text-gray);">Excellent</div>
                        </div>
                    </div>
                    <form id="attendanceForm" style="background: white; padding: 0.75rem; border-radius: 0.75rem; display:flex; flex-direction: column; gap:0.5rem; margin-bottom: 0.75rem;">
                        <div class="form-group" style="margin-bottom: 0.25rem;">
                            <label class="form-label" style="margin-bottom: 0.25rem;">Date</label>
                            <input type="date" id="attendanceDate" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.25rem;">
                            <label class="form-label" style="margin-bottom: 0.25rem;">Note</label>
                            <input type="text" id="attendanceNote" placeholder="e.g., Arrived on time" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.25rem;">
                            <label class="form-label" style="margin-bottom: 0.25rem;">Status</label>
                            <select id="attendanceStatus" required>
                                <option>Excellent</option>
                                <option>Good</option>
                                <option>Acceptable</option>
                                <option>Needs Improvement</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%;">${editAttendanceIndex !== null ? 'Update Attendance' : 'Add Attendance'}</button>
                    </form>
                    <div id="attendanceLogs" style="display:flex; flex-direction:column; gap:0.6rem;">${attendanceItems || '<div style="color: var(--text-gray);">No attendance entries.</div>'}</div>
                    ${archivedItems ? `<div id="attendanceArchived" style="display:flex; flex-direction:column; gap:0.35rem; margin-top:0.75rem;"><div style="font-weight:700; color:#b45309;">Archived</div><div style="display:flex; flex-direction:column; gap:0.6rem;">${archivedItems}</div></div>` : ''}
                </div>
            `;

            attachClinicalHandlers();
        }

        function attachClinicalHandlers() {
            const logForm = document.getElementById('logHoursForm');
            if (logForm && !logForm.dataset.bound) {
                logForm.addEventListener('submit', handleLogHours);
                logForm.dataset.bound = 'true';
            }

            const activityForm = document.getElementById('activityForm');
            if (activityForm && !activityForm.dataset.bound) {
                activityForm.addEventListener('submit', handleAddActivity);
                activityForm.dataset.bound = 'true';
            }

            document.querySelectorAll('[data-activity-toggle]').forEach(el => {
                if (!el.dataset.bound) {
                    el.addEventListener('change', handleToggleActivity);
                    el.dataset.bound = 'true';
                }
            });

            document.querySelectorAll('[data-activity-delete]').forEach(el => {
                if (!el.dataset.bound) {
                    el.addEventListener('click', handleDeleteActivity);
                    el.dataset.bound = 'true';
                }
            });

            const exportBtn = document.getElementById('exportClinicalBtn');
            if (exportBtn && !exportBtn.dataset.bound) {
                exportBtn.addEventListener('click', exportClinical);
                exportBtn.dataset.bound = 'true';
            }

            const exportCsvBtn2 = document.getElementById('exportCsvBtn2');
            if (exportCsvBtn2 && !exportCsvBtn2.dataset.bound) {
                exportCsvBtn2.addEventListener('click', exportCsv);
                exportCsvBtn2.dataset.bound = 'true';
            }

            const importBtn = document.getElementById('importClinicalBtn');
            if (importBtn && !importBtn.dataset.bound) {
                importBtn.addEventListener('click', () => document.getElementById('importClinicalInput')?.click());
                importBtn.dataset.bound = 'true';
            }

            const importInput = document.getElementById('importClinicalInput');
            if (importInput && !importInput.dataset.bound) {
                importInput.addEventListener('change', handleImportClinical);
                importInput.dataset.bound = 'true';
            }

            const toggleAttendanceBtn = document.getElementById('toggleAttendanceBtn');
            if (toggleAttendanceBtn && !toggleAttendanceBtn.dataset.bound) {
                toggleAttendanceBtn.addEventListener('click', toggleAttendanceSection);
                toggleAttendanceBtn.dataset.bound = 'true';
            }

            const attendanceForm = document.getElementById('attendanceForm');
            if (attendanceForm && !attendanceForm.dataset.bound) {
                attendanceForm.addEventListener('submit', handleAddAttendance);
                attendanceForm.dataset.bound = 'true';
            }

            const toggleIppesBtn = document.getElementById('toggleIppesBtn');
            if (toggleIppesBtn && !toggleIppesBtn.dataset.bound) {
                toggleIppesBtn.addEventListener('click', toggleIppes);
                toggleIppesBtn.dataset.bound = 'true';
            }

            const exportCsvBtn = document.getElementById('exportCsvBtn');
            if (exportCsvBtn && !exportCsvBtn.dataset.bound) {
                exportCsvBtn.addEventListener('click', exportClinicalCsv);
                exportCsvBtn.dataset.bound = 'true';
            }

            document.querySelectorAll('[data-activity-edit]').forEach(el => {
                if (!el.dataset.bound) {
                    el.addEventListener('click', handleEditActivity);
                    el.dataset.bound = 'true';
                }
            });

            document.querySelectorAll('[data-attendance-edit]').forEach(el => {
                if (!el.dataset.bound) {
                    el.addEventListener('click', handleEditAttendance);
                    el.dataset.bound = 'true';
                }
            });

            document.querySelectorAll('[data-attendance-delete]').forEach(el => {
                if (!el.dataset.bound) {
                    el.addEventListener('click', handleDeleteAttendance);
                    el.dataset.bound = 'true';
                }
            });

            document.querySelectorAll('[data-attendance-restore]').forEach(el => {
                if (!el.dataset.bound) {
                    el.addEventListener('click', handleRestoreAttendance);
                    el.dataset.bound = 'true';
                }
            });
        }

        function handleLogHours(e) {
            e.preventDefault();
            const input = e.target.querySelector('input[type="number"]');
            if (!input) return;
            const val = parseFloat(input.value);
            if (Number.isNaN(val) || val <= 0) {
                showToast('Enter a valid hour value');
                return;
            }
            clinicalState.hours.today += val;
            clinicalState.hours.week += val;
            clinicalState.hours.rotation = Math.min(clinicalState.hours.rotation + val, clinicalState.hours.rotationTotal);
            clinicalState.hours.daily[clinicalState.hours.daily.length - 1] += val;
            saveState();
            renderClinical();
            showToast('Hours logged');
        }

        function handleAddActivity(e) {
            e.preventDefault();
            const titleEl = document.getElementById('activityTitle');
            const detailEl = document.getElementById('activityDetail');
            const title = titleEl?.value?.trim();
            const detail = detailEl?.value?.trim();
            if (!title || !detail) {
                showToast('Please enter activity details');
                return;
            }

            if (editActivityIndex !== null) {
                const existing = clinicalState.activities[editActivityIndex];
                if (existing) {
                    clinicalState.activities[editActivityIndex] = { ...existing, title, detail };
                    showToast('Activity updated');
                }
                editActivityIndex = null;
            } else {
                clinicalState.activities.unshift({ title, detail, done: false });
                showToast('Activity added');
            }

            if (titleEl) titleEl.value = '';
            if (detailEl) detailEl.value = '';

            saveState();
            renderClinical();
        }

        function handleEditActivity(e) {
            const idx = parseInt(e.target.dataset.activityEdit, 10);
            if (Number.isNaN(idx)) return;
            const current = clinicalState.activities[idx];
            const titleEl = document.getElementById('activityTitle');
            const detailEl = document.getElementById('activityDetail');
            if (titleEl) titleEl.value = current.title;
            if (detailEl) detailEl.value = current.detail;
            editActivityIndex = idx;
            showToast('Editing activity...');
        }

        function handleToggleActivity(e) {
            const idx = parseInt(e.target.dataset.activityToggle, 10);
            if (Number.isNaN(idx)) return;
            clinicalState.activities[idx].done = !!e.target.checked;
            saveState();
            renderClinical();
        }

        function handleDeleteActivity(e) {
            const idx = parseInt(e.target.dataset.activityDelete, 10);
            if (Number.isNaN(idx)) return;
            if (!confirm('Delete this activity?')) return;
            clinicalState.activities.splice(idx, 1);
            saveState();
            renderClinical();
            showToast('Activity removed');
        }

        function handleEditAttendance(e) {
            const idx = parseInt(e.target.dataset.attendanceEdit, 10);
            if (Number.isNaN(idx)) return;
            const log = clinicalState.attendance.logs[idx];
            if (!log || log.archived) return;
            const dateEl = document.getElementById('attendanceDate');
            const noteEl = document.getElementById('attendanceNote');
            const statusEl = document.getElementById('attendanceStatus');
            const submitBtn = document.querySelector('#attendanceForm button[type="submit"]');
            if (dateEl) dateEl.value = log.date;
            if (noteEl) noteEl.value = log.note;
            if (statusEl) statusEl.value = log.status;
            if (submitBtn) submitBtn.textContent = 'Update Attendance';
            editAttendanceIndex = idx;
            showToast('Editing attendance...');
        }

        function handleDeleteAttendance(e) {
            const idx = parseInt(e.target.dataset.attendanceDelete, 10);
            if (Number.isNaN(idx)) return;
            const log = clinicalState.attendance.logs[idx];
            if (!log) return;
            if (!confirm('Archive this attendance entry?')) return;
            clinicalState.attendance.logs[idx] = { ...log, archived: true };
            saveState();
            renderClinical();
            showToast('Attendance archived');
        }

        function handleRestoreAttendance(e) {
            const idx = parseInt(e.target.dataset.attendanceRestore, 10);
            if (Number.isNaN(idx)) return;
            const log = clinicalState.attendance.logs[idx];
            if (!log) return;
            clinicalState.attendance.logs[idx] = { ...log, archived: false };
            saveState();
            renderClinical();
            showToast('Attendance restored');
        }

        function handleAddAttendance(e) {
            e.preventDefault();
            const dateEl = document.getElementById('attendanceDate');
            const noteEl = document.getElementById('attendanceNote');
            const statusEl = document.getElementById('attendanceStatus');
            const date = dateEl?.value?.trim();
            const note = noteEl?.value?.trim();
            const status = statusEl?.value?.trim();
            if (!date || !note || !status) {
                showToast('Please complete attendance fields');
                return;
            }

            if (editAttendanceIndex !== null) {
                const log = clinicalState.attendance.logs[editAttendanceIndex];
                if (log) {
                    clinicalState.attendance.logs[editAttendanceIndex] = { ...log, date, note, status, archived: false };
                    showToast('Attendance updated');
                }
                editAttendanceIndex = null;
            } else {
                clinicalState.attendance.logs.unshift({ date, note, status, archived: false });
                showToast('Attendance added');
            }

            if (dateEl) dateEl.value = '';
            if (noteEl) noteEl.value = '';
            if (statusEl) statusEl.value = 'Excellent';

            saveState();
            renderClinical();
        }

        function exportClinical() {
            try {
                const blob = new Blob([JSON.stringify(clinicalState, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'clinical-data.json';
                a.click();
                URL.revokeObjectURL(url);
                showToast('Data exported');
            } catch (err) {
                showToast('Export failed');
            }
        }

        function handleImportClinical(e) {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const parsed = JSON.parse(reader.result);
                    clinicalState = parsed;
                    saveState();
                    renderClinical();
                    showToast('Data imported');
                } catch (err) {
                    showToast('Invalid file');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function toggleAttendanceSection() {
            const logs = document.getElementById('attendanceLogs');
            const archived = document.getElementById('attendanceArchived');
            if (!logs) return;
            const isHidden = logs.style.display === 'none';
            logs.style.display = isHidden ? 'flex' : 'none';
            if (archived) archived.style.display = isHidden ? 'flex' : 'none';
        }

        function toggleIppes() {
            if (!clinicalState.ui) clinicalState.ui = { ippesCollapsed: false };
            clinicalState.ui.ippesCollapsed = !clinicalState.ui.ippesCollapsed;
            saveState();
            renderClinical();
        }

        function exportClinicalCsv() {
            try {
                const rows = [];
                rows.push(['Section','Field','Value']);
                rows.push(['Hours','Today', clinicalState.hours.today]);
                rows.push(['Hours','Week', clinicalState.hours.week]);
                rows.push(['Hours','Rotation', `${clinicalState.hours.rotation}/${clinicalState.hours.rotationTotal}`]);
                clinicalState.activities.forEach((a,i) => rows.push(['Activity', `#${i+1} ${a.title}`, a.detail]));
                clinicalState.attendance.logs.forEach((l,i) => rows.push(['Attendance', l.date, `${l.status} - ${l.note}`]));

                const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'clinical-data.csv';
                a.click();
                URL.revokeObjectURL(url);
                showToast('CSV exported');
            } catch (err) {
                showToast('CSV export failed');
            }
        }

        // Safe guard legacy preference handlers if elements exist
        const submitPrefsBtn = document.getElementById('submitPrefs');
        if (submitPrefsBtn) {
            submitPrefsBtn.addEventListener('click', function() {
                showToast('Preferences saved');
            });
        }

        function showPreferencesForm() {
            const form = document.getElementById('preferencesForm');
            const success = document.getElementById('preferencesSuccess');
            if (form && success) {
                form.classList.remove('hidden');
                success.classList.add('hidden');
            }
        }

        function uploadJustification() {
            // Admin-only action
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Admin-only action');
                return;
            }
            showToast('File upload would open here. Feature demo only.');
        }

        // Academic manipulation functions (top-level, with admin gating)
        function toggleExamForm() {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            const form = document.getElementById('examForm');
            if (form) {
                form.classList.toggle('hidden');
                if (!form.classList.contains('hidden')) populateCourseDropdowns();
            }
        }

        function toggleQuizForm() {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            const form = document.getElementById('quizForm');
            if (form) {
                form.classList.toggle('hidden');
                if (!form.classList.contains('hidden')) populateCourseDropdowns();
            }
        }

        function toggleAssignmentForm() {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            const form = document.getElementById('assignmentForm');
            if (form) {
                form.classList.toggle('hidden');
                if (!form.classList.contains('hidden')) populateCourseDropdowns();
            }
        }

        function toggleAbsenceForm() {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            const form = document.getElementById('absenceForm');
            if (form) {
                form.classList.toggle('hidden');
                if (!form.classList.contains('hidden')) populateCourseDropdowns();
            }
        }

        function toggleActionItemForm() {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            const form = document.getElementById('actionItemForm');
            if (form) form.classList.toggle('hidden');
        }

        function populateCourseDropdowns() {
            if (!clinicalState || !clinicalState.academic) return;
            const courses = clinicalState.academic.courses || [];
            const courseCodes = courses.map(c => c.code);
            ['examCourse', 'quizCourse', 'assignmentCourse', 'absenceCourse'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Course</option>' + courseCodes.map(code => `<option value="${code}">${code}</option>`).join('');
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        function handleAddExam(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic) return;
            const course = document.getElementById('examCourse').value;
            const title = document.getElementById('examTitle').value.trim();
            const date = document.getElementById('examDate').value;
            const type = document.getElementById('examType').value;
            if (!course || !title || !date || !type) { showToast('Please fill all exam fields'); return; }
            if (!clinicalState.academic.exams) clinicalState.academic.exams = [];
            clinicalState.academic.exams.push({ course, title, date, type, status: 'Upcoming' });
            saveState();
            renderAcademic();
            document.getElementById('addExamForm').reset();
            toggleExamForm();
            showToast('Exam added');
        }

        function handleAddQuiz(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic) return;
            const course = document.getElementById('quizCourse').value;
            const title = document.getElementById('quizTitle').value.trim();
            const date = document.getElementById('quizDate').value;
            const score = parseInt(document.getElementById('quizScore').value);
            const total = parseInt(document.getElementById('quizTotal').value);
            const feedback = document.getElementById('quizFeedback').value.trim() || 'No feedback provided';
            if (!course || !title || !date || isNaN(score) || isNaN(total)) { showToast('Please fill all quiz fields'); return; }
            if (!clinicalState.academic.quizzes) clinicalState.academic.quizzes = [];
            clinicalState.academic.quizzes.unshift({ course, title, date, score, total, feedback });
            saveState();
            renderAcademic();
            document.getElementById('addQuizForm').reset();
            toggleQuizForm();
            showToast('Quiz/OSCE added');
        }

        function handleAddAssignment(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic) return;
            const course = document.getElementById('assignmentCourse').value;
            const title = document.getElementById('assignmentTitle').value.trim();
            const due = document.getElementById('assignmentDue').value;
            if (!course || !title || !due) { showToast('Please fill all assignment fields'); return; }
            if (!clinicalState.academic.assignments) clinicalState.academic.assignments = [];
            clinicalState.academic.assignments.push({ course, title, due, status: 'pending' });
            saveState();
            renderAcademic();
            document.getElementById('addAssignmentForm').reset();
            toggleAssignmentForm();
            showToast('Assignment added');
        }

        function handleAddAbsence(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic || !clinicalState.academic.attendance) return;
            const date = document.getElementById('absenceDate').value;
            const type = document.getElementById('absenceType').value;
            const course = document.getElementById('absenceCourse').value;
            const reason = document.getElementById('absenceReason').value.trim();
            const justified = document.getElementById('absenceJustified').checked;
            if (!date || !type || !course || !reason) { showToast('Please fill all absence fields'); return; }
            if (!clinicalState.academic.attendance.absences) { clinicalState.academic.attendance.absences = []; }
            clinicalState.academic.attendance.absences.unshift({ date, type, course, reason, justified });
            if (type === 'Lecture') {
                clinicalState.academic.attendance.lectures.total += 1;
                clinicalState.academic.attendance.lectures.percentage = Math.round((clinicalState.academic.attendance.lectures.attended / clinicalState.academic.attendance.lectures.total) * 100);
            } else if (type === 'Lab') {
                clinicalState.academic.attendance.labs.total += 1;
                clinicalState.academic.attendance.labs.percentage = Math.round((clinicalState.academic.attendance.labs.attended / clinicalState.academic.attendance.labs.total) * 100);
            }
            saveState();
            renderAcademic();
            document.getElementById('addAbsenceForm').reset();
            toggleAbsenceForm();
            showToast('Absence reported');
        }

        function handleAddActionItem(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic || !clinicalState.academic.advisor) return;
            const task = document.getElementById('actionItemTask').value.trim();
            if (!task) { showToast('Please enter action item'); return; }
            if (!clinicalState.academic.advisor.actionItems) { clinicalState.academic.advisor.actionItems = []; }
            clinicalState.academic.advisor.actionItems.push({ task, status: 'pending' });
            saveState();
            renderAcademic();
            document.getElementById('addActionItemForm').reset();
            toggleActionItemForm();
            showToast('Action item added');
        }

        function toggleActionItem(index) {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic || !clinicalState.academic.advisor) return;
            const item = clinicalState.academic.advisor.actionItems[index];
            if (item) {
                item.status = item.status === 'completed' ? 'pending' : 'completed';
                saveState();
                renderAcademic();
            }
        }

        function deleteAssignment(index) {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic) return;
            if (!confirm('Delete this assignment?')) return;
            clinicalState.academic.assignments.splice(index, 1);
            saveState();
            renderAcademic();
            showToast('Assignment deleted');
        }

        function markAssignmentSubmitted(index) {
            if (!currentUser || !currentUser.isAdmin) { showToast('Admin-only action'); return; }
            if (!clinicalState || !clinicalState.academic) return;
            const assignment = clinicalState.academic.assignments[index];
            if (assignment) {
                assignment.status = assignment.status === 'pending' ? 'submitted' : 'pending';
                saveState();
                renderAcademic();
                showToast(assignment.status === 'submitted' ? 'Marked as submitted' : 'Marked as pending');
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            clinicalState = null;
            editActivityIndex = null;
            editAttendanceIndex = null;
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById('homePage').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(btn => {
                const isHome = btn.dataset.target === 'home';
                btn.classList.toggle('active', isHome);
                btn.setAttribute('aria-pressed', isHome);
            });
        }

        // Initial render (clinical page uses stored state once opened)
        try {
            renderClinical();
        } catch (err) {
            console.error('Error in initial render:', err);
        }
    </script>
</body>
</html>
